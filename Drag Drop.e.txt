 ' 文件类型：Windows模块源码

 ' 程序名称：控件文件拖放类模块
 ' 程序描述：by zhaoleimxd
 ' 程序作者：zhaoleimxd
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0



.常量 GWL_WNDPROC, "-4", , 获取、设置窗口过程的地址
.常量 GWL_EXSTYLE, "-20", , 获取、设置窗口扩展样式
.常量 , , , 
.常量 WS_EX_ACCEPTFILES, "16", , 可接受文件拖放
.常量 , , , 
.常量 WM_DROPFILES, "563", , 拖放文件消息
.常量 , , , 
.常量 FFFFFFFF, "4294967295", , 
.常量 , , , 
.常量 错误_窗口句柄无效, "256", 公开, 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 5 0 系统核心支持库
 ' spec A512548E76954B6E92C21055517615B0 3 0 特殊功能支持库




数据类型 子类化, , 
    .成员 窗口句柄, 整数型, , , 
    .成员 旧扩展风格, 整数型, , , 
    .成员 旧函数地址, 整数型, , , 
    .成员 回调函数, 整数型, , , 
    .成员 ID, 整数型, , , 

.全局变量 全局结构, 子类化, , "0", 

.DLL命令 SetWindowLongA, 整数型, "user32", "SetWindowLongA", , 在窗口结构中为指定的窗口设置信息　指定数据的前一个值
    .参数 hwnd, 整数型, , 欲为其取得信息的窗口的句柄
    .参数 nIndex, 整数型, , 请参考GetWindowLong函数的nIndex参数的说明
    .参数 dwNewLong, 整数型, , 由nIndex指定的窗口信息的新值


.DLL命令 IsWindow, 整数型, "user32", "IsWindow", , 判断一个窗口句柄是否有效　非零表示成功，零表示失败
    .参数 窗口句柄, 整数型, , 待检查窗口的句柄
  

.DLL命令 GetWindowLongA, 整数型, "user32", "GetWindowLongA", , 从指定窗口的结构中取得信息　由nIndex决定。零表示出错。会设置GetLastError
    .参数 窗口句柄, 整数型, , 欲为其获取信息的窗口的句柄
    .参数 属性, 整数型, , 欲取回的信息，可以是下述任何一个常数：
GWL_EXSTYLE：扩展窗口样式
GWL_STYLE：窗口样式
GWL_WNDPROC：该窗口的窗口函数的地址
GWL_HINSTANCE：拥有窗口的实例的句柄
GWL_HWNDPARENT：该窗口之父的句柄。不要用SetWindowWord来改变这个值
GWL_ID：对话框中一个子窗口的标识符
GWL_USERDATA：含义由应用程序规定
DWL_DLGPROC：这个窗口的对话框函数地址
DWL_MSGRESULT：在对话框函数中处理的一条消息返回的值
DWL_USER：含义由应用程序规定


.DLL命令 CallWindowProcA, 整数型, "user32", "CallWindowProcA", , 将消息传答窗口函数　
    .参数 lpPrevWndFunc, 整数型, , 
    .参数 hwnd, 整数型, , 
    .参数 msg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 整数型, , 

.DLL命令 DragQueryFileA, 整数型, "shell32.dll", "DragQueryFileA", , 返回托动的文件名　
    .参数 hDrop, 整数型, , 
    .参数 uInt, 整数型, , 
    .参数 lpStr, 文本型, 传址, 
    .参数 ch, 整数型, , 

.类模块 控件文件拖放类, , , 

.程序集变量 ID, 整数型, , , 
.程序集变量 临时结构, 子类化, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 接受拖放, 整数型, 公开, 返回0表示成功，其他为错误代码，见常量
.参数 窗口句柄, 整数型, , 要接受拖放的窗口或控件句柄
.参数 拖放事件回调函数, 子程序指针, , 当指定的窗口被拖放到文件时执行的程序，有且只有两个整数型参数。参数一：文件名文本指针，是以换行符分割的文本。参数二：数据长度。可以使用核心库的命令：指针到文本 () 取得数据。

.局部变量 返回值, 整数型, , , 

.如果真 (等于 (IsWindow (窗口句柄), 0))
    返回 (#错误_窗口句柄无效)
.如果真结束

赋值 (临时结构.ID, 相加 (取数组成员数 (全局结构), 1))
赋值 (临时结构.窗口句柄, 窗口句柄)
赋值 (临时结构.回调函数, 到整数 (拖放事件回调函数))
赋值 (临时结构.旧扩展风格, GetWindowLongA (窗口句柄, #GWL_EXSTYLE))
SetWindowLongA (窗口句柄, #GWL_EXSTYLE, 位或 (临时结构.旧扩展风格, #WS_EX_ACCEPTFILES))
赋值 (临时结构.旧函数地址, SetWindowLongA (窗口句柄, #GWL_WNDPROC, 到整数 (&子类化程序)))
加入成员 (全局结构, 临时结构)
赋值 (ID, 临时结构.ID)
返回 (0)


.子程序 撤销拖放, 整数型, 公开, 返回1表示成功，返回0表示失败
SetWindowLongA (全局结构 [ID], 窗口句柄, #GWL_EXSTYLE, 全局结构 [ID], 旧扩展风格)
SetWindowLongA (全局结构 [ID], 窗口句柄, #GWL_WNDPROC, 全局结构 [ID], 旧函数地址)
返回 (删除成员 (全局结构, ID, 1))


.子程序 置回调函数, 空白型, 公开, 
.参数 新回调函数, 子程序指针, , 

赋值 (全局结构 [ID], 回调函数, 到整数 (新回调函数))


.程序集 程序集, , , 

.子程序 _启动子程序, 整数型, , 

返回 (0)

.子程序 动态执行子程序, 整数型, , 
.参数 函数地址, 整数型, , 函数地址必须为第一个参数,调用时会重新调整参数排列的,后面的参数与API声明一样了
.参数 参数1, 整数型, , 
.参数 参数2, 整数型, , 

 ' push ebp <------------这两句已经是易原有的
 ' mov ebp, esp
 ' MOV eax,dword ptr ss:[ebp+08]  取得第一个参数的函数地址
 ' MOV ebx,dword ptr ss:[ebp+04]  取得返回地址
 ' MOV dword ptr ss:[ebp+08],ebx  修改返回地址
 ' POP ebp
 ' POP ebx                        平栈,去掉第一个参数
 ' JMP eax                        跳到函数地址

置入代码 ({ 139, 69, 8, 139, 93, 4, 137, 93, 8, 93, 91, 255, 224 })
返回 (0)

.子程序 子类化程序, 整数型, , 
.参数 hWnd, 整数型, , 
.参数 Message, 整数型, , 
.参数 wParam, 整数型, , 
.参数 lParam, 整数型, , 

.局部变量 循环整数, 整数型, , , 
.局部变量 ID, 整数型, , , 
.局部变量 文件数, 整数型, , , 
.局部变量 临时文本, 文本型, , , 
.局部变量 结果文本, 文本型, , , 

.计次循环首 (取数组成员数 (全局结构), 循环整数)
    .如果真 (等于 (hWnd, 全局结构 [循环整数], 窗口句柄))
        赋值 (ID, 循环整数)
        跳出循环 ()
    .如果真结束
    到循环尾 ()
.计次循环尾 ()
.如果真 (等于 (Message, #WM_DROPFILES))
    赋值 (临时文本, 取空白文本 (260))
    赋值 (结果文本, “”)
    赋值 (文件数, DragQueryFileA (wParam, #FFFFFFFF, 字符 (0), 0))
    .计次循环首 (文件数, 循环整数)
        DragQueryFileA (wParam, 相减 (循环整数, 1), 临时文本, 260)
        赋值 (结果文本, 相加 (结果文本, 临时文本, #换行符))
    .计次循环尾 ()
    动态执行子程序 (全局结构 [ID], 回调函数, 取变量数据地址 (结果文本), 取文本长度 (结果文本))
    返回 (1)
.如果真结束
返回 (CallWindowProcA (全局结构 [ID], 旧函数地址, hWnd, Message, wParam, lParam))



 ' 不属于任何一个程序集、类模块的函数：
