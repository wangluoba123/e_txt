 ' 文件类型：Windows窗口程序

 ' 程序名称：海风文件传送客户端
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 512
    高度 = 163
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “网络文件传送客户端”
    帮助文件名 = “”





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 5 系统核心支持库
 ' Exmlrpc A36CFD538657479eBD7C0D287BBB3D95 1 2 远程服务支持库





.DLL命令 创建文件, 整数型, "kernel32.dll", "CreateFileA", , 
    .参数 文件名, 文本型, , 
    .参数 打开方式, 整数型, , -2147483648表示读，1073741824表示写，0可取属性
    .参数 共享方式, 整数型, , 1共享读，2共享写，0不共享
    .参数 安全性, 整数型, , 为空即可
    .参数 打开方式２, 整数型, , 1创建文件（文件存在出错），2创建文件（改写），3文件必须存在，4如果文件不存在则创建，5将现有文件缩短为0
    .参数 文件属性, 整数型, , 128默认属性，268435456随机访问优化，134217728连续访问优化，67108864临时文件
    .参数 文件句柄, 整数型, , 一般为0

.DLL命令 关闭对象, 整数型, "kernel32.dll", "CloseHandle", , 可关闭文件与映射
    .参数 对象句柄, 整数型, , 

.DLL命令 取文件大小, 长整数型, "kernel32.dll", "GetFileSize", , 文件长度的低32位
    .参数 文件句柄, 整数型, , 
    .参数 高32位, 长整数型, 传址, 文件长度的低32位，文件大小超过4GB时，此值大于0,否则为0

.DLL命令 创建映射, 整数型, "kernel32.dll", "CreateFileMappingA", , 返回映射句柄
    .参数 文件句柄, 整数型, , 
    .参数 安全对象, 整数型, , 0表示默认属性
    .参数 映射方式, 整数型, , 2表示只读，4表示可读写
    .参数 高32位, 整数型, , 文件映射的最大长度（高32位）
    .参数 低32位, 整数型, , 文件映射的最小长度（低32位）
    .参数 对象名字, 整数型, , 可以更改为文本型以指定对象名称

.DLL命令 映射装载, 整数型, "kernel32.dll", "MapViewOfFile", , 文件映射在内存中的起始地址,零表示出错
    .参数 映射句柄, 整数型, , 
    .参数 映射方式, 整数型, , 2可读可写,4只读,
    .参数 高32位, 整数型, , 文件中映射起点的高32位地址，64k的整数倍
    .参数 低32位, 整数型, , 文件中映射起点的低32位地址，64k的整数倍
    .参数 字节数, 整数型, , 文件中要映射的字节数，根据实际长度指定

.DLL命令 映射卸载, 整数型, "kernel32.dll", "UnmapViewOfFile", , 非零表示成功，零表示失败
    .参数 映射地址, 整数型, , 用映射装载函数获得的

.DLL命令 写入映射_字节集, 整数型, "kernel32.dll", "RtlMoveMemory", , 将指定字节集的全部或部分写入映射空间的指定位置
    .参数 起始位置, 整数型, , 用映射装载命令得到的
    .参数 待写入数据, 字节集, 传址, 要写入的数据，可以更改为其他类型
    .参数 数据长度, 整数型, , 要写入的数据长度，不大于实际数据长度

.DLL命令 取错误代码, 整数型, "kernel32.dll", "GetLastError", , 

.程序集 文件接收端, , , 

.程序集变量 客户端, 未知类型0x20002, , , 
.程序集变量 已经连接, 逻辑型, , , 
.程序集变量 匿名程序集变量_142, 空白型, , , 
.程序集变量 远程文件句柄, 整数型, , , 
.程序集变量 远程映射句柄, 整数型, , , 
.程序集变量 远程文件大小, 长整数型, , , 
.程序集变量 位分界数, 长整数型, , , 
.程序集变量 错误记录, 文本型, , "0", 
.程序集变量 匿名程序集变量_80, 空白型, , , 
.程序集变量 文件句柄, 整数型, , , 
.程序集变量 文件名, 文本型, , , 
.程序集变量 映射句柄, 整数型, , , 
.程序集变量 分块大小, 整数型, , , 
.程序集变量 匿名程序集变量_144, 空白型, , , 
.程序集变量 当前操作, 文本型, , , 
.程序集变量 当前收到数据量, 长整数型, , , 
.程序集变量 开始时间, 整数型, , , 
.子程序 相关说明, 空白型, , 
 ' 本程序集包含所有文件传送所要用到的函数，具体应用请看窗口程序
 ' 注意，服务器不保存任何与客户相关的信息，包括文件信息等，全部发给客户并由客户保存
 ' 如果客户要下载文件指定部分，必须指出文件句柄和映射句柄，否则将无法下载。
 ' 客户下载完成后，必须返回所用的文件句柄和映射句柄，以便服务器释放系统资源。
 ' 服务器不能获取下载进度、已发送数据长度、和已下载时间、以及有几个用户在下载中
 ' 这样处理的目的是：让服务器使用尽可能少的全局变量和程序集变量而减轻服务器的负担。
 ' 如果有需要在服务器端获取相关数据，请自行添加变量及处理方法与函数
 ' 本程序仅供参考，是否有误，还待测试，如果你修改过本程序，请发给作者一份
 ' 如果在文件传送过程中发现程序停止响应，可能是服务器端发来的数据分割符过于简单而与所发送数据段中数据重叠所致，
 ' 你可以修改得复杂一些，或者干用一张很小的图片来代替，可能占100个字节，这样数据重叠的可能性就大大减小。

 ' 本人没能对多线程的应用进行深刻理解，甚至是无法理解。
 ' 如果有哪位同仁将此程序修改为一个多线程应用程序，请发给本人一份，本人十分感激！
 ' 如果有哪位兄弟姐妹愿意教本人，本人将更加努力，使程序编写得更好更强大，谢谢！

 ' 有能力和精力的朋友可以对本程序代码进行优化
 ' 如果测试中遇到问题，请告知作者，本人在能力可能的情况下给予修正。

 ' 作者联系方式：E-Mail:oyhp1@163.com，oyhp1@gmail.com
 ' 　　　　　　：QQ:120564136

 ' ――――谢谢合作！


.子程序 连接文件服务器, 逻辑型, , 连接到服务器
.参数 服务端IP, 文本型, , 
.参数 服务端口, 整数型, 可空, 默认为9119

赋值 (当前操作, “正在连接”)
.如果真 (是否为空 (服务端口))
    赋值 (服务端口, 9119)
.如果真结束
赋值 (已经连接, 客户端.未知支持库函数_15 (服务端口, 服务端IP, 假, &数据处理))
.如果真 (等于 (已经连接, 假))
    赋值 (当前操作, “”)
.如果真结束

赋值 (位分界数, 求次方 (2, 32))
返回 (已经连接)


.子程序 断开文件服务器, 空白型, , 
客户端.未知支持库函数_16 ()
赋值 (已经连接, 假)


.子程序 是否已连接, 逻辑型, , 
返回 (已经连接)


.子程序 开始文件下载, 逻辑型, , 
.参数 远程文件名, 文本型, , 
.参数 本地文件名, 文本型, , 

.局部变量 请求下载, 逻辑型, , , 

 ' 格式为：a#|@|&文件绝对路径#|@|&无效字符#|@|&无效字符
.如果真 (等于 (删全部空 (远程文件名), “”))
    返回 (假)
.如果真结束

.如果真 (小于 (寻找文本 (远程文件名, “:”, , 假), 2))
    返回 (假)
.如果真结束

赋值 (请求下载, 客户端.未知支持库函数_19 (相加 (“a#|@|&”, 远程文件名, “#|@|&0#|@|&0”)))
.如果 (请求下载)
    赋值 (文件名, 本地文件名)
    赋值 (当前操作, “请求下载”)
.否则
    赋值 (当前操作, “”)
.如果结束
返回 (请求下载)


.子程序 数据处理, 空白型, , 
.参数 消息地址, 整数型, , 

.局部变量 消息类型, 整数型, , , 
.局部变量 结果信息, 字节集, , , 
.局部变量 服务信息, 字节集, , "0", 
.局部变量 服务信息成员数, 整数型, , , 

赋值 (消息类型, 客户端.未知支持库函数_24 (消息地址))
.如果真 (等于 (消息类型, 0))
     ' 服务器断开
    返回 ()
.如果真结束

.如果真 (等于 (消息类型, -1))
     ' 发生错误
    返回 ()
.如果真结束

客户端.未知支持库函数_22 (消息地址, 结果信息)
赋值 (服务信息, 分割字节集 (结果信息, 到字节集 (“#|@|&”), ))
赋值 (服务信息成员数, 取数组成员数 (服务信息))

 ' 收到服务器出错信息，格式：错误出处#|@|&原因
 ' 出错信息只含有简单的字符，
.如果真 (等于 (服务信息成员数, 2))
    出错处理 (到文本 (服务信息 [1]), 到文本 (服务信息 [2]))
    返回 ()
.如果真结束

 ' 收到服务器正确数据
 ' 文件信息：a#|@|&文件句柄#|@|&映射句柄#|@|&文件大小
 ' 下载信息：b#|@|&数据块大小#|@|&位置_高32位#|@|&位置_低32位
.如果真 (大于 (服务信息成员数, 2))
    服务数据处理 (服务信息, 服务信息成员数)
    返回 ()
.如果真结束




.子程序 服务数据处理, 空白型, , 传送此数的目的是让此程序不再计算数组成员的个数，似乎有点多余
.参数 服务信息, 字节集, 数组, 客户收到的返回字节集数组
.参数 服务信息成员数, 整数型, , 此数可以减少数组操作出错的机会

.局部变量 服务类型, 文本型, , , 
.局部变量 高32位, 整数型, , , 
.局部变量 低32位, 整数型, , , 
.局部变量 数据块大小, 整数型, , , 
.局部变量 视图句柄, 整数型, , , 
.局部变量 错误原因, 文本型, , , 
.局部变量 高32位_, 整数型, , , 
.局部变量 低32位_, 整数型, , , 
.局部变量 i, 整数型, , , 

赋值 (服务类型, 到文本 (服务信息 [1]))

.如果真 (并且 (不等于 (服务类型, “a”), 不等于 (服务类型, “b”)))
    赋值 (错误原因, “收到错误信息，但无法确定其原因。”)
    加入成员 (错误记录, 错误原因)
    赋值 (当前操作, “”)
    返回 ()
.如果真结束

 ' 文件信息：a#|@|&文件句柄#|@|&映射句柄#|@|&文件大小#|@|&分块大小
.如果真 (并且 (等于 (服务类型, “a”), 等于 (服务信息成员数, 5)))
    赋值 (远程文件句柄, 到整数 (到文本 (服务信息 [2])))
    赋值 (远程映射句柄, 到整数 (到文本 (服务信息 [3])))
    赋值 (远程文件大小, 到长整数 (到文本 (服务信息 [4])))
    赋值 (分块大小, 到整数 (到文本 (服务信息 [5])))
    赋值 (高32位, 到整数 (相除 (远程文件大小, 位分界数)))
    赋值 (低32位, 求余数 (远程文件大小, 位分界数))
    
     ' 创建一个与远程文件一样大的文件,如果原文件已经存在则重写该文件
    赋值 (文件句柄, 创建文件 (文件名, 相加 (-2147483648, 1073741824), 2, 0, 2, 128, 0))
    .如果真 (小于 (文件句柄, 1))
        加入成员 (错误记录, “无法创建本地文件”)
        赋值 (当前操作, “”)
        返回 ()
    .如果真结束
    
    赋值 (映射句柄, 创建映射 (文件句柄, 0, 4, 高32位, 低32位, 0))
    .如果真 (小于 (映射句柄, 1))
        加入成员 (错误记录, “本地文件读取错误.”)
        赋值 (当前操作, 到文本 (远程文件大小))
        返回 ()
    .如果真结束
    赋值 (开始时间, 取启动时间 ())
    赋值 (当前收到数据量, 0)
    
    客户端.未知支持库函数_19 (相加 (“b#|@|&”, 到文本 (远程文件句柄), “#|@|&”, 到文本 (远程映射句柄), “#|@|&0#|@|&0”))
    赋值 (当前操作, “正在下载”)
    
    返回 ()
.如果真结束


 ' 下载信息：b#|@|&数据块大小#|@|&位置_高32位#|@|&位置_低32位#|@|&文件数据
.如果真 (并且 (等于 (服务类型, “b”), 等于 (服务信息成员数, 5)))
    赋值 (数据块大小, 到整数 (到文本 (服务信息 [2])))
    赋值 (高32位, 到整数 (到文本 (服务信息 [3])))
    赋值 (低32位, 到整数 (到文本 (服务信息 [4])))
    .如果真 (小于 (数据块大小, 1))
         ' 收到空数据
        赋值 (当前操作, “数据下载中，但发现错误，已中止下载”)
        返回 ()
    .如果真结束
    
    .如果真 (不等于 (取字节集长度 (服务信息 [5]), 数据块大小))
         ' 如果收到的数据的长度与标识长度不一至，通知服务器重发
        客户端.未知支持库函数_19 (相加 (“b#|@|&”, 到文本 (远程文件句柄), “#|@|&”, 到文本 (远程映射句柄), “#|@|&”, 到文本 (高32位), “#|@|&”, 到文本 (低32位)))
        赋值 (当前操作, “数据不完整，要求重发”)
        返回 ()
    .如果真结束
    
    
    赋值 (视图句柄, 映射装载 (映射句柄, 2, 高32位, 低32位, 数据块大小))
    .如果真 (小于 (视图句柄, 1))
        加入成员 (错误记录, “本地文件读写错误.”)
        赋值 (当前操作, “”)
        返回 ()
    .如果真结束
    
    
    写入映射_字节集 (视图句柄, 服务信息 [5], 数据块大小)
    映射卸载 (视图句柄)
    
    赋值 (当前收到数据量, 相加 (当前收到数据量, 数据块大小))
    .如果 (大于 (相减 (当前收到数据量, 远程文件大小), -1))
         ' 文件数据下载完成
        客户端.未知支持库函数_19 (相加 (“c#|@|&”, 到文本 (远程文件句柄), “#|@|&”, 到文本 (远程映射句柄), “#|@|&0”))
        赋值 (当前操作, “下载完成”)
        赋值 (远程文件句柄, 0)
        赋值 (远程映射句柄, 0)
        关闭对象 (映射句柄)
        关闭对象 (文件句柄)
        
    .否则
        赋值 (当前操作, “正在下载”)
        赋值 (高32位_, 整除 (当前收到数据量, 位分界数))
        赋值 (低32位_, 求余数 (当前收到数据量, 位分界数))
        客户端.未知支持库函数_19 (相加 (“b#|@|&”, 到文本 (远程文件句柄), “#|@|&”, 到文本 (远程映射句柄), “#|@|&”, 到文本 (高32位_), “#|@|&”, 到文本 (低32位_)))
    .如果结束
    
.如果真结束



.子程序 出错处理, 空白型, , 
.参数 错误信息出处, 文本型, , 指出服务器在处理哪一类指令时出错
.参数 出错原因, 文本型, , 

.局部变量 错误原因, 文本型, , , 

.如果真 (并且 (不等于 (错误信息出处, “a”), 不等于 (错误信息出处, “b”)))
    赋值 (错误原因, “收到错误信息，但无法确定其原因。”)
    赋值 (当前操作, “”)
    加入成员 (错误记录, 错误原因)
    返回 ()
.如果真结束

.如果真 (等于 (错误信息出处, “a”))
    赋值 (错误原因, “获取文件信息时出现错误：”)
    .如果真 (等于 (出错原因, “a”))
        加入成员 (错误记录, 相加 (错误原因, “远程文件不存在，”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “b”))
        加入成员 (错误记录, 相加 (错误原因, “文件无法打开，可能是其他程序以独占方式打开了该文件，”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “c”))
        加入成员 (错误记录, 相加 (错误原因, “文件为空文件，不予传送。”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “d”))
        加入成员 (错误记录, 相加 (错误原因, “文件已经打开，但无法读取。”))
    .如果真结束
    
    赋值 (当前操作, “”)
    返回 ()
.如果真结束

.如果真 (等于 (错误信息出处, “b”))
    赋值 (错误原因, “传送过程中发生错误：”)
    .如果真 (等于 (出错原因, “a”))
        加入成员 (错误记录, 相加 (错误原因, “指定文件未打开或已关闭。”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “b”))
        加入成员 (错误记录, 相加 (错误原因, “指定文件未打开或已关闭，也可能是文件被意外删除。”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “c”))
        加入成员 (错误记录, 相加 (错误原因, “下载位置大于文件大小，请示被忽略。”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “d”))
        加入成员 (错误记录, 相加 (错误原因, “读取指定数据区出错。”))
    .如果真结束
    
    .如果真 (等于 (出错原因, “e”))
         ' 从内存读入数据出错
        加入成员 (错误记录, 相加 (错误原因, “服务器出现不明错误。”))
    .如果真结束
    赋值 (当前操作, “”)
    返回 ()
.如果真结束


.子程序 取下载信息, 空白型, , 获取下载相关信息
.参数 当前状态, 文本型, 参考 可空, 
.参数 文件大小, 文本型, 参考 可空, 
.参数 下载速度, 文本型, 参考 可空, 
.参数 用时, 小数型, 参考 可空, 单位为秒
.参数 已下载, 文本型, 参考 可空, 
.参数 下载进度, 小数型, 参考 可空, 百分比的100倍
.参数 剩余下载, 文本型, 参考 可空, 
.参数 错误, 文本型, 参考 可空 数组, 所有运行过程中发生的错误内容

.局部变量 速度, 整数型, , , 

.如果真 (取反 (是否为空 (当前状态)))
    赋值 (当前状态, 当前操作)
.如果真结束

.如果真 (取反 (是否为空 (文件大小)))
    赋值 (文件大小, 大小转换 (远程文件大小))
.如果真结束

.如果真 (取反 (是否为空 (下载速度)))
    赋值 (速度, 取整 (相除 (当前收到数据量, 相除 (相减 (取启动时间 (), 开始时间), 1000))))
    赋值 (下载速度, 相加 (大小转换 (速度), “/S”))
.如果真结束

.如果真 (取反 (是否为空 (用时)))
    赋值 (用时, 相除 (取整 (相除 (相减 (取启动时间 (), 开始时间), 10)), 100))
.如果真结束

.如果真 (取反 (是否为空 (已下载)))
    赋值 (已下载, 大小转换 (当前收到数据量))
.如果真结束

.如果真 (取反 (是否为空 (剩余下载)))
    赋值 (文件大小, 大小转换 (相减 (远程文件大小, 当前收到数据量)))
.如果真结束

.如果真 (取反 (是否为空 (下载进度)))
    赋值 (下载进度, 相除 (到整数 (相乘 (相除 (当前收到数据量, 远程文件大小), 10000)), 100))
.如果真结束

.如果真 (取反 (是否为空 (错误)))
    复制数组 (错误, 错误记录)
.如果真结束



.子程序 大小转换, 文本型, , 
.参数 参数, 长整数型, , 

.局部变量 参数_1, 小数型, , , 
.局部变量 位, 整数型, , , 

赋值 (参数_1, 参数)
赋值 (位, 1)
.判断循环首 (大于 (参数_1, 1023))
    赋值 (参数_1, 相除 (参数_1, 1024))
    赋值 (位, 相加 (位, 1))
.判断循环尾 ()
返回 (相加 (到文本 (相除 (到整数 (相乘 (参数_1, 100)), 100)), 取文本中间 (“ KMGTE”, 位, 1), “B”))


.窗口程序集 窗口程序集1, , , 

.子程序 _按钮1_被单击, 空白型, , 
.局部变量 连接, 逻辑型, , , 

赋值 (连接, 连接文件服务器 (.内容, 到整数 (.内容)))
赋值 (.禁止, 连接)
赋值 (.禁止, 取反 (连接))
赋值 (.禁止, 取反 (连接))
.如果 (连接)
    赋值 (., “网络文件传送客户端――与服务器连接成功！”)
.否则
    赋值 (., “网络文件传送客户端――与服务器连接失败！”)
.如果结束


.子程序 _按钮2_被单击, 空白型, , 
断开文件服务器 ()
赋值 (., “网络文件传送客户端――与服务器连接断开！”)
赋值 (.禁止, 假)
赋值 (.禁止, 真)
赋值 (.禁止, 真)


.子程序 _按钮3_被单击, 空白型, , 
.局部变量 文件扩展名, 文本型, , , 
.局部变量 文件名, 文本型, , , 

 ' 必须在发送请求之前选择好下载文件的保存路径和文件名
赋值 (.类型, 1)
赋值 (文件扩展名, 取文本右边 (.内容, 相减 (取文本长度 (.内容), 倒找文本 (.内容, “.”, , 假))))
赋值 (文件名, 取文本右边 (.内容, 相减 (取文本长度 (.内容), 倒找文本 (.内容, “\”, , 假))))
赋值 (.过滤器, 相加 (文件扩展名, “文件|*.”, 文件扩展名))
赋值 (.默认文件后缀, 文件扩展名)
打开 ()
赋值 (文件名, .文件名)
.如果真 (等于 (文件名, “”))
    返回 ()
.如果真结束

赋值 (.禁止, 开始文件下载 (.内容, 文件名))
.如果真 (.禁止)
    赋值 (.时钟周期, 1000)
.如果真结束


.子程序 _时钟1_周期事件, 空白型, , 
.局部变量 当前状态, 文本型, , , 
.局部变量 下载进度, 小数型, , , 
.局部变量 错误, 文本型, , "0", 
.局部变量 已下载, 文本型, , , 
.局部变量 下载速度, 文本型, , , 
.局部变量 用时, 小数型, , , 

取下载信息 (当前状态, , 下载速度, 用时, 已下载, 下载进度, , 错误)
赋值 (.标题, 相加 (“当前状态：”, 当前状态, “ 已下载：”, 已下载, “ 下载速度:”, 下载速度, “ 下载进度:”, 到文本 (下载进度), “ 用时:”, 到文本 (用时)))
赋值 (.位置, 到整数 (下载进度))
.如果真 (大于 (取数组成员数 (错误), 0))
    赋值 (.标题, 错误 [取数组成员数 (错误)])
.如果真结束

.如果真 (或者 (等于 (当前状态, “”), 等于 (当前状态, “下载完成”)))
    赋值 (.时钟周期, 0)
    返回 ()
.如果真结束
赋值 (.时钟周期, 1000)



 ' 不属于任何一个程序集、类模块的函数：
