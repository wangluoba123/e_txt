 ' 文件类型：Windows窗口程序

 ' 程序名称：
 ' 程序描述：
 ' 程序作者：本源码来自易语言资源网(www.5A5X.com)
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：             易语言资源网注意事项
--============   www.5A5X.com  =============--
* 易语言资源网为易语言官方站、易语言官方论坛提供辅助资源站；本易语言资源网( www.5A5X.com)所有软件和资料均为软件作者提供和网友推荐发布而来，其版权归该软件和程序源码的合法拥有者所有，本站易语言资源网整理收集仅供易语言用户学习和易语言技术研究探讨使用，不得用于任何商业用途。如果由于以上原因造成的版权纠纷本站概不负责！
* 本站资源未经许可,任何网站不得非法盗链及抄袭本站资源；如引用，请注明来自易语言资源网，谢谢合作！
--============   www.5A5X.com  =============--
 ' 版本号：1.0
 ' 创建号：0.0

窗口 窗口1
    左边 = 50
    顶边 = 50
    宽度 = 412
    高度 = 99
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    窗口类名 = “”
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “iocp进度复制文件 恢复暂停 停止(复制到当前目录)”
    帮助文件名 = “”



.常量 IDC_WAIT, "32514", , 
.常量 GENERIC_READ, "2147483648", , 
.常量 FILE_SHARE_READ, "1", , 
.常量 OPEN_EXISTING, "3", , 
.常量 FILE_FLAG_NO_BUFFERING, "536870912", , 
.常量 FILE_FLAG_OVERLAPPED, "1073741824", , 
.常量 , , , 
.常量 , , , 
.常量 BUFFSIZE, "65536", , 用来读取写入的大小
.常量 , , , 
.常量 GENERIC_WRITE, "1073741824", , 
.常量 CREATE_ALWAYS, "2", , 
.常量 , , , 
.常量 FILE_BEGIN, "0", , 
.常量 , , , 
.常量 完成键_读, "1", , 
.常量 完成键_写, "2", , 
.常量 , , , 
.常量 MAX_PENDING_IO_REQS, "4", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 5 0 系统核心支持库
 ' spec A512548E76954B6E92C21055517615B0 3 0 特殊功能支持库
 ' EThread 5F99C1642A2F4e03850721B4F5D7C3F8 2 0 多线程支持库




数据类型 OVERLAPPED, , 
    .成员 Internal, 空白型, , , 
    .成员 InternalHigh, 空白型, , , 
    .成员 Offset, 长整数型, , , 
    .成员 Pointer, 整数型, , , 
    .成员 hEvent, 空白型, , , 


.DLL命令 CreateRectRgn, 整数型, "gdi32.dll", "CreateRectRgn", 公开, 创建矩形。执行成功为区域句柄，失败则为零
    .参数 X1, 整数型, , 矩形左上角X，Y坐标
    .参数 Y1, 整数型, , 同上
    .参数 X2, 整数型, , 矩形右下角X，Y坐标    
    .参数 Y2, 整数型, , 同上  

.DLL命令 SetWindowRgn, 整数型, "user32.dll", "SetWindowRgn", 公开, 创建外形
    .参数 hWnd, 整数型, , 窗口句柄
    .参数 hRgn, 整数型, , 区域句柄
    .参数 bRedraw, 逻辑型, , 重画窗口

.DLL命令 GetCompressedFileSize, 整数型, "", "GetCompressedFileSizeA", , 
    .参数 lpszFileName, 文本型, , 
    .参数 lpFileSizeHigh, 整数型, 传址, 

.DLL命令 CreateEvent, 整数型, "", "CreateEventA", , 
    .参数 lpEventAttributes, 空白型, , 
    .参数 bManualReset, 逻辑型, , 
    .参数 bInitialState, 逻辑型, , 
    .参数 lpName, 整数型, , 

.DLL命令 SetEvent, 逻辑型, "", "", , 
    .参数 hEvent, 空白型, , 

.DLL命令 CloseHandle, 逻辑型, "", "", , 
    .参数 hObject, 空白型, , 

.DLL命令 WaitForSingleObject, 整数型, "", "WaitForSingleObject", , 
    .参数 hHandle, 空白型, , 
    .参数 dwMilliseconds, 空白型, , 

.DLL命令 LoadCursor, 整数型, "", "LoadCursorA", , 
    .参数 hInstance, 空白型, , 
    .参数 lpCursorName, 空白型, , 

.DLL命令 SetCursor, 整数型, "", "", , 
    .参数 hCursor, 空白型, , 

.DLL命令 Sleep, 空白型, "", "", , 
    .参数 time, 空白型, , 

.DLL命令 CreateFile, 整数型, "", "CreateFileA", , 
    .参数 lpFileName, 文本型, , 
    .参数 dwDesiredAccess, 空白型, , 
    .参数 dwShareMode, 空白型, , 
    .参数 lpSecurityAttributes, 空白型, , 
    .参数 dwCreationDisposition, 空白型, , 
    .参数 dwFlagsAndAttributes, 空白型, , 
    .参数 hTemplateFile, 空白型, , 

.DLL命令 GetFileSizeEx, 逻辑型, "", "", , 
    .参数 hFile, 空白型, , 
    .参数 lpFileSize, 长整数型, 传址, 

.DLL命令 SetFilePointerEx, 逻辑型, "", "", , 
    .参数 hFile, 空白型, , 
    .参数 liDistanceToMove, 长整数型, , 
    .参数 lpNewFilePointer, 长整数型, 传址, 
    .参数 dwMoveMethod, 空白型, , 

.DLL命令 SetEndOfFile, 逻辑型, "", "", , 
    .参数 hFile, 空白型, , 

.DLL命令 CreateIoCompletionPort, 整数型, "", "", , 
    .参数 FileHandle, 空白型, , 
    .参数 ExistingCompletionPort, 空白型, , 
    .参数 CompletionKey, 空白型, , 
    .参数 NumberOfConcurrentThreads, 空白型, , 

.DLL命令 PostQueuedCompletionStatus, 逻辑型, "", "", , 
    .参数 CompletionPort, 空白型, , 
    .参数 dwNumberOfBytesTransferred, 空白型, , 
    .参数 dwCompletionKey, 空白型, , 
    .参数 lpOverlapped, OVERLAPPED, , 

.DLL命令 GetQueuedCompletionStatus, 逻辑型, "", "", , 
    .参数 CompletionPort, 空白型, , 
    .参数 lpNumberOfBytes, 空白型, 传址, 
    .参数 lpCompletionKey, 空白型, 传址, 
    .参数 lpOverlapped, 整数型, 传址, 
    .参数 dwMilliseconds, 空白型, , 

.DLL命令 WriteFile, 逻辑型, "", "", , 
    .参数 hFile, 空白型, , 
    .参数 lpBuffer, 字节集, , 
    .参数 nNumberOfBytesToWrite, 空白型, , 
    .参数 lpNumberOfBytesWritten, 空白型, , 
    .参数 lpOverlapped, OVERLAPPED, , 

.DLL命令 ReadFile, 逻辑型, "", "", , 
    .参数 hFile, 空白型, , 
    .参数 lpBuffer, 字节集, , 
    .参数 nNumberOfBytesToRead, 空白型, , 
    .参数 lpNumberOfBytesRead, 空白型, , 
    .参数 lpOverlapped, OVERLAPPED, , 

.程序集 程序集1, , , 

.子程序 _启动子程序, 整数型, , 本子程序在程序启动后最先执行
载入 (窗口1, , 假)
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 创建浅凹式控件_黑月, 整数型, 公开, 返回SetWindowRgn返回的整数 失败返回-1
.参数 控件句柄, 整数型, , 给我控件的句柄
.参数 x1, 空白型, , 0  1
.参数 y1, 空白型, , 0 1
.参数 x2, 空白型, , 宽度-1
.参数 y2, 空白型, , 宽度-2

.局部变量 setwindwod, 整数型, , , 
.局部变量 矩形区域, 整数型, , , 

赋值 (矩形区域, CreateRectRgn (x1, y1, x2, y2))
赋值 (setwindwod, SetWindowRgn (控件句柄, 矩形区域, 真))
返回 (setwindwod)

.子程序 取整数型指针_黑月, 整数型, 公开, 
.参数 abc, 整数型, 参考, 

置入代码 ({ 139, 69, 8, 137, 236, 93, 194, 4, 0 })
 ' 本源码来自易语言资源网(www.5A5X.com)
返回 (0)

.子程序 计算百分比, 长整数型, , 
.参数 参数_小, 长整数型, , 
.参数 参数_大, 长整数型, , 


返回 (相乘 (相除 (参数_小, 参数_大), 100))

.窗口程序集 窗口程序集1, , , 

.程序集变量 集_命令, 整数型, , , 0 无 1停止 2 暂停
.程序集变量 集_事件, 整数型, , , 
.程序集变量 集_目标文件名, 文本型, , , 
.子程序 _窗口1_创建完毕, 空白型, , 
 ' --========  易语言资源网  (www.5A5X.com)  ======--
 ' 努力创建完善、持续更新的易语言学习例程源码资源站
 ' --================   www.5A5X.com  ===========--
 ' --==================   易语言资源网注意事项  ================--
 ' * 易语言资源网为易语言官方站、易语言官方论坛提供辅助资源站；
 ' 本易语言资源网( www.5A5X.com)所有软件和资料均为软件作者提
 ' 供和网友推荐发布而来，其版权归该软件和程序源码的合法拥有者所
 ' 有，本站易语言资源网整理收集仅供易语言用户学习和易语言技术研
 ' 究探讨使用，不得用于任何商业用途。如果由于以上原因造成的版权
 ' 纠纷本站概不负责！
 ' * 本站资源未经许可，任何网站不得非法盗链及抄袭本站资源；如引用
 ' 页面，请注明来自易语言资源网，谢谢合作！
 ' --=====================   www.5A5X.com  ================--

SetCursor (LoadCursor (0, #IDC_WAIT))
创建浅凹式控件_黑月 (取窗口句柄 (), 0, 0, 相减 (.宽度, 1), 相减 (.高度, 1))
创建浅凹式控件_黑月 (取窗口句柄 (), 0, 0, 相减 (.宽度, 1), 相减 (.高度, 1))
创建浅凹式控件_黑月 (取窗口句柄 (), 0, 0, 相减 (.宽度, 1), 相减 (.高度, 1))
创建浅凹式控件_黑月 (取窗口句柄 (), 0, 0, 相减 (.宽度, 1), 相减 (.高度, 1))
窗口1.获取焦点 ()
赋值 (集_命令, 0)
赋值 (集_事件, CreateEvent (0, 假, 假, 0)) ' 创建一个无名事件 用来控制 暂停与恢复
赋值 (集_目标文件名, “目标文件”)
 ' code by smallwhite
 ' qq 313288817

.子程序 _按钮_选择文件_被单击, 空白型, , 
.局部变量 局部_文件大小High, 整数型, , , 
.局部变量 局部_文件大小Low, 整数型, , , 
.局部变量 局部_文件大小, 长整数型, , , 

赋值 (.初始目录, 取当前目录 ())
.如果 (打开 ())
    赋值 (.内容, .文件名)
    赋值 (局部_文件大小Low, GetCompressedFileSize (.文件名, 局部_文件大小High)) ' 取文件大小
    赋值 (局部_文件大小, 相乘 (局部_文件大小High, 4294967295)) ' 高位乘以 0xffffffff 再+上 低位 就是文件大小了
    赋值 (局部_文件大小, 相加 (局部_文件大小, 局部_文件大小Low))
    赋值 (局部_文件大小, 相除 (局部_文件大小, 1024)) ' kb
    赋值 (.内容, 相加 (到文本 (局部_文件大小), “ KB”))
.否则
    赋值 (.内容, “”)
    赋值 (.内容, “0 KB”)
.如果结束
 ' 本源码来自易语言资源网(www.5A5X.com)


.子程序 线程_复制文件, 逻辑型, , 
.局部变量 局部_返回结果, 逻辑型, , , 
.局部变量 局部_源文件句柄, 空白型, , , 
.局部变量 局部_目标文件句柄, 空白型, , , 
.局部变量 局部_文件大小, 长整数型, , , 
.局部变量 局部_目标文件大小, 长整数型, , , 
.局部变量 匿名局部变量_198, 空白型, , , 
.局部变量 局部_完成端口句柄, 整数型, , , 
.局部变量 匿名局部变量_217, 空白型, , , 
.局部变量 局部_剩余未完成读次数, 空白型, , , 
.局部变量 局部_剩余未完成写次数, 空白型, , , 
.局部变量 匿名局部变量_220, 空白型, , , 
.局部变量 局部_缓冲区, 字节集, , , 
.局部变量 匿名局部变量_242, 空白型, , , 
.局部变量 局部_读写IO, OVERLAPPED, , , 
.局部变量 匿名局部变量_246, 空白型, , , 
.局部变量 局部_完成键, 空白型, , , 
.局部变量 局部_字节数, 空白型, , , 
.局部变量 匿名局部变量_249, 空白型, , , 
.局部变量 局部_读写TMP, 整数型, , , 
.局部变量 匿名局部变量_276, 空白型, , , 
.局部变量 局部_下次读写位置, 长整数型, , , 
.局部变量 匿名局部变量_306, 空白型, , , 



赋值 (.禁止, 真)
赋值 (.禁止, 假)
赋值 (.禁止, 假)
赋值 (局部_返回结果, 假)
SetCursor (LoadCursor (0, #IDC_WAIT)) ' 设置鼠标指针为漏斗
赋值 (局部_源文件句柄, CreateFile (.内容, #GENERIC_READ, #FILE_SHARE_READ, 0, #OPEN_EXISTING, 相加 (#FILE_FLAG_NO_BUFFERING, #FILE_FLAG_OVERLAPPED), 0))
 ' 打开要复制的源文件
 ' #FILE_FLAG_NO_BUFFERING 表示不需要让系统吧文件读入高速缓存
 ' #FILE_FLAG_OVERLAPPED  表示要异步操作文件
.如果真 (等于 (局部_源文件句柄, -1))
    赋值 (.禁止, 假)
    赋值 (.禁止, 真)
    赋值 (.禁止, 真)
    返回 (局部_返回结果)
.如果真结束
GetFileSizeEx (局部_源文件句柄, 局部_文件大小) ' 取文件体积
赋值 (局部_目标文件大小, 相加 (相乘 (整除 (局部_文件大小, #BUFFSIZE), #BUFFSIZE), 选择 (大于 (求余数 (局部_文件大小, #BUFFSIZE), 0), #BUFFSIZE, 0))) ' 因为使用了 #FILE_FLAG_NO_BUFFERING
 ' 创建目标文件 并设置大小为目标文件大小
赋值 (局部_目标文件句柄, CreateFile (集_目标文件名, #GENERIC_WRITE, 0, 0, #CREATE_ALWAYS, 相加 (#FILE_FLAG_OVERLAPPED, #FILE_FLAG_NO_BUFFERING), 局部_源文件句柄))
.如果真 (等于 (局部_目标文件句柄, -1))
    赋值 (.禁止, 假)
    赋值 (.禁止, 真)
    赋值 (.禁止, 真)
    CloseHandle (局部_源文件句柄)
    返回 (局部_返回结果)
.如果真结束
SetFilePointerEx (局部_目标文件句柄, 局部_目标文件大小, 0, #FILE_BEGIN) ' 移动文件指针到需要设置的文件大小位置
SetEndOfFile (局部_目标文件句柄) ' 确定文件体积
 ' 本源码来自易语言资源网(www.5A5X.com)
赋值 (局部_完成端口句柄, CreateIoCompletionPort (-1, 0, 0, 0))
.如果真 (等于 (局部_完成端口句柄, 0))
    赋值 (.禁止, 假)
    赋值 (.禁止, 真)
    赋值 (.禁止, 真)
    返回 (局部_返回结果)
.如果真结束

 ' 关联设备 把 源文件 与目标文件 与 完成端口勾搭起来
CreateIoCompletionPort (局部_源文件句柄, 局部_完成端口句柄, #完成键_读, 0)
CreateIoCompletionPort (局部_目标文件句柄, 局部_完成端口句柄, #完成键_写, 0)

赋值 (局部_缓冲区, 取空白字节集 (#BUFFSIZE))
赋值 (局部_剩余未完成写次数, 1)
赋值 (局部_剩余未完成读次数, 0)
赋值 (局部_下次读写位置, 0)
PostQueuedCompletionStatus (局部_完成端口句柄, 0, #完成键_写, 局部_读写IO) ' 主动投递一个 写完成 的操作 来正式开启文件复制

.判断循环首 (或者 (大于 (局部_剩余未完成写次数, 0), 大于 (局部_剩余未完成读次数, 0)))
    赋值 (局部_读写TMP, 取整数型指针_黑月 (局部_读写IO.Internal))
    赋值 (局部_返回结果, GetQueuedCompletionStatus (局部_完成端口句柄, 局部_字节数, 局部_完成键, 局部_读写TMP, -1)) ' 等待完成端口消息
    .判断开始 (等于 (局部_完成键, #完成键_读)) ' 读完成消息
        赋值 (局部_剩余未完成读次数, 相减 (局部_剩余未完成读次数, 1))
        赋值 (局部_返回结果, WriteFile (局部_目标文件句柄, 局部_缓冲区, #BUFFSIZE, 0, 局部_读写IO))
        赋值 (局部_剩余未完成写次数, 相加 (局部_剩余未完成写次数, 1))
        
    .判断 (等于 (局部_完成键, #完成键_写))
        赋值 (局部_剩余未完成写次数, 相减 (局部_剩余未完成写次数, 1))
        .如果真 (小于 (局部_下次读写位置, 局部_目标文件大小)) ' 判断是否需要继续读
            赋值 (局部_读写IO.Offset, 局部_下次读写位置)
            赋值 (局部_返回结果, ReadFile (局部_源文件句柄, 局部_缓冲区, #BUFFSIZE, 0, 局部_读写IO))
            赋值 (局部_剩余未完成读次数, 相加 (局部_剩余未完成读次数, 1))
            赋值 (局部_下次读写位置, 相加 (局部_下次读写位置, #BUFFSIZE))
        .如果真结束
        赋值 (.内容, 到文本 (计算百分比 (局部_下次读写位置, 局部_目标文件大小)))
        
    .默认
        
    .判断结束
    
    .如果真 (等于 (集_命令, 2)) ' 暂停操作
        WaitForSingleObject (集_事件, -1)
    .如果真结束
    
    .如果真 (等于 (集_命令, 1)) ' 检查是否需要停止
        跳出循环 ()
    .如果真结束
    
.判断循环尾 ()
调试输出 (“end”)
赋值 (局部_返回结果, 真)
.如果真 (不等于 (集_命令, 1)) ' 不是停止操作
    SetFilePointerEx (局部_目标文件句柄, 局部_文件大小, 0, #FILE_BEGIN) ' 把目标文件体积设置为正确的体积
    SetEndOfFile (局部_目标文件句柄)
    赋值 (局部_返回结果, 假)
.如果真结束
CloseHandle (局部_完成端口句柄)
CloseHandle (局部_源文件句柄)
CloseHandle (局部_目标文件句柄)
' 本源码来自易语言资源网(www.5A5X.com)
.如果真 (等于 (集_命令, 1))
     ' 停止
    删除文件 (集_目标文件名)
.如果真结束
赋值 (.禁止, 假)
赋值 (.禁止, 真)
赋值 (.禁止, 真)
返回 (局部_返回结果)

.子程序 _按钮_开始复制_被单击, 空白型, , 
赋值 (.禁止, 真)
赋值 (集_命令, 0)
未知支持库函数_0 (&线程_复制文件, )

.子程序 _窗口1_将被销毁, 空白型, , 
CloseHandle (集_事件) ' 不用的时候得关闭句柄

.子程序 _按钮_停止_被单击, 空白型, , 
赋值 (.禁止, 真)
赋值 (.禁止, 真)
赋值 (.禁止, 真)
赋值 (.标题, “暂停”)
.如果真 (不等于 (集_命令, 0))
    SetEvent (集_事件) ' 如果是暂停状态停止 得把事件激活
.如果真结束
赋值 (集_命令, 1) ' 停止

.子程序 _按钮_暂停恢复_被单击, 空白型, , 
.如果 (等于 (.标题, “暂停”))
    赋值 (集_命令, 2) ' 暂停
    赋值 (.标题, “恢复”)
.否则
    赋值 (.标题, “暂停”)
    赋值 (集_命令, 0) ' 恢复
    SetEvent (集_事件) ' 把事件激活
.如果结束



 ' 不属于任何一个程序集、类模块的函数：
