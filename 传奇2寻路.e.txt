 ' 文件类型：Windows窗口程序

 ' 程序名称：
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 1010
    高度 = 716
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “”
    帮助文件名 = “”



.常量 路线, "1", , 
.常量 NPC, "2", , 
.常量 人物, "3", , 
.常量 怪物, "4", , 
.图片 地图, " ' 已保存到：D:\易语言学习\Data\传奇2寻路.e\地图", , 
.图片 调试地图, " ' 已保存到：D:\易语言学习\Data\传奇2寻路.e\调试地图", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' BmpOperate 42305932-06E6-47a5-AC79-8BDCDC58DF61 1 0 位图操作支持库




数据类型 坐标, , 
    .成员 X, 空白型, , , 
    .成员 Y, 空白型, , , 

数据类型 点, , 
    .成员 X, 空白型, , , 
    .成员 Y, 空白型, , , 
    .成员 类型, 空白型, , , 
    .成员 备注, 文本型, , , 


.DLL命令 取短整数型数组指针, 整数型, "kernel32", "lstrcpynA", , 
    .参数 lpString1, 短整数型, 传址 数组, 
    .参数 lpString2, 短整数型, 传址 数组, 
    .参数 iMaxLength, 整数型, , 

.DLL命令 API_复制内存, 整数型, "", "RtlMoveMemory", , 
    .参数 目标指针, 空白型, , 
    .参数 源指针, 空白型, , 
    .参数 长度, 空白型, , 

.DLL命令 API_画点, 整数型, "gdi32", "SetPixel", , 
    .参数 窗口句柄, 整数型, , 
    .参数 X, 整数型, , 
    .参数 Y, 整数型, , 
    .参数 颜色, 整数型, , 

.DLL命令 API_取组件场景, 整数型, "", "GetWindowDC", , 
    .参数 窗口句柄, 整数型, , 

.DLL命令 置窗口特征, 子程序指针, "", "SetWindowLongA", , 
    .参数 窗口句柄, 整数型, , 
    .参数 特征索引, 整数型, , 
    .参数 新特征, 子程序指针, , 

.DLL命令 执行窗口程序, 逻辑型, "", "CallWindowProcA", , 
    .参数 窗口程序程序指针, 子程序指针, , 
    .参数 窗口句柄, 整数型, , 
    .参数 消息, 整数型, , 
    .参数 参数1, 空白型, , 
    .参数 参数2, 空白型, , 

.DLL命令 API_释放场景, 整数型, "user32", "ReleaseDC", , 释放由调用GetDC或GetWindowDC函数获取的指定设备场景。它对类或私有设备场景无效（但这样的调用不会造成损害）  执行成功为1，否则为0
    .参数 窗口句柄, 整数型, , 要释放的设备场景相关的窗口句柄
    .参数 设备场景, 整数型, , 要释放的设备场景句柄;

.窗口程序集 窗口程序集1, , , 

.程序集变量 移动, 逻辑型, , , 
.程序集变量 地图图片, 字节集, , , 
.程序集变量 地图位图, 位图, , , 
.程序集变量 地图分析, 字节型, , "0", 128代表黑色(不可移动区)
.程序集变量 路线, 字节型, , "0", 从开始点至结束点的方向
.程序集变量 原地图标签指针, 子程序指针, , , 
.程序集变量 参与物, 点, , "0", 人、NPC、怪物、路线等
.程序集变量 场景句柄, 空白型, , , 
.子程序 __启动窗口_创建完毕, 空白型, , 
.局部变量 X, 空白型, , , 
.局部变量 Y, 空白型, , , 
.局部变量 当前X, 空白型, , , 
.局部变量 当前Y, 空白型, , , 

赋值 (地图图片, #地图)
地图位图.载入数据 (#地图)
赋值 (X, 地图位图.取宽度 ())
赋值 (Y, 地图位图.取高度 ())
重定义数组 (地图分析, 假, X, Y)
.计次循环首 (Y, 当前Y)
    .计次循环首 (X, 当前X)
        .如果真 (等于 (地图位图.取某点颜色 (相减 (当前X, 1), 相减 (当前Y, 1)), #黑色))
            赋值 (地图分析 [当前X] [当前Y], 128)
        .如果真结束
        
    .计次循环尾 ()
.计次循环尾 ()
赋值 (.底图, #地图)
.置父窗口 ()
赋值 (.左边, 0)
赋值 (.顶边, 0)
赋值 (.宽度, X)
赋值 (.高度, Y)
赋值 (原地图标签指针, 置窗口特征 (取窗口句柄 (), -4, &消息处理))

.子程序 _地图标签_鼠标左键被按下, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

赋值 (移动, 真)

.子程序 _地图标签_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

.如果 (移动)
    161.发送信息 (2, 0)
.否则
    赋值 (_启动窗口., 相加 (“当前位置:”, 到文本 (横向位置), “,”, 到文本 (纵向位置)))
.如果结束


.子程序 _地图标签_鼠标左键被放开, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

赋值 (移动, 假)

.子程序 寻路, 逻辑型, , 
.参数 开始X, 整数型, , 
.参数 开始Y, 整数型, , 
.参数 结束X, 整数型, , 
.参数 结束Y, 整数型, , 

.局部变量 X, 短整数型, , , 
.局部变量 Y, 短整数型, , , 
.局部变量 当前X, 短整数型, , , 
.局部变量 当前Y, 短整数型, , , 
.局部变量 坐标X表, 短整数型, , "0", 
.局部变量 坐标Y表, 短整数型, , "0", 与坐标X表变量配套使用
.局部变量 坐标表数, 短整数型, , , 与坐标X表变量配套使用
.局部变量 坐标X表指针, 空白型, , , 与坐标X表变量配套使用
.局部变量 坐标Y表指针, 空白型, , , 与坐标X表变量配套使用
.局部变量 新坐标X表, 短整数型, , "0", 
.局部变量 新坐标Y表, 短整数型, , "0", 与新坐标X表变量配套使用
.局部变量 新坐标表数, 短整数型, , , 与新坐标X表变量配套使用
.局部变量 新坐标X表指针, 空白型, , , 与新坐标X表变量配套使用
.局部变量 新坐标Y表指针, 空白型, , , 与新坐标X表变量配套使用
.局部变量 I1, 空白型, , , 
.局部变量 I2, 空白型, , , 
.局部变量 当前地图分析, 字节型, , "0", 
.局部变量 方向, 字节型, , , 
.局部变量 点, 点, , , 

赋值 (当前地图分析, 地图分析)
赋值 (X, 取数组下标 (地图分析, 1))
赋值 (Y, 取数组下标 (地图分析, 2))
.判断开始 (或者 (小于 (开始X, 1), 大于 (开始X, X), 小于 (开始Y, 1), 大于 (开始Y, Y), 小于 (结束X, 1), 大于 (结束X, X), 小于 (结束Y, 1), 大于 (结束Y, Y)))
    
.判断 (或者 (等于 (当前地图分析 [开始X] [开始Y], 128), 等于 (当前地图分析 [结束X] [结束Y], 128)))
    
.默认
    赋值 (I1, 相乘 (相加 (X, Y), 2))
    重定义数组 (坐标X表, 假, I1)
    重定义数组 (坐标Y表, 假, I1)
    重定义数组 (新坐标X表, 假, I1)
    重定义数组 (新坐标Y表, 假, I1)
    赋值 (坐标X表指针, 取短整数型数组指针 (坐标X表, 坐标X表, 0))
    赋值 (坐标Y表指针, 取短整数型数组指针 (坐标Y表, 坐标Y表, 0))
    赋值 (新坐标X表指针, 取短整数型数组指针 (新坐标X表, 新坐标X表, 0))
    赋值 (新坐标Y表指针, 取短整数型数组指针 (新坐标Y表, 新坐标Y表, 0))
    赋值 (坐标表数, 1)
    赋值 (坐标X表 [1], 结束X)
    赋值 (坐标Y表 [1], 结束Y)
    .循环判断首 ()
        .计次循环首 (坐标表数, I1)
            .计次循环首 (8, I2) ' 8个方向
                赋值 (当前X, 相加 (坐标X表 [I1], 多项选择 (I2, 0, 1, 1, 1, 0, -1, -1, -1)))
                赋值 (当前Y, 相加 (坐标Y表 [I1], 多项选择 (I2, -1, -1, 0, 1, 1, 1, 0, -1)))
                .判断开始 (等于 (当前地图分析 [当前X] [当前Y], 0))
                    .如果 (或者 (不等于 (当前X, 开始X), 不等于 (当前Y, 开始Y)))
                        赋值 (当前地图分析 [当前X] [当前Y], 相加 (I2, 10))
                        赋值 (新坐标表数, 相加 (新坐标表数, 1))
                        赋值 (新坐标X表 [新坐标表数], 当前X)
                        赋值 (新坐标Y表 [新坐标表数], 当前Y)
                    .否则
                        赋值 (当前地图分析 [当前X] [当前Y], I2)
                        赋值 (I1, 1)
                        .判断循环首 (大于或等于 (取数组成员数 (参与物), I1))
                            .如果 (等于 (参与物 [I1], 类型, #路线))
                                删除成员 (参与物, I1, )
                            .否则
                                赋值 (I1, 相加 (I1, 1))
                            .如果结束
                            
                        .判断循环尾 ()
                        清除数组 (路线)
                        赋值 (X, 开始X)
                        赋值 (Y, 开始Y)
                        赋值 (点.类型, #路线)
                        .循环判断首 ()
                            赋值 (方向, 当前地图分析 [X] [Y])
                            加入成员 (路线, 方向)
                            赋值 (点.X, X)
                            赋值 (点.Y, Y)
                            插入成员 (参与物, 1, 点)
                            赋值 (X, 相加 (X, 多项选择 (方向, 0, -1, -1, -1, 0, 1, 1, 1)))
                            赋值 (Y, 相加 (Y, 多项选择 (方向, 1, 1, 0, -1, -1, -1, 0, 1)))
                        .循环判断尾 (或者 (不等于 (X, 结束X), 不等于 (Y, 结束Y)))
                        重画 ()
                        返回 (真)
                    .如果结束
                    
                .判断 (并且 (大于 (当前地图分析 [当前X] [当前Y], 10), 小于 (当前地图分析 [当前X] [当前Y], 20), 等于 (求余数 (当前地图分析 [当前X] [当前Y], 2), 0)))
                    赋值 (当前地图分析 [当前X] [当前Y], 相加 (I2, 10))
                .默认
                    
                .判断结束
                
            .计次循环尾 ()
        .计次循环尾 ()
        .计次循环首 (新坐标表数, I1)
            赋值 (当前地图分析 [新坐标X表] [I1] [新坐标Y表] [I1], 相减 (当前地图分析 [新坐标X表] [I1] [新坐标Y表] [I1], 10))
        .计次循环尾 ()
        API_复制内存 (坐标X表指针, 新坐标X表指针, 相乘 (新坐标表数, 2))
        API_复制内存 (坐标Y表指针, 新坐标Y表指针, 相乘 (新坐标表数, 2))
        赋值 (坐标表数, 新坐标表数)
        赋值 (新坐标表数, 0)
    .循环判断尾 (大于 (坐标表数, 0))
.判断结束
返回 (假)

.子程序 重画参与物, 空白型, , 
.局部变量 场景句柄, 空白型, , , 
.局部变量 I, 空白型, , , 

赋值 (场景句柄, API_取组件场景 (取窗口句柄 ()))
.计次循环首 (取数组成员数 (参与物), I)
    API_画点 (场景句柄, 相减 (参与物 [I], X, 1), 相减 (参与物 [I], Y, 1), 多项选择 (参与物 [I], 类型, #蓝色, #黄色, #人物, #怪物))
.计次循环尾 ()
API_释放场景 (取窗口句柄 (), 场景句柄)

.子程序 _说明按钮_被单击, 空白型, , 
信息框 (“移动地图：在地图是按住鼠标键不放，再移动鼠标。”, 0, “提示：”)

.子程序 消息处理, 空白型, , 
.参数 句柄, 空白型, , 
.参数 消息号, 空白型, , 
.参数 参数1, 空白型, , 
.参数 参数2, 空白型, , 

执行窗口程序 (原地图标签指针, 句柄, 消息号, 参数1, 参数2)
.如果真 (等于 (消息号, 15))
    重画参与物 ()
.如果真结束


.子程序 _寻路按钮_被单击, 空白型, , 
.局部变量 耗时, 空白型, , , 
.局部变量 结果, 逻辑型, , , 

赋值 (耗时, 取启动时间 ())
赋值 (结果, 寻路 (到整数 (.内容), 到整数 (.内容), 到整数 (.内容), 到整数 (.内容)))
赋值 (耗时, 相减 (取启动时间 (), 耗时))
.如果 (结果)
    信息框 (相加 (“耗时：”, 到文本 (耗时), “毫秒。注：本寻代码还可以再优化”), 0, )
.否则
    信息框 (“该区域不可到达！”, 0, )
.如果结束



 ' 不属于任何一个程序集、类模块的函数：
