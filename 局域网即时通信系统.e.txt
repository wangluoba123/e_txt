 ' 文件类型：Windows窗口程序

 ' 程序名称：局域网即时通信(IIM)v0.1
 ' 程序描述：局域网内即时通信软件。
    本程序由易语言编写,易语言网址为:http://www.dywt.com.cn
    易语言公司授权正版用户可以任意使用本程序.
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.1
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 639
    高度 = 480
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 假
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 假
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 真
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “”
    帮助文件名 = “”

窗口 窗口关于
    左边 = 50
    顶边 = 50
    宽度 = 245
    高度 = 130
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 6
    底图方式 = 1
    底色 = 15266036 '  0xE8F0F4
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “关于Intranet Instant Message”
    帮助文件名 = “”



.图片 主图标, " ' 已保存到：D:\易语言学习\Data\局域网即时通信系统.e\主图标", , 
.常量 边界宽度, "1", , 
.常量 程序标题, "“局域网即时通信(IIM)v0.1”", , 
.常量 关于信息, "“本程序使用易语言编程,易语言下载网址为:http://www.dywt.com.cn”", , 
.常量 错误符号, "“×××”", , 
.常量 五角星, "“★★★”", , 
.常量 分隔符, "“--------------------------------------------------------”", , 
.常量 恢复窗口, "9", , 
.常量 最小化窗口, "6", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 2 系统核心支持库
 ' iext2 AF6AD80AA4244A59AFB3D83ECF5173CC 1 1 扩展界面支持库二




数据类型 点, , 
    .成员 左, 整数型, , , 
    .成员 上, 整数型, , , 

.全局变量 IP段, 文本型, , , 
.全局变量 最大IP, 整数型, , , 
.全局变量 已取消, 逻辑型, , , 
.全局变量 正在刷新计算机列表, 逻辑型, , , 
.全局变量 本机名, 文本型, , , 
.全局变量 本机地址, 文本型, , , 
.全局变量 端口号, 整数型, , , 
.全局变量 是隐藏, 逻辑型, , , 
.全局变量 全局原子, 整数型, , , 

.DLL命令 置为活动窗口, 空白型, "", "SetForegroundWindow", , 
    .参数 窗口句柄, 整数型, , 

.DLL命令 显示窗口, 空白型, "", "ShowWindow", , 
    .参数 窗口句柄, 整数型, , 
    .参数 显示状态, 整数型, , 

.DLL命令 取光标位置, 空白型, "", "GetCursorPos", , 
    .参数 dian, 点, , 

.DLL命令 全局查找原子, 整数型, "", "GlobalFindAtomA", , 成功返回原子，失败返回0
    .参数 文本, 文本型, , 

.DLL命令 全局添加原子, 整数型, "", "GlobalAddAtomA", , 
    .参数 文本, 文本型, , 

.DLL命令 全局删除原子, 整数型, "", "GlobalDeleteAtom", , 如果成功，返回0
    .参数 原子, 整数型, , 

.窗口程序集 启动窗口程序集, , , 

.子程序 是否已在运行, 空白型, , 
.局部变量 结果, 整数型, , , 

赋值 (全局原子, 全局查找原子 (“iim.net.goomoo”))
.如果 (并且 (不等于 (全局原子, 1179648), 不等于 (全局原子, 0)))
    信息框 (“程序已在运行，请双击任务栏小图标。”, 相加 (#确认钮, #信息图标), #程序标题)
    结束 ()
.否则
    
.如果结束
赋值 (全局原子, 全局添加原子 (“iim.net.goomoo”))

.子程序 刷新计算机列表, 空白型, , 
.局部变量 i, 整数型, , , 
.局部变量 IP地址, 文本型, , , 
.局部变量 主机名, 文本型, , , 

赋值 (.标题, “正在刷新计算机列表，请稍候。”)
置等待鼠标 ()
赋值 (.可视, 真)
清空 ()
赋值 (正在刷新计算机列表, 真)
赋值 (., 假)
赋值 (., 真)
五角星信息 (“正在刷新计算机列表，请稍候……”)
.计次循环首 (最大IP, i)
    赋值 (IP地址, 相加 (IP段, 到文本 (i)))
    处理事件 ()
    .如果真 (不等于 (通信测试 (IP地址, 50), -1))
        赋值 (主机名, 转换为主机名 (IP地址))
        .如果真 (不等于 (主机名, “”))
            主机名.加入项目 (i)
        .如果真结束
        
    .如果真结束
    处理事件 ()
    赋值 (.位置, i)
    .如果真 (已取消)
        五角星信息 (“已取消刷新计算机列表。”)
        跳出循环 ()
    .如果真结束
    .如果真 (等于 (i, 255))
        五角星信息 (“计算机列表刷新完毕。”)
    .如果真结束
    
.计次循环尾 ()
赋值 (.标题, “”)
赋值 (.可视, 假)
恢复鼠标 ()
赋值 (正在刷新计算机列表, 假)
赋值 (., 真)
赋值 (., 假)
赋值 (已取消, 假)

.子程序 错误信息, 空白型, , 
.参数 信息, 文本型, , 

相加 (#换行符, #错误符号, 信息, #错误符号).加入文本 ()

.子程序 五角星信息, 空白型, , 
.参数 信息, 文本型, , 

相加 (#换行符, #五角星, 信息, #五角星).加入文本 ()

.子程序 普通信息, 空白型, , 
.参数 信息, 文本型, , 

相加 (#换行符, 信息).加入文本 ()

.子程序 置状态条文本, 空白型, , 
.参数 文本, 文本型, , 

.如果 (正在刷新计算机列表)
    赋值 (.标题, 相加 (文本, “正在刷新计算机列表，请稍候……”))
.否则
    赋值 (.标题, 文本)
.如果结束


.子程序 取IP段, 空白型, , 
.局部变量 IP, 文本型, , , 
.局部变量 段组, 文本型, , "3", 

赋值 (IP, 转换为IP地址 (取主机名 ()))
赋值 (段组, 分割文本 (IP, “.”, 4))
赋值 (IP段, 相加 (段组 [1], “.”, 段组 [2], “.”, 段组 [3], “.”))
输出调试文本 (IP段)

.子程序 设为自动运行, 空白型, , 
.局部变量 命令行, 文本型, , , 

写注册项 (#本地机器, “SOFTWARE\Microsoft\Windows\CurrentVersion\Run\iim”, 相加 (取运行目录 (), “\”, 取执行文件名 ()))

.子程序 IIM发送信息, 空白型, , 
.参数 目标计算机名, 文本型, , 
.参数 欲发送的信息, 文本型, , 

.局部变量 目的地址, 文本型, , , 
.局部变量 数据, 文本型, , , 

.如果真 (等于 (目标计算机名, “”))
    错误信息 (“未指定目标计算机！”)
    返回 ()
.如果真结束
.如果真 (等于 (欲发送的信息, “”))
    错误信息 (“发送内容不能为空！”)
    返回 ()
.如果真结束
赋值 (目的地址, 转换为IP地址 (.内容))
.如果真 (等于 (目的地址, “”))
    错误信息 (相加 (“找不到目标计算机|”, 目标计算机名, “|！”))
    返回 ()
.如果真结束

赋值 (数据, 相加 (“|”, 本机名, “|于”, 到文本 (取现行时间 ()), “给您发送的信息：”))
赋值 (数据, 相加 (数据, #换行符, 欲发送的信息, “――”, .内容))
.如果 (目的地址.发送数据 (端口号, 数据))
    普通信息 (#分隔符)
    普通信息 (相加 (“您于”, 到文本 (取现行时间 ()), “发送给|”, 目标计算机名, “|的信息：”))
    普通信息 (欲发送的信息)
    五角星信息 (“信息已发送到目标计算机。”)
    赋值 (.内容, “”)
.否则
    错误信息 (“信息发送错误！”)
.如果结束


.子程序 广播信息, 空白型, , 
.局部变量 i, 整数型, , , 
.局部变量 被发送到的计算机名, 文本型, , , 
.局部变量 数据, 文本型, , , 
.局部变量 计算机数目, 整数型, , , 
.局部变量 目标地址, 文本型, , , 
.局部变量 目标计算机名, 文本型, , , 

.如果真 (等于 (.内容, “”))
    错误信息 (“发送内容不能为空！”)
    返回 ()
.如果真结束
赋值 (数据, 相加 (“|”, 本机名, “|于”, 到文本 (取现行时间 ()), “发布的广播信息：”))
赋值 (数据, 相加 (数据, #换行符, .内容, “――”, .内容))
赋值 (计算机数目, 取项目数 ())
赋值 (被发送到的计算机名, “|”)
.计次循环首 (计算机数目, i)
    赋值 (目标计算机名, 相减 (i, 1).取项目文本 ())
    赋值 (目标地址, 转换为IP地址 (目标计算机名))
    .如果真 (不等于 (目标地址, “”))
        .如果真 (目标地址.发送数据 (端口号, 数据))
            赋值 (被发送到的计算机名, 相加 (被发送到的计算机名, 目标计算机名, “|”))
        .如果真结束
        
    .如果真结束
    
.计次循环尾 ()
五角星信息 (相加 (“广播消息被发送到下列计算机：”, 被发送到的计算机名))
赋值 (.内容, “”)

.子程序 信使服务发送, 空白型, , 
.局部变量 命令文本, 文本型, , , 
.局部变量 文件号, 整数型, , , 
.局部变量 反馈信息, 文本型, , , 
.局部变量 目标计算机, 文本型, , , 


赋值 (目标计算机, .内容)
.如果真 (等于 (目标计算机, “”))
    错误信息 (“未指定目标计算机！”)
    返回 ()
.如果真结束
.如果真 (等于 (.内容, “”))
    错误信息 (“发送内容不能为空！”)
    返回 ()
.如果真结束
赋值 (., 真)
普通信息 (#分隔符)
普通信息 (相加 (“您于”, 到文本 (取现行时间 ()), “通过信使服务发送给|”, 目标计算机, “|的信息：”))
普通信息 (.内容)
赋值 (命令文本, 相加 (“cmd /c net send ”, 目标计算机, “ ”, #引号, .内容, “――”, .内容, #引号, “>c:\~iim.dat”))
五角星信息 (“正在通过信使服务发送信息，请稍候……”)
置等待鼠标 ()
运行 (命令文本, 真, #隐藏窗口)
恢复鼠标 ()
赋值 (文件号, 打开文件 (“c:\~iim.dat”, #读入, #禁止写))
赋值 (反馈信息, 读入文本 (文件号, ))
关闭文件 (文件号)
删除文件 (“c:\~iim.dat”)

输出调试文本 (反馈信息)
.如果 (等于 (寻找文本 (反馈信息, “错”, , 假), -1))
    五角星信息 (相加 (“信息已成功发送到计算机|”, 目标计算机, “|”))
    赋值 (.内容, “”)
    
.否则
    错误信息 (相加 (“使用信使服务发送信息到计算机|”, 目标计算机, “|失败！”))
.如果结束
赋值 (., 假)

.子程序 关于, 空白型, , 
载入 (窗口关于, _启动窗口, 假)

.子程序 激活主窗口, 空白型, , 
显示窗口 (_启动窗口.取窗口句柄 (), #恢复窗口)
置为活动窗口 (_启动窗口.取窗口句柄 ())
赋值 (是隐藏, 假)

.子程序 最小化主窗口, 空白型, , 
显示窗口 (_启动窗口.取窗口句柄 (), #最小化窗口)
赋值 (_启动窗口., 假)
赋值 (是隐藏, 真)

.子程序 __启动窗口_创建完毕, 空白型, , 
是否已在运行 ()

赋值 (_启动窗口., 相减 (_启动窗口., 22))
赋值 (.标题, 相加 (#程序标题, “--”, #关于信息))

取IP段 ()
赋值 (最大IP, 255)
赋值 (端口号, 760923)
赋值 (本机名, 取主机名 ())
赋值 (本机地址, 转换为IP地址 (本机名))
赋值 (.最大位置, 最大IP)
赋值 (已取消, 假)
赋值 (正在刷新计算机列表, 假)
赋值 (.内容, 相加 (“★★★欢迎使用局域网即时通信系统★★★”, 字符 (13), 字符 (10), “★★★作者：曾劲松 网站：www.goomoo.net★★★”))

赋值 (.端口, 端口号)
 ' 设为自动运行 ()
.如果真 (不等于 (取操作系统类别 (), 3))
    赋值 (., 真)
.如果真结束


.子程序 __启动窗口_托盘事件, 空白型, , 
.参数 操作类型, 整数型, , 

.如果真 (等于 (操作类型, 2))
    .如果 (是隐藏)
        激活主窗口 ()
    .否则
        最小化主窗口 ()
    .如果结束
    
.如果真结束
.如果真 (等于 (操作类型, 3))
    _启动窗口.弹出托盘菜单 ()
.如果真结束


.子程序 _编辑框发送信息_按下某键, 逻辑型, , 
.参数 键代码, 整数型, , 
.参数 功能键状态, 整数型, , 

.如果真 (并且 (等于 (键代码, #回车键), 等于 (功能键状态, #Ctrl键状态)))
    IIM发送信息 (.内容, .内容)
.如果真结束


.子程序 _退出_被选择, 空白型, , 
全局删除原子 (全局原子)
结束 ()

.子程序 __启动窗口_首次激活, 空白型, , 
_启动窗口.置托盘图标 (#主图标, #程序标题)
最小化主窗口 ()
刷新计算机列表 ()

.子程序 _编辑框发送信息_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

置状态条文本 (“在此输入信息，按Ctrl+Enter发送。”)

.子程序 _计算机列表框_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

置状态条文本 (“在此选择目标计算机。”)

.子程序 _编辑框信息历史_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

置状态条文本 (“信息历史。”)

.子程序 _编辑框目标计算机_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

置状态条文本 (“此为目标计算机名，可以手动输入。”)

.子程序 __启动窗口_按下某键, 逻辑型, , 
.参数 键代码, 整数型, , 
.参数 功能键状态, 整数型, , 

.如果真 (等于 (键代码, #Esc键))
    赋值 (已取消, 真)
.如果真结束


.子程序 _计算机列表框_列表项被选择, 空白型, , 
赋值 (.内容, 取焦点项目 ().取项目文本 ())

.子程序 _数据报_数据到达, 空白型, , 
.局部变量 信息, 文本型, , , 
.局部变量 源计算机名, 文本型, , , 
.局部变量 文本组, 文本型, , "3", 

赋值 (信息, 取字节集数据 (取回数据 (), #文本型))
赋值 (文本组, 分割文本 (信息, “|”, 3))
赋值 (.内容, 文本组 [2])
普通信息 (#分隔符)
普通信息 (信息)
显示窗口 (_启动窗口.取窗口句柄 (), #恢复窗口)
置为活动窗口 (_启动窗口.取窗口句柄 ())

.子程序 _显示主窗口_被选择, 空白型, , 
激活主窗口 ()

.子程序 _关于IIM_被选择, 空白型, , 
关于 ()

.子程序 _编辑框签名_获得焦点, 空白型, , 
赋值 (.起始选择位置, 0)
赋值 (.被选择字符数, 取文本长度 (.内容))

.子程序 _编辑框签名_鼠标左键被放开, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

赋值 (.起始选择位置, 0)
赋值 (.被选择字符数, 取文本长度 (.内容))

.子程序 _标签关于_鼠标左键被放开, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

关于 ()

.子程序 退出, 空白型, , 
.局部变量 结果, 整数型, , , 

赋值 (结果, 信息框 (“您确定要退出吗？ 如果退出，你将不能收到别人发送给您的信息！”, 相加 (#是否钮, #询问图标, 256), “确认退出”))
.如果真 (等于 (结果, #是钮))
    全局删除原子 (全局原子)
    结束 ()
.如果真结束


.子程序 _按钮刷新计算机列表_被单击, 空白型, , 
刷新计算机列表 ()

.子程序 _按钮取消刷新_被单击, 空白型, , 
赋值 (已取消, 真)

.子程序 _按钮退出_被单击, 空白型, , 
退出 ()

.子程序 _按钮清空历史信息_被单击, 空白型, , 
赋值 (.内容, 相加 (“★★★欢迎使用局域网即时通信系统★★★”, #换行符, “★★★作者：曾劲松 网站：www.goomoo.net★★★”, #换行符))
.如果真 (正在刷新计算机列表)
    “正在刷新计算机列表，请稍候……”.加入文本 ()
.如果真结束


.子程序 _按钮保存信息历史_被单击, 空白型, , 
.局部变量 文件号, 整数型, , , 
.局部变量 文件名, 文本型, , , 

.如果真 (打开 ())
    赋值 (文件名, .文件名)
    赋值 (文件号, 打开文件 (文件名, #改写, #禁止写))
    .如果 (写出文本 (文件号, .内容))
        五角星信息 (“保存文件完毕。”)
    .否则
        错误信息 (“保存文件错误！”)
    .如果结束
    关闭文件 (文件号)
.如果真结束


.子程序 _按钮发送信息_被单击, 空白型, , 
IIM发送信息 (.内容, .内容)


.子程序 _按钮广播信息_被单击, 空白型, , 
广播信息 ()

.子程序 _按钮信使发送_被单击, 空白型, , 
信使服务发送 ()

.子程序 _按钮最小化_被单击, 空白型, , 
最小化主窗口 ()

.子程序 __启动窗口_将被销毁, 空白型, , 
.局部变量 结果, 整数型, , , 

全局删除原子 (全局原子)

.窗口程序集 窗口关于程序集, , , 

.子程序 _窗口关于_创建完毕, 空白型, , 
赋值 (.内容, 相加 (#程序标题, #换行符, #关于信息, #换行符, “本程序使用易语言开发。”))



 ' 不属于任何一个程序集、类模块的函数：
