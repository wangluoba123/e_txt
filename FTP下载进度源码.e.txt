 ' 文件类型：Windows窗口程序

 ' 程序名称：
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 469
    高度 = 387
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假

窗口 保存窗口
    左边 = 50
    顶边 = 50
    宽度 = 315
    高度 = 286
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “保存”
    帮助文件名 = “”

窗口 窗口1
    左边 = 50
    顶边 = 50
    宽度 = 380
    高度 = 143
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “文件已经存在！”
    帮助文件名 = “”





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 5 0 系统核心支持库





.窗口程序集 窗口程序集1, , , 云外归鸟2004年3月8日作

.程序集变量 源文件, 文本型, , , 
.程序集变量 目标文件, 文本型, , , 
.程序集变量 文件号, 空白型, , , 
.程序集变量 接收字节数, 空白型, , , 
.程序集变量 源文件长, 空白型, , , 
.程序集变量 续传, 逻辑型, , , 
.程序集变量 目标文件长, 空白型, , , 
.程序集变量 取消, 逻辑型, , , 
.程序集变量 FTP, 文本型, , , 
.程序集变量 服务器URL, 文本型, , , 
.程序集变量 开始时间, 空白型, , , 
.程序集变量 用户名, 文本型, , , 
.程序集变量 密码, 文本型, , , 
.程序集变量 有密码, 逻辑型, , , 
.程序集变量 运行中, 逻辑型, , , 
.程序集变量 头信息, 文本型, , , 
.程序集变量 命令句, 文本型, , , 
.程序集变量 服务器, 文本型, , , 
.子程序 _按钮1_被单击, 空白型, , 
.局部变量 位置末, 空白型, , , 
.局部变量 位置首, 空白型, , , 
.局部变量 命令, 文本型, , , 
.局部变量 开始时, 空白型, , , 

赋值 (FTP, 删首尾空 (.))
赋值 (位置首, 寻找文本 (FTP, “ftp://”, , 真))
.如果 (不等于 (位置首, -1))
     ' 取服务器名、用户名和密码
    赋值 (位置首, 相加 (位置首, 6))
    赋值 (位置末, 寻找文本 (FTP, “/”, 位置首, 假))
    .如果真 (等于 (位置末, -1))
        信息框 (“输入的网址不正确！”, #错误图标, “错误”)
        返回 ()
    .如果真结束
    赋值 (服务器URL, 取文本中间 (FTP, 位置首, 相减 (位置末, 位置首)))
    赋值 (源文件, 相加 (“/”, 取文本右边 (FTP, 相减 (取文本长度 (FTP), 位置末))))
    赋值 (位置首, 寻找文本 (服务器URL, “@”, , 真))
    .如果 (不等于 (位置首, -1))
        赋值 (用户名, 取文本左边 (服务器URL, 相减 (位置首, 1)))
        赋值 (服务器URL, 取文本右边 (服务器URL, 相减 (取文本长度 (服务器URL), 位置首)))
        赋值 (位置末, 寻找文本 (用户名, “:”, , 真))
        .如果真 (等于 (位置末, -1))
            信息框 (“输入的网址不正确！”, #错误图标, “错误”)
            返回 ()
        .如果真结束
        赋值 (密码, 取文本右边 (用户名, 相减 (取文本长度 (用户名), 位置末)))
        赋值 (用户名, 取文本左边 (用户名, 相减 (位置末, 1)))
        赋值 (有密码, 真)
        赋值 (., 用户名)
        赋值 (., 密码)
        赋值 (., 真)
    .否则
        .如果 (并且 (., 不等于 (., “”), 不等于 (., “”)))
            赋值 (用户名, .)
            赋值 (密码, .)
            赋值 (有密码, 真)
        .否则
            赋值 (., “”)
            赋值 (., “”)
            赋值 (用户名, “anonymous”)
            赋值 (密码, “youname”)
            赋值 (有密码, 假)
        .如果结束
        
    .如果结束
    载入 (保存窗口, , 真)
    
    .如果真 (取消)
        返回 ()
    .如果真结束
    .如果真 (续传)
        赋值 (目标文件长, 取文件尺寸 (目标文件))
    .如果真结束
    信息条 (相加 (“正在连接 ”, 服务器URL, “:21”), 假)
    清空 ()
    .如果 (服务器URL.连接 (21))
        赋值 (运行中, 真)
        赋值 (., 真)
        赋值 (., 假)
        赋值 (开始时间, 取启动时间 ())
        赋值 (., 1000)
        赋值 (., “连接状态：成功”)
        信息条 (“Socket 已经连接，等待欢迎信息”, 假)
        .判断循环首 (等于 (下载 (), 假))
            .如果真 (等于 (运行中, 假))
                跳出循环 ()
            .如果真结束
            赋值 (开始时, 取启动时间 ())
            信息条 (“等待5秒后重试”, 假)
            .判断循环首 (小于 (相减 (取启动时间 (), 开始时间), 5000))
                处理事件 ()
            .判断循环尾 ()
            .如果 (服务器URL.连接 (21))
                信息条 (“Socket 已经连接，等待欢迎信息”, 假)
            .否则
                信息条 (“Socket 连接失败”, 假)
                跳出循环 ()
            .如果结束
            处理事件 ()
        .判断循环尾 ()
    .否则
        赋值 (., “连接状态：失败”)
        信息条 (“Socket 连接失败”, 假)
        
    .如果结束
    
.否则
    信息框 (“输入的网址不正确！”, #错误图标, “错误”)
.如果结束


.子程序 _客户通信端_数据到达, 空白型, , 
.局部变量 数据包, 字节集, , , 

赋值 (数据包, 取回数据 ())
赋值 (命令句, 到文本 (数据包))
赋值 (头信息, 取文本左边 (命令句, 3))



.子程序 __启动窗口_将被销毁, 空白型, , 
断开连接 ()
服务器.断开客户 ()
断开连接 ()
赋值 (运行中, 假)
赋值 (., 0)
关闭所有文件 ()

.子程序 _客户通信端_连接断开, 空白型, , 
.如果真 (等于 (头信息, “266”))
    信息条 (“文件下载完毕”, 真)
.如果真结束
断开连接 ()


.子程序 _按钮3_被单击, 空白型, , 
断开连接 ()
服务器.断开客户 ()
断开连接 ()
赋值 (运行中, 假)
赋值 (续传, 真)
赋值 (., “暂停”)
信息条 (相加 (“文件下载暂停在”, 到文本 (接收字节数), “bytes”), 假)
赋值 (., 假)
赋值 (., 真)
关闭文件 (文件号)


.子程序 _按钮2_被单击, 空白型, , 
.局部变量 命令, 文本型, , , 
.局部变量 开始时, 空白型, , , 

.如果 (服务器URL.连接 (80))
    赋值 (., 真)
    赋值 (., 假)
    赋值 (运行中, 真)
    信息条 (“Socket 已经连接，等待欢迎信息”, 假)
    赋值 (., “连接状态：成功”)
    赋值 (目标文件长, 取文件尺寸 (目标文件))
    .判断循环首 (等于 (下载 (), 假))
        .如果真 (等于 (运行中, 假))
            跳出循环 ()
        .如果真结束
        赋值 (开始时, 取启动时间 ())
        信息条 (“等待5秒后重试”, 假)
        .判断循环首 (小于 (相减 (取启动时间 (), 开始时间), 5000))
            处理事件 ()
        .判断循环尾 ()
        .如果 (服务器URL.连接 (21))
            信息条 (“Socket 已经连接，等待欢迎信息”, 假)
        .否则
            信息条 (“Socket 连接失败”, 假)
            跳出循环 ()
        .如果结束
        处理事件 ()
    .判断循环尾 ()
    
.否则
    信息条 (“Socket 连接失败”, 假)
    赋值 (., “连接状态：失败”)
.如果结束


.子程序 _按钮4_被单击, 空白型, , 
赋值 (运行中, 假)
赋值 (., 假)
赋值 (., 真)
赋值 (., 真)
断开连接 ()
服务器.断开客户 ()
断开连接 ()
赋值 (., 0)
赋值 (., 0)
关闭文件 (文件号)
赋值 (续传, 假)


.子程序 _时钟1_周期事件, 空白型, , 
.局部变量 上次值, 空白型, 静态, , 
.局部变量 速度, 空白型, , , 

.如果真 (运行中)
    .如果 (等于 (上次值, 0))
        赋值 (., “0k/s”)
    .否则
        赋值 (速度, 相减 (接收字节数, 上次值))
        赋值 (., 相加 (到文本 (四舍五入 (相除 (速度, 1024), 1)), “k/s”))
    .如果结束
    赋值 (上次值, 接收字节数)
    .如果真 (不等于 (速度, 0))
        赋值 (., 时间格式 (整除 (相减 (源文件长, 接收字节数), 速度)))
        
    .如果真结束
    
.如果真结束
赋值 (., 时间格式 (整除 (相减 (取启动时间 (), 开始时间), 1000)))


.子程序 时间格式, 文本型, , 
.参数 秒数, 空白型, , 

.局部变量 时值, 文本型, , , 
.局部变量 分值, 文本型, , , 
.局部变量 秒值, 文本型, , , 

赋值 (时值, 相加 (“0”, 到文本 (整除 (秒数, 3600))))
赋值 (分值, 到文本 (整除 (求余数 (秒数, 3600), 60)))
.如果真 (等于 (取文本长度 (分值), 1))
    赋值 (分值, 相加 (“0”, 分值))
.如果真结束
赋值 (秒值, 到文本 (求余数 (秒数, 3600, 60)))
.如果真 (等于 (取文本长度 (秒值), 1))
    赋值 (秒值, 相加 (“0”, 秒值))
.如果真结束
返回 (相加 (时值, “:”, 分值, “:”, 秒值))


.子程序 _编辑框1_鼠标右键被按下, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

赋值 (., -1)


.子程序 _选择框1_被单击, 空白型, , 
.如果 (.)
    赋值 (., 假)
    赋值 (., 假)
    赋值 (., #白色)
    赋值 (., #白色)
.否则
    赋值 (., 真)
    赋值 (., 真)
    赋值 (., #默认色)
    赋值 (., #默认色)
.如果结束


.子程序 信息条, 空白型, , 
.参数 信息文本, 文本型, , 
.参数 服务器端, 逻辑型, , 

.如果 (服务器端)
    相加 (“服务器：  ”, 信息文本).加入项目 ()
.否则
    相加 (“客户端：  ”, 信息文本).加入项目 ()
.如果结束
赋值 (., 相减 (取项目数 (), 1))
.如果真 (大于 (取项目数 (), 100))
    0.删除项目 ()
.如果真结束


.子程序 等待命令, 逻辑型, , 
.参数 命令名, 文本型, , 

.局部变量 开始时, 空白型, , , 

赋值 (开始时, 取启动时间 ())
.判断循环首 (不等于 (命令名, 头信息))
    .如果真 (等于 (运行中, 假))
        返回 (真)
    .如果真结束
    .如果真 (大于 (相减 (取启动时间 (), 开始时), 30000))
        信息条 (“服务器超时，断开重连”, 假)
        断开连接 ()
        返回 (假)
    .如果真结束
    .如果真 (大于或等于 (到数值 (头信息), 400))
        信息条 (“有错误发生！”, 真)
        信息条 (命令句, 真)
    .如果真结束
    .如果真 (或者 (等于 (头信息, “421”), 等于 (头信息, “426”)))
        断开连接 ()
        返回 (假)
    .如果真结束
    
    处理事件 ()
.判断循环尾 ()
赋值 (头信息, “”)
返回 (真)


.子程序 下载, 逻辑型, , 
.局部变量 IP, 文本型, , , 
.局部变量 PORT, 空白型, , , 
.局部变量 开始时, 空白型, , , 

.如果真 (等待命令 (“220”))
    相加 (“USER ”, 用户名, #换行符).发送数据 ()
    信息条 (相加 (“用户名 ”, 用户名), 假)
    赋值 (开始时, 取启动时间 ())
    .判断循环首 (运行中) ' 是否要密码
        .判断开始 (等于 (头信息, “230”)) ' 不要密码
            相加 (“REST 100”, #换行符).发送数据 ()
            信息条 (“登陆成功”, 假)
            信息条 (“REST 100”, 假)
            跳出循环 ()
        .判断 (等于 (头信息, “331”)) ' 要密码
            相加 (“PASS ”, 密码, #换行符).发送数据 ()
            信息条 (相加 (“密码 ”, 取重复文本 (取文本长度 (密码), “*”)), 假)
            赋值 (头信息, “”)
        .判断 (等于 (头信息, “530”)) ' 要密码
            信息条 (“服务器拒绝登入”, 真)
            信息条 (命令句, 真)
            断开连接 ()
            信息条 (“断开连接”, 假)
            返回 (假)
            
        .默认
            
        .判断结束
        .如果真 (大于 (相减 (取启动时间 (), 开始时), 30000))
            信息条 (“服务器超时，断开重连”, 假)
            断开连接 ()
            返回 (假)
        .如果真结束
        处理事件 ()
        
    .判断循环尾 ()
    .如果真 (等待命令 (“350”))
        相加 (“REST 0”, #换行符).发送数据 ()
        .如果 (等于 (寻找文本 (命令句, “Restart”, , 真), -1))
            信息条 (“该站点不支持断点续传”, 真)
            .如果真 (续传)
                断开连接 ()
                信息条 (“断开连接”, 假)
                赋值 (运行中, 假)
                返回 (假)
            .如果真结束
            
        .否则
            信息条 (“该站点支持断点续传”, 真)
        .如果结束
        信息条 (“REST 0”, 假)
        .如果真 (等待命令 (“350”))
            相加 (“TYPE I”, #换行符).发送数据 ()
            信息条 (“传输类型设为二进制数据”, 假)
            .如果真 (等待命令 (“200”))
                相加 (“SIZE ”, 源文件, #换行符).发送数据 ()
                .如果真 (等待命令 (“213”))
                    相加 (“PASV”, #换行符).发送数据 ()
                    赋值 (源文件长, 到数值 (删首尾空 (取文本右边 (命令句, 相减 (取文本长度 (命令句), 4)))))
                    信息条 (相加 (“文件长度为”, 到文本 (源文件长), “bytes”), 真)
                    赋值 (., 相加 (到文本 (源文件长), “byte”))
                    赋值 (开始时, 取启动时间 ())
                    .判断循环首 (运行中) ' 判断两种下载模式
                        .判断开始 (等于 (头信息, “550”)) ' 模式1，由已方设置接口
                            赋值 (IP, 转换为IP地址 (取主机名 ()))
                            赋值 (IP, 子文本替换 (IP, “.”, “,”, , , 真))
                            相加 (“PORT ”, IP, “,77,18”, #换行符).发送数据 () ' 设置端口为本机的19730，本来是取本地可用端口，不过用易做不了
                            赋值 (头信息, “”)
                            .如果真 (等待命令 (“200”))
                                跳出循环 ()
                            .如果真结束
                            返回 (假)
                        .判断 (等于 (头信息, “227”)) ' 模式2，由对方给出接口
                            .如果真 (取下载接口 (IP, PORT))
                                信息条 (相加 (“连接文件传输接口 ”, IP, “:”, 到文本 (PORT)), 假)
                                .如果 (IP.连接 (PORT))
                                    跳出循环 ()
                                .否则
                                    信息条 (“与文件传输接口连接失败！”, 假)
                                    返回 (假)
                                .如果结束
                                
                            .如果真结束
                            
                        .默认
                            
                        .判断结束
                        .如果真 (大于 (相减 (取启动时间 (), 开始时), 30000))
                            信息条 (“服务器超时，断开重连”, 假)
                            断开连接 ()
                            返回 (假)
                        .如果真结束
                        处理事件 ()
                        
                    .判断循环尾 ()
                    .如果 (续传)
                        .如果真 (小于或等于 (源文件长, 目标文件长))
                            信息框 (“文件长度不对或已经下载完成！”, #错误图标, “错误”)
                            断开连接 ()
                            赋值 (运行中, 假)
                            返回 (假)
                        .如果真结束
                        相加 (“REST ”, 到文本 (目标文件长), #换行符).发送数据 ()
                        赋值 (接收字节数, 目标文件长)
                        信息条 (“请求续传”, 假)
                        .如果真 (等待命令 (“350”))
                            相加 (“RETR ”, 源文件, #换行符).发送数据 ()
                            赋值 (文件号, 打开文件 (目标文件, #改写, #禁止读写))
                            信息条 (相加 (“请求下载”, 源文件), 假)
                            
                        .如果真结束
                        
                        
                    .否则
                        相加 (“RETR ”, 源文件, #换行符).发送数据 ()
                        赋值 (文件号, 打开文件 (目标文件, #重写, #禁止读写))
                        赋值 (接收字节数, 0)
                        信息条 (相加 (“请求下载”, 源文件), 假)
                        
                    .如果结束
                    等待命令 (“150”)
                    信息条 (“开始下载文件”, 真)
                    返回 (真)
                    
                    
                    
                .如果真结束
                
            .如果真结束
            
        .如果真结束
        
        
    .如果真结束
    
    
.如果真结束
返回 (假)

.子程序 取下载接口, 逻辑型, , 
.参数 IP, 文本型, 参考, 
.参数 端口, 整数型, 参考, 

.局部变量 首, 空白型, , , 
.局部变量 末, 空白型, , , 
.局部变量 文本命令, 文本型, , , 
.局部变量 IPORT, 文本型, , "0", 

赋值 (首, 相加 (寻找文本 (命令句, “(”, , 假), 1))
赋值 (末, 寻找文本 (命令句, “)”, , 假))
赋值 (文本命令, 取文本中间 (命令句, 首, 相减 (末, 首)))
赋值 (IPORT, 分割文本 (文本命令, , ))
.如果 (等于 (取数组成员数 (IPORT), 6))
    赋值 (IP, 相加 (IPORT [1], “.”, IPORT [2], “.”, IPORT [3], “.”, IPORT [4]))
    赋值 (端口, 相加 (相乘 (到数值 (IPORT [5]), 256), 到数值 (IPORT [6])))
.否则
    返回 (假)
.如果结束
返回 (真)


.子程序 _下载接口1_数据到达, 空白型, , 
.局部变量 数据包, 字节集, , , 
.局部变量 进度值, 空白型, , , 

赋值 (数据包, 取回数据 ())
.如果真 (不等于 (文件号, 0))
    移动读写位置 (文件号, , 接收字节数)
    写出字节集 (文件号, 数据包)
    赋值 (接收字节数, 取读写位置 (文件号))
    赋值 (进度值, 取整 (相乘 (相除 (接收字节数, 源文件长), 100)))
    赋值 (., 进度值)
    赋值 (., 相加 (“下载中...”, 到文本 (进度值), “%”))
    赋值 (., 相加 (到文本 (接收字节数), “byte”))
    处理事件 ()
.如果真结束


.子程序 _下载接口1_连接断开, 空白型, , 
断开连接 ()
赋值 (运行中, 假)
赋值 (., 假)
赋值 (., 真)
赋值 (., 0)
赋值 (., “下载完毕”)
信息条 (“与站点断开连接”, 假)
关闭文件 (文件号)


.子程序 _下载接口2_客户进入, 空白型, , 
赋值 (服务器, 取回客户 ())

.子程序 _下载接口2_数据到达, 空白型, , 
.局部变量 数据包, 字节集, , , 
.局部变量 进度值, 空白型, , , 

赋值 (数据包, 取回数据 ())
.如果真 (不等于 (文件号, 0))
    移动读写位置 (文件号, , 接收字节数)
    写出字节集 (文件号, 数据包)
    赋值 (接收字节数, 取读写位置 (文件号))
    赋值 (进度值, 取整 (相乘 (相除 (接收字节数, 源文件长), 100)))
    赋值 (., 进度值)
    赋值 (., 相加 (“下载中...”, 到文本 (进度值), “%”))
    赋值 (., 相加 (到文本 (接收字节数), “byte”))
    处理事件 ()
.如果真结束


.子程序 _下载接口2_客户离开, 空白型, , 
服务器.断开客户 ()
赋值 (运行中, 假)
赋值 (., 假)
赋值 (., 真)
赋值 (., 0)
赋值 (., “下载完毕”)
信息条 (“与站点断开连接”, 假)
关闭文件 (文件号)


.子程序 __启动窗口_可否被关闭, 逻辑型, , 
.如果真 (运行中)
    .如果 (等于 (信息框 (“文件正在下载，是否真的退出程序？”, 相加 (#询问图标, #是否钮), “正在下载”), #是钮))
        _按钮4_被单击 ()
        返回 (真)
    .否则
        返回 (假)
    .如果结束
    
.如果真结束


.窗口程序集 窗口程序集2, , , 

.程序集变量 选择, 空白型, , , 
.程序集变量 源文件, 文本型, , , 
.子程序 _驱动器框1_驱动器被改变, 空白型, , 
赋值 (., 相加 (., “:\”))
_目录框1_目录被改变 ()


.子程序 _目录框1_目录被改变, 空白型, , 
.判断开始 (等于 (取文本长度 (.), 3))
    赋值 (., 相加 (., 源文件))
.默认
    赋值 (., 相加 (., “\”, 源文件))
.判断结束


.子程序 _按钮1_被单击, 空白型, , 
.如果 (文件是否存在 (删首尾空 (.)))
    赋值 (选择, 0)
    载入 (窗口1, , 真)
    .判断开始 (等于 (选择, 1))
        赋值 (_启动窗口., 假)
    .判断 (等于 (选择, 2))
        赋值 (_启动窗口., 真)
        
    .默认
        返回 ()
    .判断结束
    
.否则
    
.如果结束
赋值 (_启动窗口., 删首尾空 (.))
赋值 (_启动窗口., 假)
销毁 ()


.子程序 _按钮2_被单击, 空白型, , 
销毁 ()

.子程序 _保存窗口_创建完毕, 空白型, , 
.局部变量 N, 空白型, , , 

赋值 (源文件, _启动窗口.)
赋值 (N, 倒找文本 (源文件, “/”, , 假))
赋值 (源文件, 取文本右边 (源文件, 相减 (取文本长度 (源文件), N)))
赋值 (_启动窗口., 假)
赋值 (_启动窗口., 真)
_驱动器框1_驱动器被改变 ()

.窗口程序集 窗口程序集3, , , 

.子程序 _按钮1_被单击, 空白型, , 
赋值 (保存窗口., 1)
销毁 ()

.子程序 _按钮2_被单击, 空白型, , 
赋值 (保存窗口., 2)
销毁 ()

.子程序 _按钮3_被单击, 空白型, , 
销毁 ()

.子程序 _窗口1_创建完毕, 空白型, , 
鸣叫 ()


 ' 不属于任何一个程序集、类模块的函数：
