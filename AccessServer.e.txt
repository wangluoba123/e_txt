 ' 文件类型：Windows模块源码

 ' 程序名称：AccessServer
 ' 程序描述：
 ' 程序作者：小豕
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 启动窗口
    左边 = 0
    顶边 = 0
    宽度 = 380
    高度 = 250
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 假
    禁止 = 假
    边框 = 1
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 假
    位置 = 0
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 假
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 假
    外形 = 0
    总在最前 = 真
    保持标题栏激活 = 假
    窗口类名 = “”
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “Access远程数据库”
    帮助文件名 = “”

窗口 操作窗口
    左边 = 50
    顶边 = 50
    宽度 = 335
    高度 = 152
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 假
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 假
    外形 = 0
    总在最前 = 真
    保持标题栏激活 = 假
    窗口类名 = “”
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “客户操作”
    帮助文件名 = “”

窗口 设置窗口
    左边 = 50
    顶边 = 50
    宽度 = 168
    高度 = 187
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 假
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 假
    外形 = 0
    总在最前 = 真
    保持标题栏激活 = 假
    窗口类名 = “”
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “全局设置”
    帮助文件名 = “”



.图片 图标, " ' 已保存到：D:\易语言学习\Data\AccessServer.e\图标", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 5 0 系统核心支持库
 ' Exmlrpc A36CFD538657479eBD7C0D287BBB3D95 2 0 远程服务支持库
 ' EDataStructure 0AFF5F28B2CB42ce906AA27D6E485457 2 0 数据结构支持库




.全局变量 远程服务, 未知类型0x20001, , , 

.程序集 启动程序集, , , 

.子程序 _启动子程序, 整数型, , 请在本子程序中放置易模块初始化代码
载入 (启动窗口, , 假)
_临时子程序 () ' 在初始化代码执行完毕后调用测试代码
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 _临时子程序, 空白型, , 
 ' 本名称子程序用作测试程序用，仅在开发及调试环境中有效，编译发布程序前将被系统自动清空，请将所有用作测试的临时代码放在本子程序中。 ***注意不要修改本子程序的名称、参数及返回值类型。


.窗口程序集 启动窗口程序集, , , 

.子程序 _启动服务_被选择, 空白型, , 
.局部变量 文件号, 文本型, , , 
.局部变量 密码, 文本型, , , 
.局部变量 端口号, 整数型, , , 
.局部变量 处理方式, 逻辑型, , , 
.局部变量 最小线程, 整数型, , , 
.局部变量 最大线程, 整数型, , , 

赋值 (文件号, 读配置项 (“C:\AccessServer.dat”, “Database”, “Address”, “”))
赋值 (密码, 读配置项 (“C:\AccessServer.dat”, “Database”, “Password”, “”))
赋值 (端口号, 到数值 (读配置项 (“C:\AccessServer.dat”, “Server”, “Port”, “30000”)))
赋值 (最小线程, 到数值 (读配置项 (“C:\AccessServer.dat”, “Server”, “Thread1”, “5”)))
赋值 (最大线程, 到数值 (读配置项 (“C:\AccessServer.dat”, “Server”, “Thread2”, “20”)))
.如果 (等于 (读配置项 (“C:\AccessServer.dat”, “Server”, “way”, “1”), “1”))
    赋值 (处理方式, 真)
.否则
    赋值 (处理方式, 假)
.如果结束
.如果真 (等于 (远程服务.未知支持库函数_3 (最小线程, 最大线程), 假))
    相加 (“[”, 到文本 (取现行时间 ()), “]:设置线程失败，线程默认为5-20。”, #换行符).加入文本 ()
.如果真结束
.如果真 (等于 (文件号.打开MDB数据库 (密码, , 真), 假))
    相加 (“[”, 到文本 (取现行时间 ()), “]:打开数据库失败，服务停止启动。”, #换行符).加入文本 ()
    返回 ()
.如果真结束
.如果真 (等于 (远程服务.未知支持库函数_1 (端口号, &处理函数, 处理方式), 假))
    相加 (“[”, 到文本 (取现行时间 ()), “]:远程服务启动失败。”, #换行符).加入文本 ()
    返回 ()
.如果真结束
赋值 (.可视, 假)
赋值 (.可视, 假)
赋值 (.可视, 真)

.子程序 _停止服务_被选择, 空白型, , 
.局部变量 客户句柄, 整数型, , , 
.局部变量 请求信息, 文本型, , , 
.局部变量 节点, 未知类型0x30001, , , 

远程服务.未知支持库函数_2 ()
赋值 (.时钟周期, 0)
关闭 ()
赋值 (.可视, 真)
赋值 (.可视, 真)
赋值 (.可视, 假)
赋值 (., “Access远程数据库”)

.子程序 _退出_被选择, 空白型, , 
销毁 ()

.子程序 _全局设置_被选择, 空白型, , 
载入 (设置窗口, 启动窗口, 假)

.子程序 _进入操作界面_被选择, 空白型, , 
载入 (操作窗口, 启动窗口, 假)

.子程序 处理函数, 空白型, , 
.参数 消息地址, 整数型, , 

.局部变量 请求代码, 文本型, , , 
.局部变量 请求信息, 文本型, , , 
.局部变量 请求文本, 文本型, , "0", 
.局部变量 客户句柄, 整数型, , , 
.局部变量 计次变量, 整数型, , , 

远程服务.未知支持库函数_8 (消息地址, 客户句柄)
.如果真 (等于 (远程服务.未知支持库函数_27 (消息地址), -1))
    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 连接出错。”, #换行符).加入文本 ()
.如果真结束
.如果真 (等于 (远程服务.未知支持库函数_27 (消息地址), 0))
    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 成功连接。”, #换行符).加入文本 ()
.如果真结束
.如果真 (等于 (远程服务.未知支持库函数_27 (消息地址), 1))
    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 断开连接。”, #换行符).加入文本 ()
.如果真结束
.如果真 (等于 (远程服务.未知支持库函数_27 (消息地址), 2))
    .如果 (等于 (远程服务.未知支持库函数_4 (消息地址, 请求代码, 请求信息), 假))
        相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 取请求信息失败。”, #换行符).加入文本 ()
    .否则
        赋值 (请求文本, 分割文本 (请求信息, “|”, ))
        .如果真 (等于 (请求文本 [1], “执行”))
            启动事务 ()
            .计次循环首 (相减 (取数组成员数 (请求文本), 1), 计次变量)
                .如果真 (等于 (请求文本.执行 ( [相加 (计次变量, 1)], ), 假))
                    赋值 (请求文本 [1], “0”)
                    跳出循环 ()
                .如果真结束
                
            .计次循环尾 ()
            .如果 (等于 (请求文本 [1], “0”))
                回滚事务 ()
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “0”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .否则
                提交事务 ()
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “1”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .如果结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “读记录”))
            赋值 (计次变量, 3)
            赋值 (请求文本 [1], “”)
            .计次循环首 (相减 (取数组成员数 (请求文本), 2), )
                赋值 (请求文本 [1], 相加 (请求文本 [1], 到文本 (到数值 (请求文本 [2]).读 (到数值 (请求文本 [计次变量]))), “|”))
                赋值 (计次变量, 相加 (计次变量, 1))
            .计次循环尾 ()
            .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, 请求文本 [1]), 假))
                相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
            .如果真结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “读所有”))
            赋值 (请求文本 [1], “”)
            到数值 (请求文本 [2]).到首记录 ()
            .判断循环首 (等于 (到数值 (请求文本 [2]).尾记录后 (), 假))
                赋值 (计次变量, 3)
                .计次循环首 (相减 (取数组成员数 (请求文本), 2), )
                    赋值 (请求文本 [1], 相加 (请求文本 [1], 到文本 (到数值 (请求文本 [2]).读 (到数值 (请求文本 [计次变量]))), “|”))
                    赋值 (计次变量, 相加 (计次变量, 1))
                .计次循环尾 ()
                到数值 (请求文本 [2]).到后一记录 ()
            .判断循环尾 ()
            .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, 请求文本 [1]), 假))
                相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
            .如果真结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “查询”))
            
            .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, 到文本 (请求文本.查询 ( [2]))), 假))
                相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
            .如果真结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “读”))
            .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, 到文本 (到数值 (请求文本 [2]).读 (到数值 (请求文本 [3])))), 假))
                相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
            .如果真结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “首记录前”))
            .如果 (到整数 (请求文本 [2]).首记录前 ())
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “1”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .否则
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “0”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .如果结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “尾记录后”))
            .如果 (到整数 (请求文本 [2]).尾记录后 ())
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “1”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .否则
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “0”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .如果结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “重新查询”))
            .如果 (等于 (到整数 (请求文本 [2]).重新查询 (), 真))
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “1”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .否则
                .如果真 (等于 (远程服务.未知支持库函数_6 (请求代码, “0”), 假))
                    相加 (“[”, 到文本 (取现行时间 ()), “]:客户(”, 到文本 (客户句柄), “) 不能够成功接收到服务器发送的反馈信息。”, #换行符).加入文本 ()
                .如果真结束
                
            .如果结束
            
        .如果真结束
        .如果真 (等于 (请求文本 [1], “到首记录”))
            到整数 (请求文本 [2]).到首记录 ()
        .如果真结束
        .如果真 (等于 (请求文本 [1], “到尾记录”))
            到整数 (请求文本 [2]).到尾记录 ()
        .如果真结束
        .如果真 (等于 (请求文本 [1], “到前一记录”))
            到整数 (请求文本 [2]).到前一记录 ()
        .如果真结束
        .如果真 (等于 (请求文本 [1], “到后一记录”))
            到整数 (请求文本 [2]).到后一记录 ()
        .如果真结束
        .如果真 (等于 (请求文本 [1], “关闭记录集”))
            到数值 (请求文本 [2]).关闭记录集 ()
        .如果真结束
        
    .如果结束
    
.如果真结束


.子程序 _启动窗口_创建完毕, 空白型, , 
赋值 (., #图标)
赋值 (., 到数值 (读配置项 (“C:\AccessServer.dat”, “System”, “left”, “0”)))
赋值 (., 到数值 (读配置项 (“C:\AccessServer.dat”, “System”, “top”, “0”)))

.子程序 _启动窗口_将被销毁, 空白型, , 
写配置项 (“C:\AccessServer.dat”, “System”, “left”, 到文本 (.))
写配置项 (“C:\AccessServer.dat”, “System”, “top”, 到文本 (.))
写到文件 (“C:\AccessLog.txt”, 到字节集 (.内容))

.子程序 嵌入外部窗口, 空白型, , 
.参数 窗口, 窗口, , 

置父窗口 (窗口)

.子程序 显示操作窗, 空白型, , 打开操作窗口。
赋值 (启动窗口., 真)

.子程序 隐藏操作窗, 空白型, , 隐藏操作窗口。
赋值 (启动窗口., 假)

.子程序 服务端设置, 空白型, , 在服务器启动之前设置。
.参数 MDB数据库文件名, 文本型, , 本参数提供即将打开数据库的文件名。
.参数 数据库密码, 文本型, 可空, 本参数提供打开数据库所需要的密码，如果省略本参数，默认为不需要。
.参数 端口号, 整数型, , 本参数作为服务启动的端口号。
.参数 最小线程数, 整数型, , 线程池内的线程数量的最小值。
.参数 最大线程数, 整数型, , 线程池内的线程数量的最大值。
.参数 处理方式, 逻辑型, , 该参数为真代表处理函数必须串行处理每个客户端的请求；该参数为假代表处理函数可以并行处理多个客户端的请求。

写配置项 (“C:\AccessServer.dat”, “Server”, “Thread1”, 到文本 (最小线程数))
写配置项 (“C:\AccessServer.dat”, “Server”, “Thread2”, 到文本 (最大线程数))
写配置项 (“C:\AccessServer.dat”, “Server”, “Port”, 到文本 (端口号))
.如果 (等于 (处理方式, 真))
    写配置项 (“C:\AccessServer.dat”, “Server”, “way”, “1”)
.否则
    写配置项 (“C:\AccessServer.dat”, “Server”, “Speed”, “0”)
.如果结束
写配置项 (“C:\AccessServer.dat”, “Database”, “Address”, MDB数据库文件名)
写配置项 (“C:\AccessServer.dat”, “Database”, “Password”, 数据库密码)

.子程序 取客户数, 整数型, , 取得当前连接到服务器的客户端数量。该方法正确执行，返回大于等于0的整数值，如果发生错误返回-1。
返回 (远程服务.未知支持库函数_10 ())

.子程序 取客户数组, 逻辑型, , 取得当前连接到服务器的所有客户端的句柄。该方法执行成功返回真，执行失败返回假。
.参数 客户句柄数组, 整数型, 数组, 提供参数数据时只能提供变量数组。连接到当前的服务程序的所有客户端的句柄数组，该参数作为“取客户数组”的返回值。

返回 (远程服务.未知支持库函数_11 (客户句柄数组))

.子程序 断开连接, 空白型, , 断开与一个客户的连接。
.参数 客户句柄, 整数型, , 欲断开的客户端的句柄。

远程服务.未知支持库函数_12 (客户句柄)

.子程序 取客户IP, 逻辑型, , 根据客户的句柄值取得客户的IP地址。成功取得客户的IP地址，返回真，如果客户已经不可用或其他意外情况发生，返回假。
.参数 客户句柄, 整数型, , 客户端的句柄值。客户句柄由“取客户数组”返回。
.参数 客户IP地址, 文本型, , 提供参数数据时只能提供变量。客户端的IP地址。该参数作为方法“取客户IP”的返回值。

返回 (远程服务.未知支持库函数_9 (客户句柄, 客户IP地址))

.子程序 启动服务, 逻辑型, , 
_启动服务_被选择 ()
.如果 (等于 (.可视, 假))
    返回 (真)
.否则
    返回 (假)
.如果结束


.子程序 停止服务, 空白型, , 
_停止服务_被选择 ()

.窗口程序集 操作窗口程序集, , , 

.子程序 _刷新按钮_被单击, 空白型, , 
.局部变量 客户数组, 整数型, , "0", 
.局部变量 计次变量, 整数型, , , 

远程服务.未知支持库函数_11 (客户数组)
清空 ()
.计次循环首 (取数组成员数 (客户数组), 计次变量)
    到文本 (客户数组 [计次变量]).加入项目 ()
.计次循环尾 ()
赋值 (.标题, 相加 (“在线客户：”, 到文本 (取项目数 ())))

.子程序 _客户列表框_列表项被选择, 空白型, , 
赋值 (.内容, .取项目文本 (.现行选中项))

.子程序 _断开按钮_被单击, 空白型, , 
远程服务.未知支持库函数_12 (到数值 (.内容))

.子程序 _取IP按钮_被单击, 空白型, , 
.局部变量 IP地址, 文本型, , , 

.如果 (等于 (远程服务.未知支持库函数_9 (到数值 (.内容), IP地址), 假))
    赋值 (.内容, “取客户IP地址失败”)
.否则
    赋值 (.内容, IP地址)
.如果结束


.子程序 _操作窗口_创建完毕, 空白型, , 
赋值 (., #图标)

.窗口程序集 设置窗口程序集, , , 

.子程序 _设置窗口_将被销毁, 空白型, , 
写配置项 (“C:\AccessServer.dat”, “Server”, “Thread1”, .内容)
写配置项 (“C:\AccessServer.dat”, “Server”, “Thread2”, .内容)
写配置项 (“C:\AccessServer.dat”, “Server”, “Port”, .内容)
.如果 (等于 (.选中, 真))
    写配置项 (“C:\AccessServer.dat”, “Server”, “way”, “1”)
.否则
    写配置项 (“C:\AccessServer.dat”, “Server”, “way”, “0”)
.如果结束
写配置项 (“C:\AccessServer.dat”, “Database”, “Address”, .内容)
写配置项 (“C:\AccessServer.dat”, “Database”, “Password”, .内容)

.子程序 _选择按钮_被单击, 空白型, , 
.如果真 (打开 ())
    赋值 (.内容, .文件名)
.如果真结束


.子程序 _设置窗口_创建完毕, 空白型, , 
赋值 (., #图标)
赋值 (.初始目录, 取运行目录 ())
赋值 (.内容, 读配置项 (“C:\AccessServer.dat”, “Server”, “Thread1”, “5”))
赋值 (.内容, 读配置项 (“C:\AccessServer.dat”, “Server”, “Thread2”, “20”))
赋值 (.内容, 读配置项 (“C:\AccessServer.dat”, “Server”, “Port”, “30000”))
.如果 (等于 (读配置项 (“C:\AccessServer.dat”, “Server”, “way”, “1”), “1”))
    赋值 (.选中, 真)
.否则
    赋值 (.选中, 假)
.如果结束
赋值 (.内容, 读配置项 (“C:\AccessServer.dat”, “Database”, “Address”, “”))
赋值 (.内容, 读配置项 (“C:\AccessServer.dat”, “Database”, “Password”, “”))



 ' 不属于任何一个程序集、类模块的函数：
