 ' 文件类型：Windows窗口程序

 ' 程序名称：心雨在线更新系统!
 ' 程序描述：心雨软件工作室
 ' 程序作者：心雨☆孤星
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：bxy8155@163.com
 ' 主页地址：
 ' 版权声明：QQ:178889998
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 492
    高度 = 380
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = 12607488 '  0xC06000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 真
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 真
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\_启动窗口_图标.ico
    背景音乐 =  ' 空
    标题 = “心雨在线更新系统!”
    帮助文件名 = “”

窗口 网络配置
    左边 = 50
    顶边 = 50
    宽度 = 481
    高度 = 349
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 真
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “调试程序”
    帮助文件名 = “”



.常量 配置文件地址, "“http://localhost/HOME/UpList.txt”", , 
.常量 本地版本, "“2”", , 
.常量 主程序文件名称, "“Ester.exe”", , 
.常量 下载文件地址, "“http://localhost/HOME/Updata/”", , 
.常量 软件标题, "“心雨软件”", , 
.图片 托盘图标1, " ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\托盘图标1", , 
.图片 图片1, " ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\图片1", , 
.图片 托盘图标2, " ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\托盘图标2", , 
.图片 下载时动画, " ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\下载时动画", , 
.图片 DLL文件, " ' 已保存到：D:\易语言学习\Data\心雨在线更新系统 V2.0.e\DLL文件", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' downlib 80CF4A6B3E09425bA57935A3A0E4C473 2 0 网络传送支持库
 ' xplib 7F54B9CE8887428dBA9CEEB94CEF4C72 1 6 XP风格界面库
 ' iext 27bb20fdd3e145e4bee3db39ddd6e64c 1 2 扩展界面支持库一
 ' eAPI F7FC1AE45C5C4758AF03EF19F18A395D 1 1 应用接口支持库
 ' internet 707ca37322474f6ca841f0e224f4b620 1 0 互联网支持库




.全局变量 下载地址, 文本型, , "0", 
.全局变量 下载列表文件, 字节集, , , 
.全局变量 本地版本, 文本型, , , 
.全局变量 网络版本, 文本型, , , 
.全局变量 保存路径, 文本型, , , 
.全局变量 解压文件, 文本型, , , 
.全局变量 解压数目, 整数型, , , 
.全局变量 列表配置, 文本型, , , 

.窗口程序集 窗口程序集1, , , 

.程序集变量 下载参数, 未知类型0x20004, , , 
.程序集变量 下载任务, 未知类型0x20001, , , 
.程序集变量 索引, 整数型, , , 
.程序集变量 文件大小, 双精度小数型, , , 
.程序集变量 当前正在下载, 逻辑型, , , 
.程序集变量 已下载文件数, 整数型, , , 
.程序集变量 自定义欢迎文本, 文本型, , , 
.程序集变量 软件标题, 文本型, , , 
.程序集变量 下载结束, 逻辑型, , , 
.程序集变量 当前地址, 文本型, , , 
.子程序 _下载_被单击, 空白型, , 
置托盘图标 (#托盘图标2, “心雨在线更新!”)
赋值 (.播放动画, 真)
赋值 (.可视, 假)
.如果真 (等于 (取数组成员数 (下载地址), 0))
    信息框 (“没有找到可下载的文件地址!!请重新设置，按F1查看帮助。”, 0, )
    返回 ()
.如果真结束
.如果真 (等于 (保存路径, “”))
    信息框 (“下载的文件保存到文件夹的路径不能为空！！请重新设置，按F1查看帮助。”, 0, )
    返回 ()
.如果真结束
.如果 (不等于 (.图片, {  }))
    赋值 (.播放动画, 真)
.否则
    赋值 (.图片, #下载时动画)
    赋值 (.播放动画, 真)
.如果结束
赋值 (当前正在下载, 真)
赋值 (.时钟周期, 100)
赋值 (.时钟周期, 1000)
赋值 (.禁止, 真)
赋值 (已下载文件数, 1)
赋值 (下载结束, 假)
下载 ()

.子程序 下载, 空白型, , 
相减 (已下载文件数, 2).置图片 (1, 3)
相减 (已下载文件数, 2).置标题 (1, “完成”)
相减 (已下载文件数, 1).置图片 (1, 2)
相减 (已下载文件数, 1).置标题 (1, “数据连接中...”)
赋值 (当前地址, 删首尾空 (下载地址 [已下载文件数]))
赋值 (.标题, 相加 (“总进度：”, 到文本 (已下载文件数), “/”, 到文本 (取数组成员数 (下载地址))))
赋值 (.位置, 相乘 (相除 (已下载文件数, 取数组成员数 (下载地址)), 100))
赋值 (下载参数., #.)
赋值 (下载参数., 相加 (#下载文件地址, 当前地址))
赋值 (下载参数., 0)
赋值 (下载参数., 1000)
赋值 (下载参数., 1)
赋值 (下载参数., 相加 (到文本 (保存路径), “\”))
赋值 (下载参数., 5000)
赋值 (下载参数., 5001)
赋值 (下载参数., 10000)
赋值 (下载参数., 20480)
赋值 (下载参数., &交互回调函数)
下载任务.未知支持库函数_19 (下载参数)

.子程序 交互回调函数, 整数型, , 
.参数 消息类型, 整数型, , 
.参数 线程信息, 整数型, , 
.参数 参数3, 整数型, , 
.参数 参数4, 整数型, , 
.参数 对象信息, 整数型, , 

.判断开始 (等于 (消息类型, #.))
    赋值 (文件大小, 参数3)
.判断 (等于 (消息类型, #.))
    赋值 (下载结束, 真)
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.判断 (等于 (消息类型, #.))
    
.默认
    
.判断结束
返回 (0)


.子程序 _时钟_周期事件, 空白型, , 
.局部变量 文件总大小, 整数型, , , 

.如果真 (等于 (.禁止, 真))
    .如果 (等于 (文件大小, 0))
        赋值 (.标题, “正在接受数据... ...”)
    .否则
        赋值 (.标题, 相加 (“正在下载：”, 到文本 (当前地址), “  已完成：”, 数值到格式文本 (相乘 (相除 (下载任务.未知支持库函数_26 (), 文件大小), 100), 0, 假), “%”))
        相减 (已下载文件数, 1).置标题 (1, 相加 (“下载中...”, 数值到格式文本 (相乘 (相除 (下载任务.未知支持库函数_26 (), 文件大小), 100), 0, 假), “%”))
    .如果结束
    赋值 (.位置, 四舍五入 (相乘 (相除 (下载任务.未知支持库函数_26 (), 文件大小), 100), 0))
    赋值 (文件总大小, 四舍五入 (相除 (取文件尺寸 (下载任务.未知支持库函数_32 ()), 1024), ))
    赋值 (.标题, 相加 (“已经下载：”, 到文本 (四舍五入 (相除 (下载任务.未知支持库函数_26 (), 1024), 0)), “KB”, “(文件总大小：”, 到文本 (文件总大小), “KB)”))
.如果真结束
.如果 (大于或等于 (已下载文件数, 取数组成员数 (下载地址)))
    赋值 (.标题, “下载完毕……”)
    赋值 (.可视, 真)
    赋值 (.可视, 假)
    赋值 (下载结束, 真)
    赋值 (.时钟周期, 0)
    赋值 (.时钟周期, 0)
    赋值 (当前正在下载, 假)
    .如果 (不等于 (.图片, {  }))
        赋值 (.播放动画, 假)
    .否则
        赋值 (.图片, #下载时动画)
        赋值 (.播放动画, 假)
    .如果结束
    赋值 (.禁止, 真)
    _安装_被单击 ()
.否则
    .如果真 (等于 (下载结束, 真))
        赋值 (下载结束, 假)
        赋值 (已下载文件数, 相加 (已下载文件数, 1))
        下载 ()
    .如果真结束
    
.如果结束


.子程序 __启动窗口_创建完毕, 空白型, , 
.局部变量 系统进程, 未知类型0x50009, , "0", 
.局部变量 程序名称, 文本型, , , 
.局部变量 计次, 整数型, , , 
.局部变量 x, 字节型, , , 

未知支持库函数_0 (2)
 ' Config.ini和UpList.ini位置和配置选项不可以修改(内容可以修改),下载文件夹Updata名不可以修改,否则无法自动更新.

 ' _启动窗口.高度 ＝ 380  ' 设为他时可以看到网络文件调试快捷键.
赋值 (_启动窗口., 350) ' 设为他时为正常运行模式.
.如果 (文件是否存在 (相加 (取运行目录 (), “\Config.ini”)))
    
.否则
    写配置项 (相加 (取运行目录 (), “\Config.ini”), “版本”, “版本号”, #本地版本)
    写配置项 (相加 (取运行目录 (), “\Config.ini”), “主程序”, “主程序名”, #主程序文件名称)
.如果结束

赋值 (x, 0)
赋值 (系统进程, 未知支持库函数_10 ())
赋值 (程序名称, 取执行文件名 ())
输出调试文本 (程序名称)
.计次循环首 (取数组成员数 (系统进程), 计次)
    .如果真 (等于 (程序名称, 系统进程 [计次], ))
        赋值 (x, 相加 (x, 1))
    .如果真结束
    
.计次循环尾 ()
.如果真 (大于 (x, 1))
    信息框 (“该程序已经在运行中，不能重复运行.....  ”, #警告图标, )
    结束 ()
.如果真结束

赋值 (.图片, #图片1)
赋值 (.播放动画, 假)
赋值 (.图片, #下载时动画)
赋值 (.播放动画, 假)
赋值 (.可视, 假)
赋值 (.可视, 假)
赋值 (.可视, 假)
置托盘图标 (#托盘图标1, “心雨在线更新系统!”)
赋值 (软件标题, #软件标题)
.如果 (等于 (自定义欢迎文本, “”))
    赋值 (.标题, 相加 (“此更新程序将安装或更新 ”, 软件标题, “ 组件到您的计算机。”, #换行符, #换行符, “如果您想退出此更新程序，请点击”, #左引号, “退出”, #右引号, #换行符, “点击”, #左引号, “下一步”, #右引号, “开始更新！”, #换行符, #换行符, “注意：在更新之前一定要关闭所有相关”, 软件标题, “的程序！否则更新将会失败。”, #换行符, “请保证您的电脑已连接英特网.”))
.否则
    赋值 (.标题, 自定义欢迎文本)
.如果结束
赋值 (.标题, 相加 (“欢迎使用 ”, 软件标题, “ 更新系统”))
赋值 (.标题, 相加 (“本地版本号为：V”, 读配置项 (相加 (取运行目录 (), “\Config.ini”), “版本”, “版本号”, )))
删除目录 (相加 (取运行目录 (), “\Updata\”))
创建目录 (相加 (取运行目录 (), “\Updata\”))
赋值 (保存路径, 相加 (取运行目录 (), “\Updata”))

.子程序 _取消_被单击, 空白型, , 
.如果 (等于 (当前正在下载, 真))
    .如果真 (等于 (信息框 (相加 (“当前正在下载文件!!”, #换行符, “如果退出,将结束当前下载任务,是否真的退出?”), 相加 (#询问图标, #是否钮), “提示:”), #是钮))
        赋值 (下载结束, 真)
        删除文件 (相加 (取运行目录 (), “\UpList.ini”))
        删除目录 (相加 (取运行目录 (), “\Updata\”))
        销毁 ()
    .如果真结束
    
.否则
    删除文件 (相加 (取运行目录 (), “\UpList.ini”))
    删除目录 (相加 (取运行目录 (), “\Updata\”))
    销毁 ()
.如果结束



.子程序 __启动窗口_可否被关闭, 逻辑型, , 
.如果 (等于 (当前正在下载, 真))
    .如果真 (等于 (信息框 (相加 (“当前正在下载文件!!”, #换行符, “如果退出,将结束当前下载任务,是否真的退出?”), 相加 (#询问图标, #是否钮), “提示:”), #是钮))
        赋值 (下载结束, 真)
        
        销毁 ()
    .如果真结束
    
.否则
    销毁 ()
.如果结束


.子程序 __启动窗口_将被销毁, 空白型, , 
结束 ()

.子程序 _时钟1_周期事件, 空白型, , 
.如果真 (等于 (.禁止, 真))
    赋值 (.标题, 相加 (“下载速度：”, 到文本 (四舍五入 (相除 (下载任务.未知支持库函数_25 (), 1024), )), “KB”, “/1秒”))
.如果真结束


.子程序 _按钮_下一步_被单击, 空白型, , 
.局部变量 文件类型, 文本型, , , 
.局部变量 文件类型数组, 文本型, , "0", 
.局部变量 文件类型数量, 整数型, , , 
.局部变量 分隔符位置, 整数型, , , 
.局部变量 循环值, 整数型, , , 

下载列表 ()
赋值 (.现行子夹, 1)
.如果 (等于 (.现行子夹, 1))
    赋值 (.可视, 假)
    赋值 (.可视, 真)
    赋值 (.可视, 真)
    赋值 (.可视, 假)
    赋值 (.可视, 假)
.否则
    
.如果结束

赋值 (文件类型, 读配置项 (相加 (取运行目录 (), “\UpList.ini”), “升级列表”, “文件列表”, ))
赋值 (文件类型数量, 1)
赋值 (分隔符位置, 寻找文本 (文件类型, “|”, 1, 假))
.判断循环首 (大于 (分隔符位置, -1))
    赋值 (文件类型数量, 相加 (文件类型数量, 1))
    赋值 (分隔符位置, 寻找文本 (文件类型, “|”, 相加 (分隔符位置, 1), 假))
.判断循环尾 ()
重定义数组 (文件类型数组, 假, 文件类型数量)
赋值 (文件类型数组, 分割文本 (文件类型, “|”, 取数组成员数 (文件类型数组)))
.计次循环首 (文件类型数量, 循环值)
    赋值 (索引, -1.插入表项 (到文本 (文件类型数组 [循环值]), , , , ))
    索引.置标题 (1, “等待中”)
    加入成员 (下载地址, 文件类型数组 [循环值])
    索引.置图片 (0, 0)
    索引.置图片 (1, 1)
.计次循环尾 ()
赋值 (.现行子夹, 1)
赋值 (.标题, 相加 (“总进度：”, 到文本 (已下载文件数), “/”, 到文本 (取数组成员数 (下载地址))))

.子程序 下载列表, 空白型, , 
赋值 (列表配置, 到文本 (未知支持库函数_7 (#配置文件地址))) ' 根据您的服务器,选择列表配置文件(有的服务器在读取TXT文件时,会产生配置文件,没有的选择这个配置,有的选择下个配置.

 ' 列表配置 ＝ 取文本左边 (到文本 (HTTP读文件 (#配置文件地址)), 取文本长度 (到文本 (HTTP读文件 (#配置文件地址))) － 212)  ' 根据您的服务器,选择列表配置文件(有的服务器在读取TXT文件时,会产生配置文件,没有的选择上一个配置,有的选择这个配置.212为配置文件文本长度.本程序附带测试网络服务器文本读出配置程序.
赋值 (下载列表文件, 到字节集 (列表配置))
写到文件 (相加 (取运行目录 (), “\UpList.ini”), 下载列表文件)
赋值 (网络版本, 读配置项 (相加 (取运行目录 (), “\UpList.ini”), “版本”, “版本号”, ))
赋值 (本地版本, 读配置项 (相加 (取运行目录 (), “\Config.ini”), “版本”, “版本号”, ))
写配置项 (相加 (取运行目录 (), “\UpList.ini”), “版本”, “版本号”, 网络版本)
.如果 (大于 (到数值 (网络版本), 到数值 (本地版本)))
    赋值 (.标题, 相加 (“☆本地版本为：V”, 本地版本, “ ☆最新版本为：V”, 网络版本))
.否则
    删除目录 (相加 (取运行目录 (), “\Updata\”))
    赋值 (.禁止, 真)
    赋值 (.标题, 相加 (“☆本地版本为：V”, 本地版本, “已经是最新版，无需升级！”))
    信息框 (相加 (“☆本地版本为：V”, 本地版本, “已经是最新版，无需升级！”), 0, )
    删除文件 (相加 (取运行目录 (), “\UpList.ini”))
    销毁 ()
.如果结束


.子程序 _按钮_退出_被单击, 空白型, , 
删除文件 (相加 (取运行目录 (), “\UpList.ini”))
删除目录 (相加 (取运行目录 (), “\Updata\”))
销毁 ()


.子程序 _安装_被单击, 空白型, , 
.如果 (文件是否存在 (相加 (取运行目录 (), “\upgrade.dll”)))
    
.否则
    写到文件 (相加 (取运行目录 (), “\upgrade.dll”), #DLL文件)
.如果结束
赋值 (., 真)
延时 (1000)
运行 (相加 (取运行目录 (), “\upgrade.dll”), 假, )
销毁 ()

.子程序 _按钮1_被单击, 空白型, , 
载入 (网络配置, , 真)

.窗口程序集 窗口程序集2, , , 

.子程序 _按钮1_被单击, 空白型, , 
赋值 (.内容, 到文本 (未知支持库函数_7 (#配置文件地址)))
赋值 (.内容, 到文本 (取文本长度 (到文本 (未知支持库函数_7 (#配置文件地址)))))

.子程序 _按钮2_被单击, 空白型, , 
赋值 (.内容, 到文本 (取文本长度 (.内容)))
赋值 (.内容, 到文本 (相减 (到数值 (.内容), 到数值 (.内容))))


.子程序 _网络配置_创建完毕, 空白型, , 
赋值 (.禁止, 真)

.子程序 _编辑框2_内容被改变, 空白型, , 
赋值 (.禁止, 假)



 ' 不属于任何一个程序集、类模块的函数：
