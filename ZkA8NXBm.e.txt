 ' 文件类型：Windows模块源码

 ' 程序名称：快速导出超级列表框、高级表格的数据
 ' 程序描述：基本原理：先动态生成MDB数据库，再生成表，然后读取超级列表框（高级表格）的数据写进数据库，最后根据保存格式再把MDB转为XLS
二个程序的代码不同之次在于控件读取数据的方式不同，其它的全相同

 ' 程序作者：SUPERREN
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' eGrid 0B4337DA651B4b619ACF61334A7E8B47 1 3 高级表格支持库
 ' iext 27bb20fdd3e145e4bee3db39ddd6e64c 1 2 扩展界面支持库一





.程序集 程序集1, , , 

.子程序 _启动子程序, 整数型, , 请在本子程序中放置易模块初始化代码
 ' 基本原理：先动态生成MDB数据库，再生成表，然后读取超级列表框（高级表格）的数据写进数据库，最后根据保存格式再把MDB转为XLS
 ' 二个程序的代码不同之次在于控件读取数据的方式不同，其它的全相同

_临时子程序 () ' 在初始化代码执行完毕后调用测试代码
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 _临时子程序, 空白型, , 
 ' 本名称子程序用作测试程序用，仅在开发及调试环境中有效，编译发布程序前将被系统自动清空，请将所有用作测试的临时代码放在本子程序中。 ***注意不要修改本子程序的名称、参数及返回值类型。


.子程序 导出超级列表框数据_SUPERREN, 空白型, 公开, 可将超级列表框的数据导出来MDB及XLS文件
.参数 超级列表框, 超级列表框, , 
.参数 保存文件名, 文本型, , 根据欲保存的文件扩展名导出目标格式。

.局部变量 mdb文件名, 文本型, , , 
.局部变量 字段数组, 文本型, , "0", 
.局部变量 I, 整数型, , , 
.局部变量 变体型1, 变体型, , , 
.局部变量 变体型2, 变体型, , , 
.局部变量 对象型1, 对象, , , 
.局部变量 对象型, 对象, , , 
.局部变量 ADODB连接, 对象, , , 
.局部变量 连接文本, 文本型, , , 
.局部变量 sql, 文本型, , , 
.局部变量 当前记录集, 对象, , , 
.局部变量 表名, 文本型, , , 
.局部变量 文本标题, 文本型, , , 
.局部变量 J, 整数型, , , 
.局部变量 time, 整数型, , , 
.局部变量 字段, 文本型, , , 

.如果真 (等于 (超级列表框.取表项数 (), 0))
    返回 (-1)
.如果真结束

.如果真 (不等于 (未知函数_67174522 (), “xls”))
    .如果真 (不等于 (未知函数_67174522 (), “mdb”))
        返回 (-2) ' 欲保存的文件格式不正确
    .如果真结束
    
.如果真结束
.如果真 (文件是否存在 ())
    返回 (-3) ' 目标文件已存在
.如果真结束
 ' 创建表结构

.计次循环首 (超级列表框.取列数 (), I)
    
    .如果 (不等于 (超级列表框.取列数 (), I))
        赋值 (文本标题, 相加 (文本标题, 超级列表框.取列标题 (相减 (I, 1)), “,”))
        赋值 (字段, 相加 (字段, 超级列表框.取列标题 (相减 (I, 1)), “ TEXT,”))
        
    .否则
        赋值 (文本标题, 相加 (文本标题, 超级列表框.取列标题 (相减 (I, 1))))
        赋值 (字段, 相加 (字段, 超级列表框.取列标题 (相减 (I, 1)), “ TEXT”))
    .如果结束
    
.计次循环尾 ()
 ' 过滤特殊字符
赋值 (子文本替换 (“/”, , , , 真))
赋值 (子文本替换 (“/”, , , , 真))
赋值 (子文本替换 (“'”, , , , 真))
赋值 (子文本替换 (“'”, , , , 真))
赋值 (子文本替换 (#引号, , , , 真))
赋值 (子文本替换 (#引号, , , , 真))

.如果 (等于 (未知函数_67174524 (), “xls”))
    赋值 (mdb文件名, 相加 (取单独文件名 (保存文件名), “.mdb”))
.否则
    赋值 ()
.如果结束
 ' 创建MDB数据库
未知函数_67174527 ()
 ' 默认表名
赋值 (表名, “列表框数据”)
.如果真 (ADODB连接.创建 (“ADODB.Connection”, ))
     ' 连接MDB数据库
    赋值 (相加 (“Provider=Microsoft.Jet.OLEDB.4.0;Data Source=”, ))
    “connectionstring”.写属性 ()
    “open”.方法 ()
    赋值 (“Errors”.读对象型属性 ())
    .如果真 (等于 (是否为空 (), 假))
        0.赋值 ()
        赋值 (“Item”.读对象型属性 ())
        .如果真 (等于 (是否为空 (), 假))
            输出调试文本 (相加 (“错误原因:”, “Description”.读文本属性 ()))
            返回 (-6) ' 连接MDB文件失败
        .如果真结束
        
    .如果真结束
    
    “ADODB.RecordSet”.创建 ()
    .赋值 ()
     ' 创建表及表结构
    赋值 (相加 (“CREATE TABLE  ”, , “ (”, , “)”))
    .赋值 ()
    “open”.方法 (1, 1)
    赋值 (“Errors”.读对象型属性 ())
    .如果真 (等于 (是否为空 (), 假))
        0.赋值 ()
        赋值 (“Item”.读对象型属性 ())
        .如果真 (等于 (是否为空 (), 假))
            输出调试文本 (相加 (“错误原因:”, “Description”.读文本属性 ()))
            返回 (-5) ' 表结构创建失败
        .如果真结束
        
    .如果真结束
     ' 逐行逐行的将高级表格的数据写进MDB数据库
    
    .计次循环首 (超级列表框.取表项数 (), I)
        处理事件 ()
        赋值 (sql, “”)
        .计次循环首 (超级列表框.取列数 (), J)
            处理事件 ()
            
            .如果 (不等于 (超级列表框.取列数 (), J))
                赋值 (sql, 相加 (sql, “'”, 超级列表框.取标题 (相减 (I, 1), 相减 (J, 1)), “',”))
            .否则
                赋值 (sql, 相加 (sql, “'”, 超级列表框.取标题 (相减 (I, 1), 相减 (J, 1)), “'”))
            .如果结束
            
        .计次循环尾 ()
        赋值 (sql, 相加 (“insert into ”, 表名, “ (”, 文本标题, “) values (”, sql, “) ”))
        变体型1.赋值 (sql, )
        
        当前记录集.方法 (“open”, 变体型1, 变体型2, 1, 1)
    .计次循环尾 ()
    
     ' 如保存类型为XLS，将MDB数据库内容转换为XLS格式
    .如果真 (等于 (未知函数_67174530 (), “xls”))
        赋值 (相加 (“SELECT * INTO [Excel 8.0;Database=”, , “].”, , “ FROM ”, ))
        .赋值 ()
        当前记录集.方法 (“open”, 变体型1, 变体型2, 1, 1)
        
        赋值 (“Errors”.读对象型属性 ())
        .如果真 (等于 (是否为空 (), 假))
            0.赋值 ()
            赋值 (“Item”.读对象型属性 ())
            .如果真 (等于 (是否为空 (), 假))
                输出调试文本 (相加 (“错误原因:”, “Description”.读文本属性 ()))
                返回 (-6) ' 转换为XLS失败
            .如果真结束
            
        .如果真结束
        
        
        “Close”.方法 ()
        ADODB连接.方法 (“Close”, )
         ' 如保存类型为XLS，删除临时创建的MDB数据库
        删除文件 ()
        
    .如果真结束
    返回 (0) ' 导出成功，返回0
    
.如果真结束
返回 (-4) ' ADODB创建失败

.子程序 导出高级表格数据_SUPERREN, 整数型, 公开, 可将高级表格的数据导出来MDB及XLS文件
.参数 高级表格, 未知类型0x20001, , 
.参数 保存文件名, 文本型, , 根据欲保存的文件扩展名导出目标格式。

.局部变量 mdb文件名, 文本型, , , 
.局部变量 I, 整数型, , , 
.局部变量 变体型1, 变体型, , , 
.局部变量 变体型2, 变体型, , , 
.局部变量 对象型1, 对象, , , 
.局部变量 对象型, 对象, , , 
.局部变量 ADODB连接, 对象, , , 
.局部变量 连接文本, 文本型, , , 
.局部变量 sql, 文本型, , , 
.局部变量 当前记录集, 对象, , , 
.局部变量 表名, 文本型, , , 
.局部变量 文本标题, 文本型, , , 
.局部变量 J, 整数型, , , 
.局部变量 字段, 文本型, , , 

.如果真 (等于 (高级表格., 0))
    返回 (-1) ' 没有数据，不需保存
.如果真结束

.如果真 (不等于 (未知函数_67174487 (保存文件名), “xls”))
    .如果真 (不等于 (未知函数_67174487 (保存文件名), “mdb”))
        返回 (-2) ' 欲保存的文件格式不正确
    .如果真结束
    
.如果真结束
.如果真 (文件是否存在 (保存文件名))
    返回 (-3) ' 目标文件已存在
.如果真结束
 ' 创建表结构
.计次循环首 (高级表格., I)
    .如果 (不等于 (高级表格., I))
        赋值 (文本标题, 相加 (文本标题, 删全部空 (高级表格.未知支持库函数_10 (0, 相减 (I, 1))), “,”))
        赋值 (字段, 相加 (字段, 删全部空 (高级表格.未知支持库函数_10 (0, 相减 (I, 1))), “ TEXT,”))
    .否则
        赋值 (文本标题, 相加 (文本标题, 删全部空 (高级表格.未知支持库函数_10 (0, 相减 (I, 1)))))
        赋值 (字段, 相加 (字段, 删全部空 (高级表格.未知支持库函数_10 (0, 相减 (I, 1))), “ TEXT”))
    .如果结束
    
.计次循环尾 ()
 ' 过滤特殊字符
赋值 (文本标题, 子文本替换 (文本标题, “/”, , , , 真))
赋值 (字段, 子文本替换 (字段, “/”, , , , 真))
赋值 (文本标题, 子文本替换 (文本标题, “'”, , , , 真))
赋值 (字段, 子文本替换 (字段, “'”, , , , 真))
赋值 (文本标题, 子文本替换 (文本标题, #引号, , , , 真))
赋值 (字段, 子文本替换 (字段, #引号, , , , 真))

.如果 (等于 (未知函数_67174487 (保存文件名), “xls”))
    赋值 (mdb文件名, 相加 (取单独文件名 (保存文件名), “.mdb”))
.否则
    赋值 (mdb文件名, 保存文件名)
.如果结束
 ' 创建MDB数据库
创建MDB数据库 (mdb文件名)
 ' 默认表名
赋值 (表名, “高级表格数据”)
.如果真 (ADODB连接.创建 (“ADODB.Connection”, ))
     ' 连接MDB数据库
    赋值 (连接文本, 相加 (“Provider=Microsoft.Jet.OLEDB.4.0;Data Source=”, mdb文件名))
    ADODB连接.写属性 (“connectionstring”, 连接文本)
    ADODB连接.方法 (“open”, )
    赋值 (“Errors”.读对象型属性 ())
    .如果真 (等于 (是否为空 (), 假))
        0.赋值 ()
        赋值 (“Item”.读对象型属性 ())
        .如果真 (等于 (是否为空 (), 假))
            输出调试文本 (相加 (“错误原因:”, “Description”.读文本属性 ()))
            返回 (-6) ' 连接MDB文件失败
        .如果真结束
        
    .如果真结束
    
    当前记录集.创建 (“ADODB.RecordSet”, )
    变体型2.赋值 (ADODB连接, )
     ' 创建表及表结构
    赋值 (sql, 相加 (“CREATE TABLE  ”, 表名, “ (”, 字段, “)”))
    变体型1.赋值 (sql, )
    当前记录集.方法 (“open”, 变体型1, 变体型2, 1, 1)
    赋值 (对象型, ADODB连接.读对象型属性 (“Errors”, ))
    .如果真 (等于 (是否为空 (), 假))
        变体型1.赋值 (0, )
        赋值 (对象型, 对象型.读对象型属性 (“Item”, 变体型1))
        .如果真 (等于 (是否为空 (), 假))
            输出调试文本 (相加 (“错误原因:”, 对象型.读文本属性 (“Description”, )))
            返回 (-5) ' 表结构创建失败
        .如果真结束
        
    .如果真结束
    
     ' 逐行逐行的将高级表格的数据写进MDB数据库
    .计次循环首 (相减 (高级表格., 1), I)
        处理事件 ()
        赋值 (sql, “”)
        .计次循环首 (高级表格., J)
            处理事件 ()
            .如果 (不等于 (高级表格., J))
                赋值 (sql, 相加 (sql, “'”, 高级表格.未知支持库函数_10 (I, 相减 (J, 1)), “',”))
            .否则
                赋值 (sql, 相加 (sql, “'”, 高级表格.未知支持库函数_10 (I, 相减 (J, 1)), “'”))
            .如果结束
            
        .计次循环尾 ()
        赋值 (sql, 相加 (“insert into ”, 表名, “ (”, 文本标题, “) values (”, sql, “) ”))
        变体型1.赋值 (sql, )
        当前记录集.方法 (“open”, 变体型1, 变体型2, 1, 1)
        
    .计次循环尾 ()
     ' 如保存类型为XLS，将MDB数据库内容转换为XLS格式
    .如果真 (等于 (未知函数_67174487 (保存文件名), “xls”))
        赋值 (sql, 相加 (“SELECT * INTO [Excel 8.0;Database=”, 保存文件名, “].”, 表名, “ FROM ”, 表名))
        变体型1.赋值 (sql, )
        当前记录集.方法 (“open”, 变体型1, 变体型2, 1, 1)
        
        赋值 (“Errors”.读对象型属性 ())
        .如果真 (等于 (是否为空 (), 假))
            0.赋值 ()
            赋值 (“Item”.读对象型属性 ())
            .如果真 (等于 (是否为空 (), 假))
                输出调试文本 (相加 (“错误原因:”, “Description”.读文本属性 ()))
                返回 (-6) ' 转换为XLS失败
            .如果真结束
            
        .如果真结束
        
        当前记录集.方法 (“Close”, )
        ADODB连接.方法 (“Close”, )
         ' 如保存类型为XLS，删除临时创建的MDB数据库
        删除文件 (mdb文件名)
    .如果真结束
    返回 (0) ' 导出成功，返回0
.如果真结束
返回 (-4) ' ADODB创建失败

.子程序 取后缀名, 文本型, , 返回小写格式的后缀名
.参数 文件名, 文本型, , 写入文件完整地址，取得文件后缀名

返回 (到小写 (取文本右边 (文件名, 相减 (取文本长度 (文件名), 倒找文本 (文件名, “.”, , 假)))))


.子程序 取文件名, 文本型, , 取文件名(路径文件名)
.参数 路径文件名, 文本型, , 写入文件完整地址，取得文件名

返回 (取文本右边 (路径文件名, 相减 (取文本长度 (路径文件名), 倒找文本 (路径文件名, “\”, , 假))))

.子程序 取单独文件名, 文本型, , 返回文件名，无后缀名
.参数 文件名, 文本型, , 写入文件完整名称，不带地址，取得完整文件名

返回 (取文本左边 (文件名, 相减 (倒找文本 (文件名, “.”, , 假), 1)))

.子程序 创建MDB数据库, 空白型, , 
.参数 数据库文件名, 文本型, , 

.局部变量 ADOX, 对象, , , 

ADOX.创建 (“ADOX.Catalog”, )
ADOX.通用方法 (“Create”, 相加 (“Provider=Microsoft.Jet.OLEDB.4.0;Data Source=”, 数据库文件名))
ADOX.清除 ()


 ' 不属于任何一个程序集、类模块的函数：
