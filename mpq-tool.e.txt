 ' 文件类型：Windows窗口程序

 ' 程序名称：MPQ操作
 ' 程序描述：离不开电脑
lbkdn@qq.com
能操作所有MPQ类型的文件，例如魔兽争霸和星际的地图文件等等。
 ' 程序作者：离不开电脑
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：离不开电脑
lbkdn@qq.com
离不开电脑
lbkdn@qq.com
能操作所有MPQ类型的文件，例如魔兽争霸和星际的地图文件等等。
 ' 版本号：1.0
 ' 创建号：0.0

窗口 窗口1
    左边 = 50
    顶边 = 50
    宽度 = 620
    高度 = 373
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 1
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 真
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 假
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “MPQ文件操作-离不开电脑制作”
    帮助文件名 = “”





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库



 ' 所需要的模块
 ' MPQ文件操作模块 D:\Program Files\绿色软件\易语言4.06sp1精简绿色版\ecom\MPQ操作模块.ec



.DLL命令 API_MakeSureDirectoryPathExists, 整数型, "IMAGEHLP.DLL", "MakeSureDirectoryPathExists", , 创建多级目录，DirPath完整路径的最后一个字符必须是\
    .参数 DirPath, 文本型, , 最后一个目录要以\结尾，例如 D:\123\322\332\22231\

.DLL命令 API_GetShortPathNameA, 整数型, "kernel32", "GetShortPathNameA", , 获取指定文件的短路径名　装载到lpszShortPath缓冲区的字符数量。如lpszShortPath的长度不足，不能容下文件名，就返回需要的缓冲区长度
    .参数 路径, 文本型, , 指定欲获取短路径名的那个文件的名字。可以是个完整路径，或者由当前目录决定
    .参数 缓冲区, 文本型, , 指定一个缓冲区，用于装载文件的短路径和文件名
    .参数 缓冲区长度, 整数型, , lpszShortPath缓冲区长度;

.DLL命令 CallWindowProc, 整数型, "user32", "CallWindowProcA", , 
    .参数 lpPrevWndFunc, 子程序指针, , 
    .参数 hWnd, 整数型, , 
    .参数 Msg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 整数型, , 

.DLL命令 DragAcceptFiles, 整数型, "shell32.dll", "DragAcceptFiles", , 
    .参数 hwnd, 整数型, , 
    .参数 fAccept, 整数型, , 

.DLL命令 DragQueryFile, 整数型, "shell32.dll", "DragQueryFileA", , 
    .参数 hDrop, 整数型, , 
    .参数 iFile, 整数型, , 
    .参数 lpszFile, 字节集, , 
    .参数 cch, 整数型, , 

.DLL命令 DragFinish, 整数型, "shell32.dll", "DragFinish", , 
    .参数 hDrop, 整数型, , 

.DLL命令 SetWindowLong, 子程序指针, "user32", "SetWindowLongA", , 
    .参数 hwnd, 整数型, , 
    .参数 nIndex, 整数型, , 
    .参数 dwNewLong, 子程序指针, , 

.程序集 程序集1, , , 

.程序集变量 procOld, 子程序指针, , , 
.子程序 _启动子程序, 整数型, , 本子程序在程序启动后最先执行
载入 (窗口1, , 假)
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 停止拖放支持, 空白型, 公开, 
.参数 句柄, 整数型, , 

SetWindowLong (句柄, -4, procOld)

.子程序 开始拖放支持, 空白型, 公开, 
.参数 句柄, 整数型, , 

DragAcceptFiles (句柄, 1)
赋值 (procOld, SetWindowLong (句柄, -4, &WindowProc))

.子程序 WindowProc, 整数型, 公开, 
.参数 hwnd, 整数型, , 
.参数 iMsg, 整数型, , 
.参数 wParam, 整数型, , 
.参数 lParam, 整数型, , 

.局部变量 a, 整数型, , , 

.如果真 (等于 (iMsg, 563))
    DropFiles (wParam)
    返回 (0)
.如果真结束
返回 (CallWindowProc (procOld, hwnd, iMsg, wParam, lParam))

.子程序 DropFiles, 空白型, 公开, 
.参数 hDrop, 整数型, , 

.局部变量 sFileName, 字节集, , , 
.局部变量 IReturn, 整数型, , , 
.局部变量 nCount, 整数型, , , 
.局部变量 a, 整数型, , , 

赋值 (sFileName, 取空白字节集 (260))
赋值 (nCount, DragQueryFile (hDrop, -1, sFileName, 260))
.计次循环首 (nCount, a)
    赋值 (sFileName, 取空白字节集 (260))
    赋值 (IReturn, DragQueryFile (hDrop, 相减 (a, 1), sFileName, 260))
    窗口1._关闭_被选择 ()
    赋值 (窗口1., 取字节集数据 (sFileName, 10, )) ' 只取第一个文件
    跳出循环 ()
     ' 列表框1.加入项目 (取字节集数据 (sFileName, 10, ), )
.计次循环尾 ()
DragFinish (hDrop)
赋值 (窗口1., SF打开MPQ文件 (窗口1.))
.如果 (等于 (窗口1., 0))
    窗口1._关闭_被选择 ()
    赋值 (窗口1., “MPQ文件操作-离不开电脑制作”)
.否则
    窗口1._扫描文件_被选择 ()
.如果结束
窗口1.激活 ()

.窗口程序集 窗口程序集1, , , 

.程序集变量 hMPQ, 整数型, , , 
.子程序 _窗口1_创建完毕, 空白型, , 
.局部变量 启动参数, 文本型, , "0", 

开始拖放支持 (取窗口句柄 ())
取命令行 (启动参数)
.如果真 (等于 (取数组成员数 (启动参数), 0))
    返回 ()
.如果真结束
.如果真 (文件是否存在 (启动参数 [1]))
    赋值 (., 启动参数 [1])
    赋值 (hMPQ, SF打开MPQ文件 (启动参数 [1]))
    .如果 (等于 (hMPQ, 0))
        赋值 (., “MPQ文件操作-离不开电脑制作”)
    .否则
        _扫描文件_被选择 ()
    .如果结束
    
.如果真结束


.子程序 _窗口1_将被销毁, 空白型, , 
SF关闭MPQ文件 (hMPQ)
停止拖放支持 (取窗口句柄 ())

.子程序 _窗口1_可否被关闭, 逻辑型, , 
.如果真 (等于 (信息框 (“是否退出程序？”, 相加 (1, #信息图标, #系统等待), ), 1))
    返回 (假)
.如果真结束


.子程序 _窗口1_尺寸被改变, 空白型, , 
赋值 (., 相减 (., 87))
赋值 (., 相减 (., 22))
赋值 (., 相减 (., 125))
赋值 (., 相加 (., 45))
赋值 (., 相加 (., 45))
赋值 (., 相加 (., 45))
赋值 (., 相加 (., 45))

.子程序 _打开_被选择, 空白型, , 
赋值 (., 0)
赋值 (., “地图文件|*.w3x;*.w3m;*.w3n;*.scx;*.scm;*.scn|mpq文件|*.mpq|所有文件|*.*”)
.如果真 (等于 (打开 (), 假))
    返回 ()
.如果真结束
_关闭_被选择 ()
赋值 (., .)
赋值 (hMPQ, SF打开MPQ文件 (.))
.如果 (等于 (hMPQ, 0))
    信息框 (“无法打开文件”, 相加 (#错误图标, #系统等待), )
.否则
    信息框 (“打开文件成功”, 相加 (#信息图标, #系统等待), )
    _扫描文件_被选择 ()
.如果结束


.子程序 _关闭_被选择, 空白型, , 
.如果真 (大于 (hMPQ, 0))
    SF关闭MPQ文件 (hMPQ)
.如果真结束
清空 ()
赋值 (., “”)
赋值 (., “就绪”)

.子程序 _退出_被选择, 空白型, , 
结束 ()

.子程序 _扫描文件_被选择, 空白型, , 
.局部变量 文件列表, 文本型, , "0", 
.局部变量 文件内容, 字节集, , , 
.局部变量 文本, 文本型, , , 
.局部变量 n, 整数型, , , 
.局部变量 m, 整数型, , , 
.局部变量 执行时间, 双精度小数型, , , 

.如果真 (等于 (hMPQ, 0))
    信息框 (“请先打开文件”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
赋值 (., “扫描文件中，请稍候。。。”)
清空 ()
禁止重画 ()
赋值 (执行时间, 取启动时间 ())
.如果真 (等于 (SF检测MPQ里的文件是否存在 (hMPQ, “(listfile)”), 1))
    SF直接读取MPQ里的文件 (hMPQ, “(listfile)”, 文件内容)
.如果真结束
.如果真 (并且 (文件是否存在 (相加 (取运行目录 (), “\list.txt”)), 小于 (取字节集长度 (文件内容), 1024)))
    赋值 (文件内容, 相加 (文件内容, 读入文件 (相加 (取运行目录 (), “\list.txt”))))
.如果真结束
赋值 (文本, 取字节集数据 (文件内容, 10, ))
赋值 (文件列表, 分割文本 (文本, #换行符, ))
.计次循环首 (取数组成员数 (文件列表), n)
    赋值 (文本, 到小写 (删首尾空 (文件列表 [n])))
    .如果真 (等于 (取文本长度 (文本), 0))
        到循环尾 ()
    .如果真结束
    .如果真 (等于 (SF检测MPQ里的文件是否存在 (hMPQ, 文本), 1))
        .如果 (或者 (等于 (到小写 (取文本右边 (., 4)), “.mpq”), 大于 (取项目数 (), 1500))) ' MPQ文件有内部列表，一般不需要检查重复项目，数据过大不进行重复检查,可以自己调用文本数据库来实现快速去除重复项。
            文本.加入项目 ()
        .否则
             ' 魔兽争霸，星际争霸的地图文件都不大，可以直接处理重复。
            .如果真 (等于 (取项目数 (), 0))
                文本.加入项目 ()
                到循环尾 ()
            .如果真结束
            .计次循环首 (取项目数 (), m) ' 遍历列表，如果不重复就加入列表
                .如果真 (等于 (相减 (m, 1).取项目文本 (), 文本))
                    跳出循环 ()
                .如果真结束
                .如果真 (等于 (取项目数 (), m))
                    文本.加入项目 ()
                .如果真结束
                
            .计次循环尾 ()
        .如果结束
        
    .如果真结束
    处理事件 ()
.计次循环尾 ()
赋值 (执行时间, 相除 (相减 (取启动时间 (), 执行时间), 1000))
允许重画 ()
赋值 (., 相加 (“扫描完毕，共找到”, 到文本 (取项目数 ()), “个文件，用了”, 到文本 (执行时间), “秒。”))

.子程序 _解压缩_被选择, 空白型, , 
.局部变量 文件内容, 字节集, , , 
.局部变量 文件名, 文本型, , , 
.局部变量 p, 整数型, , , 
.局部变量 n, 整数型, , , 
.局部变量 已选择项目, 整数型, , "0", 

.如果真 (等于 (取已选择项目数 (), 0))
    信息框 (“请选择要解压缩的文件”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
赋值 (已选择项目, 取所有被选择项目 ())
.计次循环首 (取数组成员数 (已选择项目), n)
    赋值 (文件名, 已选择项目.取项目文本 ( [n]))
    .如果真 (SF直接读取MPQ里的文件 (hMPQ, 文件名, 文件内容))
        创建多级目录 (相加 (., “目录\”, 取文本左边 (文件名, 倒找文本 (文件名, “\”, , 假))))
        写到文件 (相加 (., “目录\”, 文件名), 文件内容)
    .如果真结束
    
.计次循环尾 ()
信息框 (“解压缩文件成功”, 相加 (#信息图标, #系统等待), )

.子程序 _关于_被选择, 空白型, , 
信息框 (相加 (“本工具能扫描&解压缩任何MPQ类型的文件，无视任何加密，已开源。”, #换行符, “开源版本只能读，不能编辑MPQ文件。”, #换行符, “离不开电脑制作 lbkdn@qq.com”), 相加 (#信息图标, #系统等待), )

.子程序 _导出列表_被选择, 空白型, , 
.局部变量 n, 整数型, , , 
.局部变量 文件号, 整数型, , , 

.如果真 (等于 (取项目数 (), 0))
    信息框 (“请先扫描文件”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
赋值 (., 1)
赋值 (., “”)
赋值 (., “listfile.txt”)
.如果真 (等于 (打开 (), 假))
    返回 ()
.如果真结束
赋值 (文件号, 打开文件 (., 4, 4))
.如果真 (等于 (文件号, 0))
    信息框 (“创建文件失败”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
.计次循环首 (取项目数 (), n)
    写文本行 (文件号, 相减 (n, 1).取项目文本 ())
.计次循环尾 ()
关闭文件 (文件号)
信息框 (“解压缩文件成功”, 相加 (#信息图标, #系统等待), )

.子程序 _列表框_文件_列表项被选择, 空白型, , 
.如果真 (大于 (取已选择项目数 (), 0))
    赋值 (., 相加 (“已选中”, 到文本 (取已选择项目数 ()), “个文件；总共”, 到文本 (取项目数 ()), “个文件。”))
    赋值 (., 取焦点项目 ().取项目文本 ())
.如果真结束


.子程序 _列表框_文件_鼠标右键被按下, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

.如果真 (等于 (取已选择项目数 (), 0))
    返回 ()
.如果真结束
弹出菜单 ()

.子程序 _按钮_全选_被单击, 空白型, , 
.局部变量 n, 整数型, , , 

.如果真 (等于 (取项目数 (), 0))
    信息框 (“请先扫描文件”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
.计次循环首 (取项目数 (), n)
    相减 (n, 1).选择项目 (真)
.计次循环尾 ()
_列表框_文件_列表项被选择 ()

.子程序 _按钮_过滤_被单击, 空白型, , 
.局部变量 n, 整数型, , , 
.局部变量 分割结果, 文本型, , "0", 
.局部变量 m, 整数型, , , 
.局部变量 匹配项目, 文本型, , "0", 
.局部变量 文本, 文本型, , , 

.如果真 (等于 (取项目数 (), 0))
    信息框 (“请先扫描文件”, 相加 (#错误图标, #系统等待), )
    返回 ()
.如果真结束
赋值 (分割结果, 分割文本 (., “/”, ))
.计次循环首 (取数组成员数 (分割结果), n)
    赋值 (文本, 到小写 (删首尾空 (分割结果 [n])))
    .如果真 (大于 (取文本长度 (文本), 0))
        .计次循环首 (取项目数 (), m)
            .如果真 (等于 (取文本右边 (相减 (m, 1).取项目文本 (), 取文本长度 (分割结果 [n])), 文本))
                加入成员 (匹配项目, 相减 (m, 1).取项目文本 ())
            .如果真结束
            
        .计次循环尾 ()
    .如果真结束
    
.计次循环尾 ()
清空 ()
.计次循环首 (取数组成员数 (匹配项目), n)
    匹配项目.加入项目 ( [n], )
.计次循环尾 ()
赋值 (., 相加 (“匹配完毕，共找到”, 到文本 (取项目数 ()), “个。”))

.子程序 创建多级目录, 空白型, , 
.参数 目录, 文本型, , 例如 D:\123\ffsf\3453\dfgd

.如果真 (不等于 (取文本右边 (目录, 1), “\”))
    赋值 (目录, 相加 (目录, “\”))
.如果真结束
API_MakeSureDirectoryPathExists (目录)

.子程序 取短路径, 文本型, , 
.参数 路径, 文本型, , 

.局部变量 文本, 文本型, , , 
.局部变量 长度, 整数型, , , 

赋值 (长度, API_GetShortPathNameA (路径, “”, 0))
赋值 (文本, 取空白文本 (长度))
API_GetShortPathNameA (路径, 文本, 长度)
返回 (文本)

.程序集 __HIDDEN_TEMP_MOD__, , , 

.子程序 SF打开MPQ文件, 整数型, , 成功返回句柄，失败返回0
.参数 文件, 文本型, , 要打开的文件(例如:D:\abc.w3x或者123.mpq等等所有的MPQ类型文件),不能为空



.子程序 SF打开MPQ里的文件, 整数型, , 成功返回句柄，记得要关闭，失败返回0
.参数 句柄, 整数型, , 用"SF打开MPQ文件"获得,不能是0
.参数 文件, 文本型, , 要打开的文件(在MPQ文件里的完整路径,例如:"Scripts\war3map.j"),不能为空



.子程序 SF直接读取MPQ里的文件, 逻辑型, , 成功返回真
.参数 hMPQ, 整数型, , 用"SF打开MPQ文件"获得,不能是0
.参数 文件, 文本型, , 文件在MPQ里的完整路径,例如:"Scripts\war3map.j"
.参数 文件内容, 字节集, 参考, 返回字节集,可以用"写到文件"命令保存到外部文件.



.子程序 SF读取MPQ里的文件大小, 整数型, , 返回文件的大小(单位:字节)
.参数 hFile, 整数型, , 用"SF打开MPQ里的文件"获得,不能是0



.子程序 SF检测MPQ里的文件是否存在, 整数型, , 存在返回1，不存在返回0
.参数 hMPQ, 整数型, , 用"SF打开MPQ文件"获得,不能是0
.参数 文件, 文本型, , 要检测的文件(在MPQ文件里的完整路径,例如:"Scripts\war3map.j"),不能为空



.子程序 SF关闭MPQ里的文件, 逻辑型, , 关闭用"SF打开MPQ里的文件"命令打开的MPQ文件
.参数 hFile, 整数型, , 用"SF打开MPQ里的文件"获得,不能是0



.子程序 SF关闭MPQ文件, 逻辑型, , 关闭用"SF打开MPQ文件"命令打开的MPQ文件
.参数 hMPQ, 整数型, , 用"SF打开MPQ文件"获得,不能是0



.子程序 SF读取MPQ里的文件内容, 逻辑型, , 成功返回真
.参数 hFile, 整数型, , 用"SF打开MPQ里的文件"获得,不能是0
.参数 文件内容, 字节集, 参考, 请设置一个字节集变量，用于记录文件内容




 ' 不属于任何一个程序集、类模块的函数：
