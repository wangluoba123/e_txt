 ' 文件类型：Windows模块源码

 ' 程序名称：进程通信模块
 ' 程序描述：发送端与接收端设置不同的标志文本可实现双向通信。
可发送文件或图片，但最多只可正常发送40KB左右的数据。数据大小超过40KB少于93KB接收端将收到不完整的数据。
超过93KB左右将会溢出，接收端将接收到空字节集，无数据。
 ' 程序作者：易语言我吃了 制作
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 5 系统核心支持库





.DLL命令 SetWindowLong, 整数型, "", "SetWindowLongA", , 
    .参数 hwnd, 整数型, , 
    .参数 nIndex, 整数型, , 
    .参数 dwNewLong, 子程序指针, , 

.DLL命令 CallWindowProc2, 整数型, "user32", "CallWindowProcA", , 
    .参数 lpPrevWndFunc, 整数型, , 
    .参数 hwnd, 整数型, , 
    .参数 msg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 整数型, , 

.DLL命令 RegisterWindowMessage, 整数型, "", "RegisterWindowMessageA", , 
    .参数 lpString, 文本型, , 

.DLL命令 OpenProcess, 整数型, "kernel32", "OpenProcess", , 
    .参数 dwDesiredAccess, 整数型, , 
    .参数 bInheritHandle, 整数型, , 
    .参数 dwProcessId, 整数型, , 

.DLL命令 ReadProcessMemory, 整数型, "kernel32", "ReadProcessMemory", , 
    .参数 hProcess, 整数型, , 
    .参数 lpBaseAddress, 整数型, , 
    .参数 lpBuffer, 字节集, 传址, 
    .参数 nSize, 整数型, , 
    .参数 lpNumberOfBytesWritten, 整数型, , 

.DLL命令 CloseHandle, 整数型, "kernel32", "CloseHandle", , 
    .参数 hObject, 整数型, , 

.DLL命令 SendMessage, 整数型, "user32", "SendMessageA", , 
    .参数 hwnd, 整数型, , 
    .参数 wMsg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 字节集, 传址, 

.DLL命令 GetCurrentProcessId, 整数型, "kernel32", "GetCurrentProcessId", , 

.DLL命令 IsWindow, 逻辑型, "user32", "IsWindow", , 
    .参数 句柄, 整数型, , 

.DLL命令 FindWindow, 整数型, "user32", "FindWindowA", , 
    .参数 lpClassName, 文本型, , 
    .参数 lpWindowName, 文本型, , 

.DLL命令 CallWindowProc, 整数型, "user32", "CallWindowProcA", , 
    .参数 lpPrevWndFunc, 字节集, , 
    .参数 子程序, 子程序指针, , 
    .参数 参数, 字节集, , 
    .参数 参数, 字节集, , 
    .参数 参数, 字节集, , 

.程序集 程序集1, , , 易语言我吃了 制作

.程序集变量 oldlong, 整数型, , , 
.程序集变量 消息, 整数型, , , 
.程序集变量 数据, 字节集, , , 
.程序集变量 参数, 字节集, , "3", 
.程序集变量 指针, 子程序指针, , , 
.子程序 _启动子程序, 整数型, , 请在本子程序中放置易模块初始化代码

_临时子程序 () ' 在初始化代码执行完毕后调用测试代码
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 _临时子程序, 空白型, , 
 ' 本名称子程序用作测试程序用，仅在开发及调试环境中有效，编译发布程序前将被系统自动清空，请将所有用作测试的临时代码放在本子程序中。 ***注意不要修改本子程序的名称、参数及返回值类型。

 ' 发送端与接收端设置不同的标志文本可实现双向通信
 ' 可发送文件或图片，但最多只可正常发送40KB左右的数据。数据大小超过40KB少于93KB左右接收端将收到不完整的数据。
 ' 超过93KB左右将会溢出，接收端将接收到空字节集，无数据。

.子程序 接收端_开始监听, 逻辑型, , 成功返回真，失败返回假。
.参数 窗口句柄, 整数型, , 当前窗口句柄，可用 取窗口句柄() 得到。
.参数 标志文本, 文本型, , 可以为任意文本，但是不要和系统中已有的冲突。
.参数 回调函数, 子程序指针, 可空, 接收到信息后要触发的子程序，不需要可不填。
.参数 参数1, 字节集, 可空, 提供给回调函数的参数，类型为字节集，请将回调函数的参数类型也设为字节集，非字节集类型参数转换为字节集再使用，如果回调函数需要其它类型的参数，那么接收字节集参数后再转换为原类型，最后使用。不需要可不填。
.参数 参数2, 字节集, 可空, 如果不需要回调函数或回调函数不需要参数，可不填。
.参数 参数3, 字节集, 可空, 最多可提供三个参数。

赋值 (oldlong, SetWindowLong (窗口句柄, -4, &接收端_读数据))
赋值 (消息, RegisterWindowMessage (标志文本))
.如果真 (等于 (消息, 0))
    返回 (假)
.如果真结束
.如果真 (等于 (是否为空 (回调函数), 假))
    赋值 (指针, 回调函数)
    赋值 (参数 [1], 参数1)
    赋值 (参数 [2], 参数2)
    赋值 (参数 [3], 参数3)
.如果真结束
返回 (真)

.子程序 接收端_读数据, 整数型, , 
.参数 h, 空白型, , 
.参数 msg, 空白型, , 
.参数 wp, 空白型, , 
.参数 lp, 空白型, , 

.局部变量 hProcess, 整数型, , , 
.局部变量 lpBuffer, 字节集, , , 
.局部变量 len, 整数型, , , 

.如果真 (等于 (msg, 消息))
    赋值 (hProcess, OpenProcess (2035711, 0, 右移 (左移 (wp, 16), 16)))
    赋值 (len, 右移 (wp, 16))
    赋值 (lpBuffer, 取空白字节集 (len))
    ReadProcessMemory (hProcess, lp, lpBuffer, len, 0)
    赋值 (数据, lpBuffer)
    CloseHandle (hProcess)
    CallWindowProc ({ 85, 139, 236, 255, 117, 20, 255, 117, 16, 255, 117, 12, 255, 85, 8, 201, 194, 16, 0 }, 指针, 参数 [1], 参数 [2], 参数 [3])
.如果真结束
返回 (CallWindowProc2 (oldlong, h, msg, wp, lp))

.子程序 接收端_取出数据, 字节集, , 回调函数或其它子程序可用此子程序取出接收到的数据。
返回 (数据)

.子程序 发送端_发送数据, 逻辑型, , 成功返回真，失败返回假。
.参数 窗口句柄, 整数型, , 接收端的窗口句柄。
.参数 标志文本, 文本型, , 接收端监听时设置的文本。
.参数 欲发送的数据, 字节集, , 要发送的数据。

.局部变量 PID, 整数型, 静态, , 
.局部变量 msg, 整数型, , , 

赋值 (msg, RegisterWindowMessage (标志文本))
.如果真 (等于 (PID, 0))
    赋值 (PID, GetCurrentProcessId ())
.如果真结束
.如果真 (IsWindow (窗口句柄))
    SendMessage (窗口句柄, msg, 合并整数 (PID, 取字节集长度 (欲发送的数据)), 欲发送的数据)
    返回 (真)
.如果真结束
返回 (假)

.子程序 取得窗口句柄, 整数型, , 得到外部窗口的窗口句柄。
.参数 窗口类名, 文本型, 可空, 
.参数 窗口标题, 文本型, 可空, 两个参数选其一。

返回 (FindWindow (窗口类名, 窗口标题))


 ' 不属于任何一个程序集、类模块的函数：
