 ' 文件类型：Windows窗口程序

 ' 程序名称：
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 417
    高度 = 257
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “菜鸟学易――U盘防自启动”
    帮助文件名 = “”



.图片 图标, " ' 已保存到：D:\易语言学习\Data\U盘防自启动.e\图标", , 
.常量 WM_DEVICECHANGE, "537", , 驱动盘符被改变
.常量 DBT_DEVICEREMOVECOMPLETE, "32772", , 
.常量 DBT_DEVICERARRIVAL, "32768", , 
.常量 , , , 
.常量 DBT_DEVTYP_OEM, "0", , 
.常量 DBT_DEVTYP_DEVNODE, "1", , 
.常量 DBT_DEVTYP_VOLUME, "2", , 
.常量 DBT_DEVTYP_PORT, "3", , 
.常量 DBT_DEVTYP_N, "4", , 
.常量 无效的句柄值, "-1", 隐藏, 
.常量 属性设备描述, "0", 隐藏, 
.常量 属性硬件ID, "1", 隐藏, 
.常量 属性匹配设备ID, "2", 隐藏, 
.常量 属性服务, "4", 隐藏, 
.常量 属性设备类, "7", 隐藏, 
.常量 属性类GUID, "8", 隐藏, 
.常量 属性驱动, "9", 隐藏, 
.常量 属性配置标志, "10", 隐藏, 
.常量 属性硬件厂商名, "11", 隐藏, 
.常量 属性友好名, "12", 隐藏, 
.常量 属性LocationInformation, "13", 隐藏, 
.常量 属性物理设备对象名, "14", 隐藏, 
.常量 属性兼容, "15", 隐藏, 
.常量 属性UiNumber, "16", 隐藏, 
.常量 属性上层过滤驱动程序, "17", 隐藏, 
.常量 属性下层过滤驱动程序, "18", 隐藏, 
.常量 属性总线类型GUID, "19", 隐藏, 
.常量 属性LegacyBusType, "20", 隐藏, 
.常量 属性总线号, "21", 隐藏, 
.常量 属性枚举, "22", 隐藏, 
.常量 属性SECURITY, "23", 隐藏, 
.常量 属性SECURITY_SDS, "24", 隐藏, 
.常量 属性设备类型, "25", 隐藏, 
.常量 属性独占, "26", 隐藏, 
.常量 属性设备特征, "27", 隐藏, 
.常量 属性地址, "28", 隐藏, 
.常量 属性UiNumberDescFormat, "29", 隐藏, 
.常量 属性设备电源数据, "30", 隐藏, 
.常量 属性RemovalPolicy, "31", 隐藏, 
.常量 属性Hardware_Removal_Policy, "32", 隐藏, 
.常量 属性Removal_Policy_Override, "33", 隐藏, 
.常量 属性设备安装状态, "34", 隐藏, 
.常量 属性设备路径, "35", 隐藏, 
.常量 永远等待, "-1", 隐藏, 
.常量 立即返回, "1", 隐藏, 
.常量 等待, "2", 隐藏, 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库



 ' 所需要的模块
 ' U盘操作模块 C:\Documents and Settings\sks\桌面\usb.ec


数据类型 PDEV_BROADCAST_VOLUME, , 
    .成员 dbcv_size, 整数型, , , 14
    .成员 dbcv_devicetype, 整数型, , , 
    .成员 dbcv_reserved, 整数型, , , 
    .成员 dbcv_unitmask, 整数型, , , 
    .成员 dbcv_flags, 短整数型, , , 

数据类型 _DEV_BROADCAST_HDR, , 
    .成员 dbch_size, 整数型, , , 
    .成员 dbch_devicetype, 整数型, , , 
    .成员 dbch_reserved, 整数型, , , 

数据类型 _硬件信息, 公开, 
    .成员 设备描述, 文本型, , , 
    .成员 硬件ID, 文本型, , , 多段文本,已用换行符分割
    .成员 匹配设备ID, 文本型, , , 多段文本,已用换行符分割
    .成员 服务, 文本型, , , 
    .成员 设备类, 文本型, , , 
    .成员 类GUID, 文本型, , , 
    .成员 驱动, 文本型, , , 
    .成员 配置标志, 整数型, , , 
    .成员 硬件厂商名, 文本型, , , 
    .成员 友好名, 文本型, , , 
    .成员 LocationInformation, 文本型, , , 
    .成员 物理设备对象名, 文本型, , , 
    .成员 兼容, 整数型, , , 
    .成员 UiNumber, 整数型, , , 
    .成员 上层过滤驱动程序, 文本型, , , 多段文本,已用换行符分割
    .成员 下层过滤驱动程序, 文本型, , , 多段文本,已用换行符分割
    .成员 总线类型GUID, 字节集, , , 长度16
    .成员 LegacyBusType, 整数型, , , 
    .成员 总线号, 整数型, , , 
    .成员 枚举, 文本型, , , 
    .成员 SECURITY, 整数型, , , 没有实现,似乎没有什么用
    .成员 SECURITY_SDS, 整数型, , , 没有实现,似乎没有什么用
    .成员 设备类型, 整数型, , , 
    .成员 独占, 整数型, , , 
    .成员 设备特征, 整数型, , , 
    .成员 地址, 整数型, , , 
    .成员 UiNumberDescFormat, 文本型, , , 
    .成员 设备电源数据, 字节集, , , 
    .成员 RemovalPolicy, 整数型, , , 
    .成员 Hardware_Removal_Policy, 整数型, , , 
    .成员 Removal_Policy_Override, 整数型, , , 
    .成员 设备安装状态, 整数型, , , 
    .成员 设备路径, 文本型, , , 

数据类型 _设备信息数据, 公开, 
    .成员 结构尺寸, 整数型, , , 
    .成员 类GUID1, 整数型, , , 
    .成员 类GUID2, 整数型, , , 
    .成员 类GUID3, 整数型, , , 
    .成员 类GUID4, 整数型, , , 
    .成员 设备实例, 整数型, , , 
    .成员 保留, 整数型, , , 

数据类型 _移除U盘线程数据, 公开, 
    .成员 设备实例, 整数型, , , 该项不必初始化
    .成员 失败重试次数, 整数型, , , 
    .成员 失败重试延时, 整数型, , , 


.DLL命令 SetWindowLong, 子程序指针, "", "SetWindowLongA", , 
    .参数 hwnd, 整数型, , 
    .参数 nIndex, 整数型, , 
    .参数 value, 子程序指针, , 

.DLL命令 CallWindowProc, 整数型, "", "CallWindowProcA", , 
    .参数 proc, 子程序指针, , 
    .参数 hwnd, 整数型, , 
    .参数 msg, 整数型, , 
    .参数 wp, 整数型, , 
    .参数 lp, 整数型, , 

.DLL命令 复制结构体, 整数型, "", "RtlMoveMemory", , 
    .参数 dest, PDEV_BROADCAST_VOLUME, 传址, 
    .参数 source, 整数型, , 
    .参数 len, 整数型, , 14

.窗口程序集 窗口程序集1, , , 

.程序集变量 a, 子程序指针, , , 
.子程序 __启动窗口_创建完毕, 空白型, , 
置托盘图标 (#图标, “U盘防自启动(U盘病毒防护)”)

.子程序 MsgProc, 整数型, , 
.参数 hwnd, 整数型, , 
.参数 msg, 整数型, , 
.参数 wp, 整数型, , 
.参数 lp, 整数型, , 

.局部变量 val, PDEV_BROADCAST_VOLUME, , , 
.局部变量 i, 整数型, , , 
.局部变量 mask, 整数型, , , 

.判断开始 (等于 (msg, 537))
    .判断开始 (等于 (wp, #DBT_DEVICERARRIVAL)) ' 插入设备
        复制结构体 (val, lp, 14)
        .如果真 (等于 (val.dbcv_devicetype, #DBT_DEVTYP_VOLUME))
            赋值 (mask, val.dbcv_unitmask)
            .变量循环首 (0, 25, 1, i)
                .如果真 (等于 (位与 (mask, 1), 1))
                    跳出循环 ()
                .如果真结束
                赋值 (mask, 右移 (mask, 1))
            .变量循环尾 ()
            相加 (“USB磁盘被插入，盘符:”, 字符 (相加 (65, i)), #换行符).加入文本 ()
            检测 (字符 (相加 (65, i)))
        .如果真结束
        
    .判断 (等于 (wp, #DBT_DEVICEREMOVECOMPLETE)) ' 删除设备
        复制结构体 (val, lp, 14)
        .如果真 (等于 (val.dbcv_devicetype, #DBT_DEVTYP_VOLUME))
            赋值 (mask, val.dbcv_unitmask)
            .变量循环首 (0, 25, 1, i)
                .如果真 (等于 (位与 (mask, 1), 1))
                    跳出循环 ()
                .如果真结束
                赋值 (mask, 右移 (mask, 1))
            .变量循环尾 ()
            相加 (“USB磁盘被拔除，盘符:”, 字符 (相加 (65, i)), #换行符).加入文本 ()
        .如果真结束
        
    .默认
        
    .判断结束
    
.默认
    
.判断结束
返回 (CallWindowProc (a, hwnd, msg, wp, lp))

.子程序 __启动窗口_将被销毁, 空白型, , 
赋值 (a, SetWindowLong (_启动窗口.取窗口句柄 (), -4, a))

.子程序 检测, 空白型, , 
.参数 盘符, 文本型, , 

.局部变量 fn, 文本型, , , 

赋值 (fn, 寻找文件 (相加 (盘符, “:\*.*”), ))
.判断循环首 (不等于 (fn, “”))
    处理事件 ()
    .如果真 (等于 (到大写 (fn), 到大写 (“Autorun.inf”)))
        相加 (“■■■■”, 到文本 (取现行时间 ()), “”, #换行符).加入文本 ()
        相加 (“检测”, 盘符, “:\盘发现自启动运行文件!”, #换行符).加入文本 ()
        .如果 (文件更名 (相加 (盘符, “:\”, fn), 相加 (盘符, “:\”, fn, “.Shield”)))
            相加 (“屏蔽自启动运行文件成功!”, #换行符).加入文本 ()
        .否则
            相加 (“屏蔽自启动运行文件失败!”, #换行符).加入文本 ()
        .如果结束
        
    .如果真结束
    赋值 (fn, 寻找文件 ())
.判断循环尾 ()


.子程序 _按钮1_被单击, 空白型, , 
赋值 ()

.子程序 _按钮2_被单击, 空白型, , 
销毁 ()

.子程序 _按钮3_被单击, 空白型, , 
.局部变量 U盘盘符列表, 文本型, , "0", 
.局部变量 N, 整数型, , , 

赋值 (U盘盘符列表, 分割文本 (取U盘盘符列表 (), #换行符, ))
.计次循环首 (取数组成员数 (U盘盘符列表), N)
    检测 (取文本左边 (U盘盘符列表 [N], 1))
.计次循环尾 ()
信息框 (“扫描完成!”, #信息图标, )

.子程序 __启动窗口_托盘事件, 空白型, , 
.参数 操作类型, 整数型, , 

.判断开始 (等于 (操作类型, 1)) ' #单击左键
    赋值 (., 真)
    赋值 (_启动窗口., 0)
.判断 (等于 (操作类型, 2)) ' #双击
    
.判断 (等于 (操作类型, 3)) ' #单击右键
    弹出托盘菜单 ()
.默认
    
.判断结束


.子程序 _显示界面_被选择, 空白型, , 
赋值 (., 真)
赋值 (., 0)

.子程序 _隐藏界面_被选择, 空白型, , 
赋值 (., 2)
赋值 (_启动窗口., 假)

.子程序 _关于_被选择, 空白型, , 
信息框 (“双狮软件工作室  作者:TLSWR”, 0, _启动窗口.)

.子程序 _退出_被选择, 空白型, , 
销毁 ()

.程序集 __HIDDEN_TEMP_MOD__, , , 

.子程序 是U盘盘符, 逻辑型, , 
.参数 参文_盘符, 文本型, , 



.子程序 取U盘盘符列表, 文本型, , 001


.子程序 安全移除U盘, 整数型, , 配合[打开USB类设备信息,取下一个U盘,关闭USB类设备信息]使用
.参数 参_设备信息数据, _设备信息数据, , 该参数由'取下一个U盘'的第三个参数获得
.参数 参整_执行方式, 整数型, , #立即返回,#等待
.参数 参_线程数据, _移除U盘线程数据, , 



.子程序 禁用USB存储设备服务, 逻辑型, , 禁用驱动服务
.参数 参逻_禁止, 逻辑型, 可空, 



.子程序 强制移除U盘, 空白型, , 未实现的,在以后实现


.子程序 取U盘盘符数量, 整数型, , 002


.子程序 取U盘数量, 整数型, , 


.子程序 置U盘只读, 逻辑型, , 需要windows xp sp2支持
.参数 参逻_只读, 逻辑型, , 



.子程序 注册USB设备改变事件, 子程序指针, , 
.参数 参整_窗口句柄, 整数型, , 
.参数 参针_设备插入处理子程序, 子程序指针, , 
.参数 参针_设备移除处理子程序, 子程序指针, , 



.子程序 取消注册USB设备改变事件, 空白型, , 


.子程序 打开USB类设备信息, 整数型, , 


.子程序 取下一个U盘, 逻辑型, , 
.参数 参整_设备信息句柄, 整数型, , 
.参数 参整_设备索引, 整数型, 参考, 
.参数 参_设备信息数据, _设备信息数据, 可空, 写出当前U盘的设备信息数据



.子程序 关闭USB类设备信息, 逻辑型, , 
.参数 参整_设备信息句柄, 整数型, , 



.子程序 填充硬件信息, 空白型, , 
.参数 参整_设备信息句柄, 整数型, , 
.参数 参_设备信息数据, _设备信息数据, , 
.参数 参_硬件信息, _硬件信息, , 



.子程序 取硬件信息_i, 逻辑型, , 取硬件数值信息
.参数 参整_设备信息句柄, 整数型, , 
.参数 参整_设备信息数据, _设备信息数据, , 
.参数 参整_属性代码, 整数型, , 
.参数 参整_返回值, 整数型, 参考, 



.子程序 取硬件信息_t, 逻辑型, , 取硬件文本信息
.参数 参整_设备信息句柄, 整数型, , 
.参数 参_设备信息数据, _设备信息数据, , 
.参数 参整_属性代码, 整数型, , 
.参数 参文_缓冲区, 文本型, , 
.参数 参整_缓冲区尺寸, 整数型, 参考, in out



.子程序 关闭句柄, 逻辑型, , 
.参数 参整_句柄, 整数型, , 



.子程序 安全移除U盘独立, 整数型, , 如果请求了线程句柄,则返回线程的句柄值;否则返回0
.参数 参整_序号, 整数型, , 按枚举到U盘先后的顺序,从1开始;如果为0则移除所有U盘
.参数 参整_失败重试次数, 整数型, , 为空,则不重试
.参数 参整_失败重试延时, 整数型, , ms
.参数 参逻_请求线程句柄, 逻辑型, , 弹出U盘采用新线程方式,该参数为真,表示需要请求得到线程的句柄



.子程序 取线程退出代码, 逻辑型, , 
.参数 参整_线程句柄, 整数型, , 
.参数 参整_退出代码, 整数型, 参考, 



.子程序 等待事件对象, 整数型, , 
.参数 参整_事件句柄, 整数型, , 
.参数 参整_等待超时值, 整数型, , 



.子程序 取兼容文本, 文本型, , _硬件信息.兼容
.参数 参整_兼容代码, 整数型, , 



.子程序 取RemovalPolicy文本, 文本型, , _硬件信息.RemovalPolicy;_硬件信息.Hardware_Removal_Policy;_硬件信息.Removal_Policy_Override
.参数 参整_RemovalPolicy, 整数型, , 



.子程序 取设备安装状态文本, 文本型, , _硬件信息.设备安装状态
.参数 参整_设备安装状态, 整数型, , 



.子程序 取设备类型文本, 文本型, , _硬件信息.设备类型
.参数 参整_设备类型, 整数型, , 



.子程序 取LegacyBusType文本, 文本型, , 
.参数 参整_总线类型, 整数型, , 




 ' 不属于任何一个程序集、类模块的函数：
