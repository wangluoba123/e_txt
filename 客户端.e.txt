 ' 文件类型：Windows窗口程序

 ' 程序名称：
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 368
    高度 = 210
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' Exmlrpc A36CFD538657479eBD7C0D287BBB3D95 1 2 远程服务支持库
 ' EThread 5F99C1642A2F4e03850721B4F5D7C3F8 1 1 多线程支持库



 ' 所需要的模块
 ' 数据处理――数据打包解包 C:\Documents and Settings\user\桌面\E工程\JJYY数据库\数据处理――数据打包解包.ec



.窗口程序集 窗口程序集1, , , 

.程序集变量 待发送的文件列表, 文本型, , "0", 
.程序集变量 客户, 未知类型0x20002, , "0", 
.程序集变量 许可证, 整数型, , , 
.程序集变量 错误中断, 逻辑型, , , 
.程序集变量 线程数, 整数型, , , 
.程序集变量 线程状态, 整数型, , "0", 
.程序集变量 客户状态, 逻辑型, , "0", 
.程序集变量 文件号, 整数型, , , 
.程序集变量 现文件分包数, 整数型, , , 每个文件的分包数
.程序集变量 包序号, 整数型, , , 发送第几包
.程序集变量 每包数据长度, 整数型, , , 
.程序集变量 等待时间, 整数型, , , 
.程序集变量 速度计算, 长整数型, , , 
.子程序 _按钮_连接服务器_被单击, 空白型, , 
.局部变量 i, 整数型, , , 

赋值 (.标题, “正在连接服务器！”)
.计次循环首 (线程数, i)
    重定义数组 (客户, 真, i)
    .如果真 (客户.未知支持库函数_15 ( [i], 17853, .内容, 真, ))
        加入成员 (客户状态, 真)
        
    .如果真结束
    
.计次循环尾 ()
.如果真 (大于 (取数组成员数 (客户状态), 0))
    赋值 (.标题, 相加 (“连接成功了”, 到文本 (取数组成员数 (客户)), “条线程！”))
    返回 ()
.如果真结束
赋值 (.标题, “连接失败！”)

.子程序 _按钮_发送_被单击, 空白型, , 
.局部变量 封包, 字节集, , "0", 要加入封包的数据
.局部变量 临时, 字节集, , , 
.局部变量 i, 整数型, , , 


赋值 (错误中断, 假)
.如果真 (大于 (取数组成员数 (线程状态), 0))
    返回 ()
.如果真结束
.如果真 (小于 (取数组成员数 (待发送的文件列表), 1))
    
    赋值 (.时钟周期, 0)
    
    赋值 ({ 123 })
    1.未知支持库函数_18 (未知函数_67174558 (“全部完成”, ), , 2000)
    赋值 (.标题, “发送完成！”)
    
    返回 ()
.如果真结束
赋值 (文件号, 打开文件 (待发送的文件列表 [1], #读入, #禁止写))
.如果真 (等于 (文件号, 0))
    返回 ()
.如果真结束
赋值 (.内容, 待发送的文件列表 [1])
.如果 (大于 (求余数 (取文件长度 (文件号), 每包数据长度), 0))
    赋值 (现文件分包数, 相加 (相除 (取文件长度 (文件号), 每包数据长度), 1))
.否则
    赋值 (现文件分包数, 相除 (取文件长度 (文件号), 每包数据长度))
    
.如果结束
加入成员 (封包, 到字节集 (取文本右边 (待发送的文件列表 [1], 相减 (取文本长度 (待发送的文件列表 [1]), 倒找文本 (待发送的文件列表 [1], “\”, , 假))))) ' 文件名
加入成员 (封包, 到字节集 (现文件分包数))
.如果真 (不等于 (客户.未知支持库函数_18 ( [1], 打包数据 (“文件名”, 封包), 临时, 2000), 1))
    信息框 (“服务器响应超时！”, #错误图标, )
    返回 ()
.如果真结束
赋值 (.位置, 0)
赋值 (包序号, 0)
赋值 (.时钟周期, 1000)
.计次循环首 (线程数, i)
    加入成员 (线程状态, 1)
    未知支持库函数_0 (&发送数据, )
.计次循环尾 ()




.子程序 发送数据, 空白型, , 
.局部变量 服务器返回结果, 字节集, , , 
.局部变量 待发送数据内容, 字节集, , "1", 
.局部变量 执行情况, 整数型, , , 
.局部变量 本包顺序号, 整数型, , , 
.局部变量 i, 整数型, , , 
.局部变量 j, 整数型, , , 

.判断循环首 (真)
    .如果真 (错误中断)
         ' 信息框 (“错误中断！”, #错误图标, )
        返回 ()
    .如果真结束
    未知支持库函数_3 (许可证)
    赋值 (待发送数据内容 [1], 读入字节集 (文件号, 每包数据长度))
    .如果真 (等于 (待发送数据内容 [1], {  }))
        删除成员 (线程状态, 1, 1)
        .如果真 (等于 (取数组成员数 (线程状态), 0))
            关闭文件 (文件号)
            删除成员 (待发送的文件列表, 1, 1)
            _按钮_发送_被单击 ()
        .如果真结束
        未知支持库函数_4 (许可证)
        返回 ()
    .如果真结束
    赋值 (包序号, 相加 (包序号, 1)) ' 1表示第一包
    赋值 (本包顺序号, 包序号)
    赋值 (速度计算, 相加 (速度计算, 1))
    未知支持库函数_4 (许可证)
    .计次循环首 (5, i) ' 线程容错次数
        处理事件 ()
        .计次循环首 (取数组成员数 (客户状态), j)
            .如果真 (客户状态 [j])
                赋值 (客户状态 [j], 假)
                赋值 (执行情况, 客户.未知支持库函数_18 ( [j], 打包数据 (到文本 (本包顺序号), 待发送数据内容), 服务器返回结果, 等待时间))
                赋值 (客户状态 [j], 真)
                跳出循环 ()
            .如果真结束
            
        .计次循环尾 ()
        
        .如果真 (等于 (执行情况, 1))
             ' 正确
            .如果真 (等于 (到文本 (服务器返回结果), “OK”))
                赋值 (_启动窗口., 到文本 (包序号))
                赋值 (.位置, 相乘 (相除 (包序号, 现文件分包数), 100))
                跳出循环 ()
            .如果真结束
            .如果真 (等于 (i, 5))
                赋值 (错误中断, 真)
                删除成员 (线程状态, 1, 1)
                返回 ()
            .如果真结束
            到循环尾 ()
        .如果真结束
        .如果真 (等于 (执行情况, -1))
            赋值 (错误中断, 真)
            删除成员 (线程状态, 1, 1)
            信息框 (“未知错误，没有收到服务器的回答”, #错误图标, )
            返回 ()
             ' 求知错误，没有收到服务器的回答
        .如果真结束
        .如果真 (等于 (执行情况, 0))
             ' 超时
            赋值 (错误中断, 真)
            删除成员 (线程状态, 1, 1)
            信息框 (“服务器没有在规定时间内响应”, #错误图标, )
            返回 ()
        .如果真结束
        
    .计次循环尾 ()
    处理事件 ()
.判断循环尾 ()
删除成员 (线程状态, 1, 1)

.子程序 __启动窗口_创建完毕, 空白型, , 
赋值 (许可证, 未知支持库函数_1 ())
赋值 (每包数据长度, 102400)
赋值 (线程数, 5)

赋值 (等待时间, 5000)

.子程序 __启动窗口_将被销毁, 空白型, , 
未知支持库函数_2 (许可证)


.子程序 _按钮_打开_被单击, 空白型, , 
.局部变量 临时, 文本型, , "0", 
.局部变量 i, 整数型, , , 


赋值 (临时, 多文件对话框 (“请选择要发送的文件”, , , , ))
.计次循环首 (取数组成员数 (临时), i)
    加入成员 (待发送的文件列表, 临时 [i])
.计次循环尾 ()

.子程序 _时钟1_周期事件, 空白型, , 
.局部变量 临时, 长整数型, 静态, , 

赋值 (.标题, 相加 (到文本 (取整 (相乘 (相除 (相减 (速度计算, 临时), 1024), 每包数据长度))), “kB/s”))
赋值 (临时, 速度计算)
赋值 (.标题, “正在发送”)


.程序集 __HIDDEN_TEMP_MOD__, , , 

.子程序 打包数据, 字节集, , 返回打包后的数据
.参数 命令名, 文本型, , 
.参数 参数数组, 字节集, 可空 数组, 



.子程序 解包数据, 文本型, , 返回命令名
.参数 参数数组, 字节集, 参考 数组, 用作返回分解后的各个参数
.参数 数据包, 字节集, 参考, 用作接收要分解的数据包




 ' 不属于任何一个程序集、类模块的函数：
