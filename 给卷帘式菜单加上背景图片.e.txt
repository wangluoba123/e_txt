 ' 文件类型：Windows窗口程序

 ' 程序名称：利用APIHOOK修改窗口类名
 ' 程序描述：
 ' 程序作者：本源码来自易语言资源网(www.5A5X.com)
 ' 邮政编码：528251
 ' 联系地址：广东省佛山市南海区
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：lzj85@163.com
 ' 主页地址：
 ' 版权声明：             易语言资源网注意事项
--============   www.5A5X.com  =============--
* 易语言资源网为易语言官方站、易语言官方论坛提供辅助资源站；本易语言资源网( www.5A5X.com)所有软件和资料均为软件作者提供和网友推荐发布而来，其版权归该软件和程序源码的合法拥有者所有，本站易语言资源网整理收集仅供易语言用户学习和易语言技术研究探讨使用，不得用于任何商业用途。如果由于以上原因造成的版权纠纷本站概不负责！
* 本站资源未经许可,任何网站不得非法盗链及抄袭本站资源；如引用，请注明来自易语言资源网，谢谢合作！
--============   www.5A5X.com  =============--
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口
    左边 = 50
    顶边 = 50
    宽度 = 374
    高度 = 411
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “”
    帮助文件名 = “”



.图片 图片1, " ' 已保存到：D:\易语言学习\Data\给卷帘式菜单加上背景图片.e\图片1", , 
.图片 图片2, " ' 已保存到：D:\易语言学习\Data\给卷帘式菜单加上背景图片.e\图片2", , 
.常量 GWL_WNDPROC, "-4", , 
.常量 WM_KEYDOWN, "256", , 
.常量 WM_KEYUP, "257", , 
.常量 WM_SYSKEYDOWN, "260", , 按下Alt
.常量 WM_SYSKEYUP, "261", , 释放Alt
.常量 WM_CONTEXTMENU, "123", , 当用户某个窗口中点击了一下右键就发送此消息给这个窗口
.常量 WM_MOUSEMOVE, "512", , 移动鼠标
.常量 WM_LBUTTONDBLCLK, "515", , 双击鼠标左键
.常量 WM_LBUTTONDOWN, "513", , 鼠标左键按下
.常量 WM_LBUTTONUP, "514", , 鼠标左键抬起
.常量 , , , 
.常量 PAGE_EXECUTE_READWRITE, "64", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 5 0 系统核心支持库
 ' iext3 {B6F7542F-B8FE-46a8-9605-98856A687097} 3 0 扩展界面支持库三




数据类型 WNDCLASSEX, , 
    .成员 cbSize, 整数型, , , 
    .成员 style, 整数型, , , 
    .成员 lpfnWndProc, 整数型, , , 
    .成员 cbClsExtra, 整数型, , , 
    .成员 cbWndExtra, 整数型, , , 
    .成员 hInstance, 整数型, , , 
    .成员 hIcon, 整数型, , , 
    .成员 hCursor, 整数型, , , 
    .成员 hbrBackground, 整数型, , , 
    .成员 lpszMenuName, 文本型, , , 
    .成员 lpszClassName, 文本型, , , 
    .成员 hIconSm, 整数型, , , 

数据类型 矩形_, , RECT
    .成员 左边, 整数型, , , Left
    .成员 顶边, 整数型, , , Top
    .成员 右边, 整数型, , , Right
    .成员 底边, 整数型, , , Bottom

数据类型 坐标_, , POINTAPI
    .成员 横向位置, 整数型, , , x，横向位置
    .成员 纵向位置, 整数型, , , y，纵向位置

数据类型 尺寸_, , SIZE
    .成员 宽度, 整数型, , , width
    .成员 高度, 整数型, , , height


.DLL命令 SetWindowLongA, 子程序指针, "", "SetWindowLongA", , 
    .参数 hWnd, 整数型, , 
    .参数 nIndex, 整数型, , 
    .参数 dwNewLong, 子程序指针, , 

.DLL命令 CallWindowProcA, 整数型, "", "CallWindowProcA", , 
    .参数 lpPrevWndFunc, 子程序指针, , 
    .参数 hWnd, 整数型, , 
    .参数 Msg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 整数型, , 

.DLL命令 画矩形_, 整数型, "gdi32.dll", "Rectangle", , Rectangle
    .参数 设备场景句柄, 整数型, , hdc
    .参数 左上角横坐标, 整数型, , X
    .参数 左上角纵坐标, 整数型, , Y
    .参数 右下角横坐标, 整数型, , X1
    .参数 右下角纵坐标, 整数型, , Y1

.DLL命令 VirtualProtect, 逻辑型, "", "", , 
    .参数 lpAddress, 整数型, , 
    .参数 dwSize, 整数型, , 
    .参数 flNewProtect, 整数型, , 
    .参数 lpflOldProtect, 整数型, 传址, 

.DLL命令 GetProcAddress, 整数型, "", "", , 
    .参数 hModule, 整数型, , 
    .参数 lpProcName, 文本型, , 

.DLL命令 GetModuleHandleA, 整数型, "", "", , 
    .参数 lpModuleName, 文本型, , 

.DLL命令 CreatePatternBrush, 整数型, "", "CreatePatternBrush", , 
    .参数 位图句柄, 整数型, , 

.DLL命令 设置背景模式_, 整数型, "gdi32", "SetBkMode", , SetBkMode，Long，前一个背景模式的值
    .参数 设备场景句柄, 整数型, , hdc，设备场景的句柄
    .参数 方式, 整数型, , nBkMode，下述常数之一：OPAQUE用当前的背景色填充虚线画笔、阴影刷子以及字符的空隙TRANSPARENT透明处理，即不作上述填充

.DLL命令 填充矩形_, 整数型, "user32.dll", "FillRect", , FillRect,用指定的刷子填充一个矩形
    .参数 设备场景, 整数型, , hdc，设备场景的句柄
    .参数 填充区域, 矩形_, , lpRect，对填充区域进行描述的一个矩形，采用逻辑坐标
    .参数 刷子句柄, 整数型, , hBrush，欲使用的刷子的句柄

.DLL命令 扩展文本描绘_, 整数型, "gdi32.dll", "ExtTextOutA", , 经过扩展的文本描绘函数
    .参数 设备场景句柄, 整数型, , hdc,设备场景的句柄
    .参数 起点横坐标, 整数型, , X,以逻辑坐标表示的一个点，指定了绘图起点横坐标
    .参数 起点纵坐标, 整数型, , Y,以逻辑坐标表示的一个点，指定了绘图起点纵坐标
    .参数 标志常数, 整数型, , wOptions,标志常数的任意组合
    .参数 描绘的范围, 整数型, , lpRect,指定一个矩形，用于对文本进行格式化处理
    .参数 欲描绘的文本, 文本型, , lpString,欲描绘的字串
    .参数 文本长度, 整数型, , nCount,字串中要显示出来的字符数
    .参数 间距, 整数型, , lpDx,参见相关帮助

.DLL命令 取对象句柄_, 整数型, "gdi32", "GetStockObject", , 
    .参数 类型, 整数型, , 

.DLL命令 选入设备场景_, 整数型, "gdi32.dll", "SelectObject", , SelectObject
    .参数 场景句柄, 整数型, , hdc
    .参数 对象句柄, 整数型, , hobject

.DLL命令 删除对象_, 整数型, "gdi32.dll", "DeleteObject", , DeleteObject
    .参数 对象句柄, 整数型, , hObject,一个GDI对象的句柄

.DLL命令 WindowFromDC, 整数型, "", "WindowFromDC", , 
    .参数 hdc, 空白型, , 

.DLL命令 创建画笔_, 整数型, "gdi32", "CreatePen", , 
    .参数 风格, 整数型, , 
    .参数 宽度, 整数型, , 
    .参数 颜色, 整数型, , 

.DLL命令 释放设备场景_, 整数型, "user32", "ReleaseDC", , ReleaseDC
    .参数 窗口句柄, 整数型, , hwnd，要释放的设备场景相关的窗口句柄
    .参数 设备场景, 整数型, , hdc，要释放的设备场景句柄

.DLL命令 取设备场景_, 整数型, "user32", "GetDC", , 获取指定窗口的设备场景  指定窗口的设备场景句柄，出错则为0
    .参数 窗口的句柄, 整数型, , 将获取其设备场景的窗口的句柄。若为0，则要获取整个屏幕的DC;

.DLL命令 取窗口全部设备场景_, 整数型, "user32.dll", "GetWindowDC", , 
    .参数 窗口句柄, 整数型, , 

.DLL命令 取得边界矩形_, 整数型, "gdi32", "GetBoundsRect", , 
    .参数 设备场景句柄, 整数型, , hdc Long，边界矩形对应的设备场景 
    .参数 装载矩形, 矩形_, 传址, lprcBounds RECT，装载设备场景hdc的当前边界矩形 
    .参数 标识, 整数型, , flags Long，参见相关帮助

.DLL命令 取设备场景起点_, 整数型, "gdi32", "GetDCOrgEx", , 
    .参数 设备场景, 整数型, , 
    .参数 起点, 坐标_, 传址, 

.DLL命令 取得场景窗口范围_, 整数型, "gdi32.dll", "GetWindowExtEx", , 
    .参数 场景句柄, 整数型, , 
    .参数 尺寸, 尺寸_, , 

.DLL命令 取得窗口区域_, 整数型, "user32.dll", "GetWindowRgn", , 
    .参数 窗口句柄, 整数型, , 
    .参数 区域, 整数型, 传址, 

.DLL命令 取设备场景刷子颜色_, 整数型, "gdi32.dll", "GetDCBrushColor", , 
    .参数 设备场景句柄, 整数型, , hdc

.DLL命令 取背景色_, 整数型, "gdi32", "GetBkColor", , 取得指定设备场景当前的背景颜色
    .参数 设备场景句柄, 整数型, , hdc Long，欲查询背景颜色的一个设备场景

.窗口程序集 窗口程序集1, , , 

.子程序 __启动窗口_创建完毕, 空白型, , 

初始化卷帘式菜单底图 () ' 程序中只能调用一次

加入卷帘式菜单底图 (#图片1)
加入卷帘式菜单底图 (#图片2)
' 本源码来自易语言资源网(www.5A5X.com)

.子程序 __启动窗口_将被销毁, 空白型, , 
销毁卷帘式菜单底图 () ' 程序中只能调用一次


.程序集 置卷帘式菜单底图程序集, , , 

.程序集变量 函数地址, 整数型, , , 
.程序集变量 新指令, 字节集, , , 
.程序集变量 旧指令, 字节集, , , 
.程序集变量 OldProtect, 整数型, , , 
.程序集变量 卷帘菜单, 未知类型0x20001, , "0", 
.程序集变量 底图数据, 字节集, , "0", 
.子程序 初始化卷帘式菜单底图, 逻辑型, , 
.局部变量 a, 整数型, , , 

 ' --========  易语言资源网  (www.5A5X.com)  ======--
 ' 努力创建完善、持续更新的易语言学习例程源码资源站
 ' --================   www.5A5X.com  ===========--
 ' --==================   易语言资源网注意事项  ================--
 ' * 易语言资源网为易语言官方站、易语言官方论坛提供辅助资源站；
 ' 本易语言资源网( www.5A5X.com)所有软件和资料均为软件作者提
 ' 供和网友推荐发布而来，其版权归该软件和程序源码的合法拥有者所
 ' 有，本站易语言资源网整理收集仅供易语言用户学习和易语言技术研
 ' 究探讨使用，不得用于任何商业用途。如果由于以上原因造成的版权
 ' 纠纷本站概不负责！
 ' * 本站资源未经许可，任何网站不得非法盗链及抄袭本站资源；如引用
 ' 页面，请注明来自易语言资源网，谢谢合作！
 ' --=====================   www.5A5X.com  ================--

赋值 (函数地址, GetProcAddress (GetModuleHandleA (“gdi32.dll”), “ExtTextOutA”)) ' 获取API函数地址
.如果真 (等于 (函数地址, 0))
    返回 (假)
.如果真结束
VirtualProtect (函数地址, 8, 64, OldProtect) ' 把内存块设置为可读写

赋值 (新指令, 相加 ({ 184 }, 到字节集 (到整数 (&MyExtTextOutA)), { 255, 224 })) ' 生成新机器码数据
赋值 (旧指令, 指针到字节集 (函数地址, 8)) ' 保存旧机器码数据
 ' 本源码来自易语言资源网(www.5A5X.com)

写到内存 (新指令, 函数地址, 8) ' 开始拦截API
返回 (真)


.子程序 加入卷帘式菜单底图, 空白型, , 
.参数 卷帘式菜单, 未知类型0x20001, , 
.参数 底图, 字节集, , 


加入成员 (卷帘菜单, 卷帘式菜单)
加入成员 (底图数据, 底图)
赋值 (卷帘式菜单., 相加 (取数组成员数 (卷帘菜单), 20000000))
 ' 本源码来自易语言资源网(www.5A5X.com)

.子程序 MyExtTextOutA, 整数型, , 
.参数 hdc, 整数型, , hdc,设备场景的句柄
.参数 X, 整数型, , X,以逻辑坐标表示的一个点，指定了绘图起点横坐标
.参数 Y, 整数型, , Y,以逻辑坐标表示的一个点，指定了绘图起点纵坐标
.参数 wOptions, 整数型, , wOptions,标志常数的任意组合
.参数 lpRect, 整数型, , lpRect,指定一个矩形，用于对文本进行格式化处理
.参数 lpString, 文本型, , lpString,欲描绘的字串
.参数 nCount, 整数型, , nCount,字串中要显示出来的字符数
.参数 lpDx, 整数型, , lpDx,参见相关帮助

.局部变量 返回值, 整数型, , , 
.局部变量 图片, 对象, , , 
.局部变量 图片句柄, 空白型, , , 
.局部变量 hbrBack, 空白型, , , 
.局部变量 rc, 矩形_, , , 
.局部变量 tmp, 字节集, , , 
.局部变量 newhBr, 空白型, , , 
.局部变量 oldhBr, 空白型, , , 
.局部变量 newhPen, 空白型, , , 
.局部变量 oldhPen, 整数型, , , 
.局部变量 a, 空白型, , , 

写到内存 (旧指令, 函数地址, 8) ' 停止拦截API

.计次循环首 (取数组成员数 (卷帘菜单), a)
    .如果真 (等于 (取背景色_ (hdc), 卷帘菜单 [a], ))
        图片.创建图片对象 (底图数据 [a])
        赋值 (图片句柄, 图片.读数值属性 (“Handle”, ))
        设置背景模式_ (hdc, 1) ' TRANSPARENT = 1
        
        赋值 (hbrBack, CreatePatternBrush (图片句柄))
         ' 本源码来自易语言资源网(www.5A5X.com)
        赋值 (tmp, 指针到字节集 (lpRect, 16))
        赋值 (rc.左边, 取字节集数据 (tmp, #整数型, 1))
        赋值 (rc.顶边, 取字节集数据 (tmp, #整数型, 5))
        赋值 (rc.右边, 取字节集数据 (tmp, #整数型, 9))
        赋值 (rc.底边, 取字节集数据 (tmp, #整数型, 13))
        
        填充矩形_ (hdc, rc, hbrBack)
        删除对象_ (hbrBack)
        
        赋值 (newhPen, 创建画笔_ (0, 1, 卷帘菜单 [a], ))
        赋值 (newhBr, 取对象句柄_ (5)) ' NULL_BRUSH = 5
        赋值 (oldhPen, 选入设备场景_ (hdc, newhPen))
        赋值 (oldhBr, 选入设备场景_ (hdc, newhBr))
        画矩形_ (hdc, 0, 0, 卷帘菜单 [a], , 卷帘菜单 [a], )
        选入设备场景_ (hdc, oldhBr)
        选入设备场景_ (hdc, oldhPen)
        删除对象_ (oldhPen)
        
        赋值 (wOptions, 0)
        
        跳出循环 ()
        
    .如果真结束
    
.计次循环尾 ()
 ' 本源码来自易语言资源网(www.5A5X.com)
赋值 (返回值, 扩展文本描绘_ (hdc, X, Y, wOptions, lpRect, lpString, nCount, lpDx))

写到内存 (新指令, 函数地址, 8) ' 开始拦截API

返回 (返回值)


.子程序 销毁卷帘式菜单底图, 空白型, , 
.局部变量 tmp, 整数型, , , 
.局部变量 a, 整数型, , , 

.如果真 (不等于 (函数地址, 0))
    写到内存 (旧指令, 函数地址, 8)
    VirtualProtect (函数地址, 8, OldProtect, tmp) ' 卸载APIHOOK
    ' 本源码来自易语言资源网(www.5A5X.com)
.如果真结束





 ' 不属于任何一个程序集、类模块的函数：
