 ' 文件类型：Windows窗口程序

 ' 程序名称：3D图形演示程序2
 ' 程序描述：
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 640
    高度 = 480
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “点精灵演示”
    帮助文件名 = “”



.常量 顶点大小, "20", , 
.常量 , , , 
.常量 D3DFVF_PSIZE, "32", , 
.常量 D3DRS_POINTSPRITEENABLE, "156", , 
.常量 D3DRS_POINTSIZE_MIN, "155", , 
.常量 D3DRS_POINTSIZE_MAX, "166", , 
.常量 D3DRS_POINTSIZE, "154", , 
.常量 D3DRS_POINTSCALEENABLE, "157", , 
.常量 D3DRS_POINTSCALE_A, "158", , 
.常量 D3DRS_POINTSCALE_B, "159", , 
.常量 D3DRS_POINTSCALE_C, "160", , 
.常量 , , , 
.常量 度到弧, "0.01745329251944", , 
.常量 粒子常量_粒子总数, "250", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' ogrelib 2EAE87405D754ad780D8FE57432002EA 1 2 DirectX3D支持库




数据类型 顶点数据, , 
    .成员 顶点坐标, 四维向量, , , 顶点数据使用
    .成员 顶点颜色, 整数型, , , 顶点数据使用
    .成员 速度, 二维向量, , , 粒子 数据使用
    .成员 生命, 小数型, , , 粒子 数据使用
    .成员 缩放, 空白型, , , 粒子 数据使用
    .成员 角度, 空白型, , , 粒子 数据使用

数据类型 粒子属性, 公开, 
    .成员 向量, 二维向量, , , 
    .成员 颜色_始, 空白型, , , 
    .成员 颜色_终, 空白型, , , 
    .成员 生命_上限, 空白型, , , 
    .成员 生命_下限, 空白型, , , 
    .成员 角度, 空白型, , , 

数据类型 二维向量, 公开, 
    .成员 x, 小数型, , , 
    .成员 y, 小数型, , , 

数据类型 四维向量, 公开, 
    .成员 x, 小数型, , , 
    .成员 y, 小数型, , , 
    .成员 z, 小数型, , , 
    .成员 RHW, 小数型, , , 

.全局变量 全局粒子组, 顶点数据, , "1", 
.全局变量 数据, 字节集, , , 
.全局变量 全局粒子组起点, 空白型, , , 不同粒子系统共用一个数组，用此点区分各系统的分界

.DLL命令 复制内存, 整数型, "kernel32", "RtlMoveMemory", , 
    .参数 dest, 字节型, 传址, 
    .参数 source, 顶点数据, 传址, 
    .参数 numBytes, 空白型, , 

.窗口程序集 窗口程序集1, , , 

.程序集变量 设备, 未知类型0x20009, , , 
.程序集变量 顶点缓冲, 未知类型0x20013, , , 
.程序集变量 纹理组, 未知类型0x2000F, , "16", 
.程序集变量 灵活顶点标志, 整数型, , , 
.程序集变量 匿名程序集变量_245, 空白型, , , 
.程序集变量 透明度, 字节型, , , 
.程序集变量 匿名程序集变量_804, 空白型, , , 
.程序集变量 发射器A, 发射器类, , , 
.程序集变量 粒子系统1, 粒子类, , , 
.程序集变量 粒子系统2, 粒子类, , , 
.程序集变量 效果实例_加速度, 效果器A, , , 
.程序集变量 效果实例_引力, 效果器B, , , 
.程序集变量 mousex, 空白型, , , 
.程序集变量 mousey, 空白型, , , 
.子程序 初始化设备, 逻辑型, , 
.局部变量 参设备, 未知类型0x2001B, , , 

赋值 (参设备., 真)

赋值 (参设备., #)
赋值 (参设备., #)

赋值 (参设备., #)
赋值 (灵活顶点标志, 位或 (#, #))

.如果 (等于 (设备.未知支持库函数_144 (参设备, 取窗口句柄 (), #, #), 真))
     ' 设备.置渲染状态 (#渲染状态.背面剔除模式, #渲染状态值.顺时针剔除背面)
    返回 (真)
.否则
    返回 (假)
.如果结束


.子程序 初始化顶点缓冲, 逻辑型, , 
.局部变量 i, 整数型, , , 
.局部变量 图像文件名, 文本型, , , 


.计次循环首 (16, i)
    赋值 (图像文件名, 相加 (“spr\”, 到文本 (i), “.png”))
    .如果真 (等于 (未知支持库函数_255 (设备, 图像文件名, 纹理组 [i]), 假))
        输出调试文本 (“纹理创建错误！”)
        返回 (假)
    .如果真结束
    
.计次循环尾 ()


 ' .如果真 (等于 (未知支持库函数_256 (设备, “E:\TDdownload\Y2GE\Y2GEv0.01\Demo\resource\particles.png”, 128, 128, 0, #, #, #, -1, -1, 0, , , 纹理组), 假))
     ' 输出调试文本 (“纹理创建错误！”)
     ' ' 返回 (假)
.如果真结束



发射器A.创建 (0.5, 0.5, { 120, 255, 255, 0 }, { 10, 255, 0, 0 }, 3, 9, 60)
粒子系统1.创建 (发射器A, 100)
粒子系统2.创建 (发射器A, 50)
效果实例_加速度.初始化 (0, 0.1)
效果实例_引力.初始化 (相除 (.宽度, 2), 相除 (.宽度, 2), 0.05)

粒子系统1.追加效果器 (效果实例_引力)

粒子系统2.追加效果器 (效果实例_加速度)
 ' 粒子系统2.追加效果器 (效果实例_加速度)

赋值 (数据, 取空白字节集 (相乘 (40, 500)))

.如果 (等于 (设备.未知支持库函数_152 (取字节集长度 (数据), #, 灵活顶点标志, #, 顶点缓冲), 真))
    
    返回 (真)
.否则
    返回 (假)
.如果结束


.子程序 __启动窗口_被激活, 空白型, , 
.如果真 (等于 (初始化设备 (), 假))
    输出调试文本 (“初始化设备错误！”)
    返回 ()
    
.如果真结束

.如果真 (等于 (初始化顶点缓冲 (), 假))
    输出调试文本 (“初始化顶点缓冲错误！”)
    销毁 ()
.如果真结束

赋值 (透明度, 255)

.子程序 渲染, 空白型, , 
.局部变量 tmp, 未知类型0x20004, , , 
.局部变量 x, 小数型, , , 
.局部变量 顶点, 顶点数据, , "4", 


赋值 (全局粒子组起点, 1) ' ***************  重要！每一帧必须置1，以使多个粒子系统共用一个数组

粒子系统1.绘画 (数据, mousex, mousey)
粒子系统2.绘画 (数据, 相除 (.宽度, 2), 相除 (.高度, 2))

顶点缓冲.未知支持库函数_88 (0, 数据)
设备.未知支持库函数_148 (1, 未知支持库函数_287 (255, 200, 200, 255), , , )

设备.未知支持库函数_134 (0, 纹理组)

.子程序 转2, 空白型, , 
.参数 参字节集, 字节集, 参考, 
.参数 参顶点数据, 顶点数据, 数组, 

.局部变量 i, 整数型, , , 
.局部变量 临字节集, 字节集, , , 
.局部变量 pb, 空白型, , , 

赋值 (pb, 1)

.计次循环首 (取数组成员数 (参顶点数据), i)
    复制内存 (参字节集 [pb], 参顶点数据 [i], #顶点大小)
    赋值 (pb, 相加 (pb, #顶点大小))
.计次循环尾 ()


.子程序 __启动窗口_创建完毕, 空白型, , 
赋值 (., 真)

.子程序 _时钟1_周期事件, 空白型, , 
渲染 ()

.子程序 _纵向滚动条1_位置被改变, 空白型, , 
赋值 (透明度, .位置)

.子程序 填充点结构, 空白型, 公开, 
.参数 x, 小数型, , 
.参数 y, 小数型, , 
.参数 color, 空白型, , 
.参数 size, 空白型, , 
.参数 点结构_, 顶点数据, 参考, 

赋值 (点结构_.顶点坐标.x, x)
赋值 (点结构_.顶点坐标.y, y)
赋值 (点结构_.顶点坐标.z, 0)
赋值 (点结构_.顶点坐标.RHW, 1)

赋值 (点结构_.顶点颜色, color)


.子程序 __启动窗口_鼠标位置被移动, 逻辑型, , 
.参数 横向位置, 整数型, , 
.参数 纵向位置, 整数型, , 
.参数 功能键状态, 整数型, , 

赋值 (mousex, 横向位置)
赋值 (mousey, 纵向位置)

.类模块 发射器类, , , 

.程序集变量 向量_x, 小数型, , , 
.程序集变量 向量_y, 小数型, , , 
.程序集变量 颜色_始, 字节型, , "4", 
.程序集变量 颜色_终, 字节型, , "4", 
.程序集变量 生命_上限, 小数型, , , 
.程序集变量 生命_下限, 小数型, , , 
.程序集变量 角度, 空白型, , , 
.程序集变量 私P, 空白型, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 创建, 空白型, 公开, 
.参数 速度X_, 小数型, , 
.参数 速度Y_, 小数型, , 
.参数 起始颜色_, 字节型, 数组, 
.参数 终了颜色_, 字节型, 数组, 
.参数 最大生命_, 小数型, , 
.参数 最小生命_, 小数型, , 
.参数 角度_, 小数型, , 

赋值 (向量_x, 速度X_)
赋值 (向量_y, 速度Y_)
赋值 (颜色_始, 起始颜色_)
赋值 (颜色_终, 终了颜色_)
赋值 (生命_上限, 最大生命_)
赋值 (生命_下限, 最小生命_)
赋值 (角度, 角度_)

置随机数种子 ()

.子程序 发射, 逻辑型, 公开, 
.参数 P, 顶点数据, 参考, 
.参数 x, 小数型, , 
.参数 y, 小数型, , 

.局部变量 tmp, 空白型, , , 
.局部变量 x_, 小数型, , , 
.局部变量 y_, 小数型, , , 
.局部变量 角度_, 小数型, , , 
.局部变量 ARGB, 字节型, , "4", 
.局部变量 i, 整数型, , , 

赋值 (P.顶点坐标.x, x)
赋值 (P.顶点坐标.y, y)

.如果 (等于 (生命_上限, 生命_下限))
    赋值 (P.生命, 生命_下限)
.否则
    
    赋值 (P.生命, 取随机数 (生命_下限, 生命_上限))
.如果结束

.如果 (不等于 (角度, 0))
    赋值 (角度_, 相乘 (取随机数 (1, 角度), #度到弧))
    旋转二维向量 (向量_x, 向量_y, 角度_, P.速度.x, P.速度.y)
    
.否则
    赋值 (P.速度.x, 向量_x)
    赋值 (P.速度.y, 向量_y)
.如果结束


 ' 处理粒子颜色  1=A ,2=R, 3=G, 4=B, 对每一颜色位，生成起始色到终止色之间的随机值
.计次循环首 (4, i)
    
    .判断开始 (等于 (颜色_始 [i], 颜色_终 [i]))
        赋值 (ARGB [i], 颜色_始 [i])
    .判断 (小于 (颜色_始 [i], 颜色_终 [i]))
        赋值 (ARGB [i], 取随机数 (颜色_始 [i], 颜色_终 [i]))
    .默认
        赋值 (ARGB [i], 取随机数 (颜色_终 [i], 颜色_始 [i]))
    .判断结束
    
.计次循环尾 ()

赋值 (P.顶点颜色, 未知支持库函数_287 (ARGB [1], ARGB [2], ARGB [3], ARGB [4]))
赋值 (P.缩放, 1)
赋值 (P.角度, 0)

返回 (真)

.子程序 取当前粒子序号, 整数型, , 最后一个发射粒子的数组下标
返回 (私P)

.类模块 效果器基类, , , 

.程序集变量 P, 空白型, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 取序号, 整数型, , 
返回 (P)

.子程序 效果, 空白型, , 
.参数 参粒子, 顶点数据, 参考 数组, 



.程序集 数学集, , , 

.子程序 旋转二维向量, 空白型, , 
.参数 x_, 小数型, , 
.参数 y_, 小数型, , 
.参数 角度, 小数型, , 
.参数 retx, 小数型, 参考, 
.参数 rety, 小数型, 参考, 

赋值 (rety, 相加 (相乘 (x_, 求正弦 (角度)), 相乘 (y_, 求余弦 (角度))))
赋值 (retx, 相减 (相乘 (x_, 求余弦 (角度)), 相乘 (y_, 求正弦 (角度))))

.子程序 点等赋值2, 空白型, , 
.参数 v1, 二维向量, 参考, 
.参数 v2, 二维向量, 参考, 

赋值 (v1.x, v2.x)
赋值 (v1.y, v2.y)

.子程序 点加赋值2, 空白型, , 
.参数 v1, 二维向量, 参考, 
.参数 v2, 二维向量, 参考, 

赋值 (v1.x, 相加 (v1.x, v2.x))
赋值 (v1.y, 相加 (v1.y, v2.y))

.子程序 点减赋值2, 空白型, , 
.参数 v1, 二维向量, 参考, 
.参数 v2, 二维向量, 参考, 

赋值 (v1.x, 相减 (v1.x, v2.x))
赋值 (v1.y, 相减 (v1.y, v2.y))


.子程序 点乘赋值2, 空白型, , 
.参数 v1, 二维向量, 参考, 
.参数 v2, 二维向量, 参考, 

赋值 (v1.x, 相乘 (v1.x, v2.x))
赋值 (v1.y, 相乘 (v1.y, v2.y))


.子程序 点乘赋值1, 空白型, , 
.参数 v1, 二维向量, 参考, 
.参数 v2, 小数型, , 

赋值 (v1.x, 相乘 (v1.x, v2))
赋值 (v1.y, 相乘 (v1.y, v2))


.子程序 点绝对值, 小数型, , 
.参数 v1, 二维向量, 参考, 

返回 (求平方根 (相加 (相乘 (v1.x, v1.x), 相乘 (v1.y, v1.y))))

.子程序 点标准化, 空白型, , 
.参数 v1, 二维向量, 参考, 

.局部变量 长度, 小数型, , , 

赋值 (长度, 求平方根 (相加 (相乘 (v1.x, v1.x), 相乘 (v1.y, v1.y))))

.如果真 (等于 (长度, 0))
    返回 ()
.如果真结束

赋值 (长度, 相除 (1, 长度))
点乘赋值1 (v1, 长度)


.类模块 粒子类, , , 

.程序集变量 私发射器, 发射器类, , , 
.程序集变量 粒子总数, 整数型, , , 
.程序集变量 效果器数组, 效果器基类, , "1", 
.程序集变量 粒子数组, 未知类型0x410103A9, , "1", 
.程序集变量 发射点, 二维向量, , , 
.程序集变量 本类起始, 空白型, , , 
.程序集变量 本类长度, 空白型, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 创建, 空白型, , 
.参数 参发射器, 发射器类, 参考, 
.参数 参粒子总数, 空白型, , 

赋值 (私发射器, 参发射器)

赋值 (粒子总数, 255)
.如果真 (并且 (小于或等于 (1, 粒子总数), 小于或等于 (粒子总数, 255)))
    赋值 (粒子总数, 参粒子总数)
.如果真结束

重定义数组 (假, 粒子总数)
数组清零 (效果器数组)

重置 ()

.子程序 重置, 空白型, , 
.局部变量 i, 整数型, , , 
.局部变量 P, 空白型, , , 

.计次循环首 (取数组成员数 (), i)
    私发射器.发射 ( [i], 0, 0)
.计次循环尾 ()

.子程序 置粒子总数, 空白型, , 
.参数 参粒子数, 空白型, , 

重定义数组 (假, 参粒子数)
重置 ()

.子程序 置发射器, 空白型, , 
.参数 参发射器, 发射器类, 参考, 

赋值 (私发射器, 参发射器)
重置 ()

.子程序 追加效果器, 空白型, , 
.参数 参效果器, 效果器基类, 参考, 

加入成员 (效果器数组, 参效果器)


.子程序 清除效果器, 空白型, , 
.参数 是否删除, 逻辑型, , 删除？或是清零？

.如果 (是否删除)
    重定义数组 (效果器数组, 假, 0)
.否则
    数组清零 (效果器数组)
.如果结束


.子程序 刷新, 空白型, , 
.局部变量 i, 整数型, , , 

.计次循环首 (取数组成员数 (), i)
    赋值 ( [i], 顶点坐标.x, 相加 ( [i], 顶点坐标.x,  [i], 速度.x))
    赋值 ( [i], 顶点坐标.y, 相加 ( [i], 顶点坐标.y,  [i], 速度.y))
    
    赋值 ( [i], 生命, 相减 ( [i], 生命, 0.1))
    .如果真 (小于或等于 ( [i], 生命, 0))
        私发射器.发射 ( [i], 发射点.x, 发射点.y)
    .如果真结束
    
.计次循环尾 ()

.计次循环首 (取数组成员数 (效果器数组), i)
    效果器数组.效果 ( [i], )
.计次循环尾 ()

.子程序 绘画, 空白型, 公开, 将类内的顶点数据传到全局字节集中
.参数 参数据_out, 字节集, 参考, 
.参数 x, 小数型, , 
.参数 y, 小数型, , 

.局部变量 i, 整数型, , , 
.局部变量 pb, 空白型, , , 
.局部变量 临时粒子, 顶点数据, , , 

刷新 ()
赋值 (发射点.x, x)
赋值 (发射点.y, y)
赋值 (pb, 全局粒子组起点) ' 每一个粒子类实例调用后，都用升高此点,下一个实例将从此起始
 ' 输出调试文本 (取数组成员数 (粒子数组))
.计次循环首 (取数组成员数 (), i)
    
     ' 临时粒子.顶点坐标.x ＝ 粒子数组 [i].顶点坐标.x
     ' ' 输出调试文本 (临时粒子.顶点坐标.x)
     ' 临时粒子.顶点坐标.y ＝ 粒子数组 [i].顶点坐标.y
     ' ' 输出调试文本 (临时粒子.顶点坐标.y)
     ' 临时粒子.顶点坐标.RHW ＝ 1
     ' 临时粒子.顶点颜色 ＝ 粒子数组 [i].顶点颜色
    赋值 ( [i], 顶点坐标.RHW, 1)
    复制内存 (数据 [pb],  [i], #顶点大小)
    赋值 (pb, 相加 (pb, #顶点大小))
.计次循环尾 ()
赋值 (全局粒子组起点, pb)

.子程序 取存活粒子数, 整数型, , 
返回 (取数组成员数 ())

.程序集 内存集, , , 

.程序集变量 可用栈, 字节型, , "1", 
.程序集变量 Max, 空白型, , , 
.程序集变量 栈顶, 空白型, , , 可利用栈的栈顶
.子程序 数据重置, 空白型, , 
赋值 (Max, 0)
赋值 (栈顶, 0)

.子程序 数组管理_初始化, 逻辑型, , 
.参数 参全局粒子总数, 空白型, , 

.局部变量 i, 空白型, , , 

.如果真 (小于 (参全局粒子总数, 1))
    返回 (假)
.如果真结束

数据重置 ()

赋值 (Max, 参全局粒子总数)
重定义数组 (全局粒子组, 假, Max)
重定义数组 (可用栈, 假, Max)
赋值 (i, Max)
输出调试文本 (“-----------  数组管理初始化 ----------------”)
.计次循环首 (Max, )
    push (i)
    赋值 (i, 相减 (i, 1))
.计次循环尾 ()
输出调试文本 (相加 (“全局粒子组大小=”, 到文本 (取数组成员数 (全局粒子组))))
返回 (真)

.子程序 push, 逻辑型, , 
.参数 数据, 空白型, , 

.如果真 (或者 (小于 (栈顶, 1), 大于或等于 (栈顶, Max)))
    返回 (假)
.如果真结束
赋值 (栈顶, 相加 (栈顶, 1))
赋值 (可用栈 [栈顶], 数据)
返回 (真)

.子程序 pop, 逻辑型, , 
.参数 数据, 空白型, 参考, 

.如果真 (小于或等于 (栈顶, 1))
    返回 (假)
.如果真结束
赋值 (数据, 可用栈 [栈顶])
赋值 (栈顶, 相减 (栈顶, 1))
返回 (真)

.类模块 效果器A, 效果器基类, , 

.程序集变量 私向量, 二维向量, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 初始化, 空白型, , 
.参数 x, 小数型, , 
.参数 y, 小数型, , 

赋值 (私向量.x, x)
赋值 (私向量.y, y)

.子程序 效果, 空白型, 公开, 
.参数 参粒子, 顶点数据, 参考 数组, 

.局部变量 i, 整数型, , , 

.计次循环首 (取数组成员数 (参粒子), i)
    赋值 (参粒子 [i], 速度.x, 相加 (参粒子 [i], 速度.x, 私向量.x))
    赋值 (参粒子 [i], 速度.y, 相加 (参粒子 [i], 速度.y, 私向量.y))
    
.计次循环尾 ()

.类模块 效果器B, 效果器基类, , 

.程序集变量 私向量, 二维向量, , , 
.程序集变量 引力, 小数型, , , 
.子程序 _初始化, 空白型, , 当基于本类的对象被创建后，此方法会被自动调用


.子程序 _销毁, 空白型, , 当基于本类的对象被销毁前，此方法会被自动调用


.子程序 初始化, 空白型, , 
.参数 x, 小数型, , 
.参数 y, 小数型, , 
.参数 引力_, 小数型, , 

赋值 (私向量.x, x)
赋值 (私向量.y, y)
赋值 (引力, 引力_)


.子程序 效果, 空白型, 公开, 
.参数 参粒子, 顶点数据, 参考 数组, 

.局部变量 i, 整数型, , , 
.局部变量 v1, 二维向量, , , 
.局部变量 v2, 二维向量, , , 

.计次循环首 (取数组成员数 (参粒子), i)
    赋值 (v2.x, 参粒子 [i], 顶点坐标.x)
    赋值 (v2.y, 参粒子 [i], 顶点坐标.y)
    点等赋值2 (v1, 私向量)
    点减赋值2 (v1, v2)
    点标准化 (v1)
    点乘赋值1 (v1, 引力)
    点加赋值2 (参粒子 [i], 速度, v1)
.计次循环尾 ()


 ' 不属于任何一个程序集、类模块的函数：
