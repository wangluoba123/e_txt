 ' 文件类型：Windows窗口程序

 ' 程序名称：西风软件--在线更新V1.0
 ' 程序描述：程序编辑：张夕峰
论坛号 15PC

QQ： 1818899
 ' 程序作者：
 ' 邮政编码：
 ' 联系地址：
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口
    左边 = 50
    顶边 = 50
    宽度 = 380
    高度 = 175
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 真
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 真
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “”
    帮助文件名 = “”





 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 4 系统核心支持库
 ' internet 707ca37322474f6ca841f0e224f4b620 1 0 互联网支持库
 ' shell 52F260023059454187AF826A3C07AF2A 1 0 操作系统界面功能支持库
 ' eCompress 7B68736E818E41c5A28B0AE4D43C128C 1 0 压缩解压支持库
 ' eAPI F7FC1AE45C5C4758AF03EF19F18A395D 1 1 应用接口支持库





.窗口程序集 窗口程序集1, , , 

.程序集变量 本地版本号, 文本型, , , 
.程序集变量 升级版本文件, 文本型, , , 
.程序集变量 升级版本文件名称, 文本型, , , 
.程序集变量 服务器版本地址, 文本型, , , 
.程序集变量 升级后运行, 文本型, , , 
.程序集变量 下载到, 文本型, , , 
.程序集变量 软件名字, 文本型, , , 
.程序集变量 服务器地址, 文本型, , , 
.程序集变量 configUP, 文本型, , , 
.程序集变量 Txt, 文本型, , , 
.程序集变量 服务器版本号, 文本型, , , 
.程序集变量 Gb1, 文本型, , , 
.程序集变量 Gb2, 文本型, , , 
.程序集变量 Gb3, 文本型, , , 
.程序集变量 Gb4, 文本型, , , 
.程序集变量 Gb5, 文本型, , , 
.子程序 __启动窗口_创建完毕, 空白型, , 
赋值 (., 假)
赋值 (本地版本号, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Ver”, “1.0”))
赋值 (服务器地址, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Server1”, “www.15kx.com”))
赋值 (服务器版本地址, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Banben”, “/update/updateceshi.txt”))
赋值 (configUP, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “configUP”, “/update/configUPceshi.txt”))
赋值 (Txt, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Txt”, “/update/txt.txt”))
赋值 (升级后运行, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “End”, “西风.exe”))
赋值 (Gb1, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Gb1”, “西风.exe”))
赋值 (Gb2, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Gb2”, “西风.exe”))
赋值 (Gb3, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Gb3”, “西风.exe”))
赋值 (Gb4, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Gb4”, “西风.exe”))
赋值 (Gb5, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Gb5”, “西风.exe”))
赋值 (下载到, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Soft”, “\Update\”))
赋值 (软件名字, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Name”, “西风自动更新”))
赋值 (_启动窗口., 软件名字)
隐藏检测 ()

.子程序 隐藏检测, 空白型, , 挂接在主程序运行中的
.局部变量 www, 字节集, , , 

赋值 (www, 未知支持库函数_7 (相加 (“http://”, 服务器地址, 服务器版本地址)))
赋值 (服务器版本号, 取字节集数据 (www, #文本型, ))
.如果真 (等于 (连线测试 (服务器地址), 假)) ' 检查服务器是否正常，及网址拼写是否正确
    信息框 (相加 (“连接更新服务器失败！”, #换行符, #换行符, “请尝试更换更新服务器或到网站下载最新版本！”), 相加 (#错误图标, #确认钮), “版本号出错：”)
    赋值 (.禁止, 假)
    赋值 (.禁止, 假)
    赋值 (., 真)
    赋值 (.标题, “请尝试更换更新服务器或到网站下载最新版本！”)
    返回 ()
.如果真结束
.判断开始 (等于 (服务器版本号, 本地版本号))
    结束 ()
.判断 (大于 (服务器版本号, 本地版本号))
    信息框 (相加 (“最新版本：”, 服务器版本号, “发布了！”, #换行符, #换行符, “    发现新版本！”), 相加 (#警告图标, #确认钮), 相加 (“发现新的版本：”, 服务器版本号, “确认后开始更新”))
    赋值 (.禁止, 假)
    赋值 (.禁止, 真)
    赋值 (.禁止, 真)
    赋值 (.可视, 真)
.判断 (小于 (服务器版本号, 本地版本号))
    .如果 (等于 (信息框 (相加 (“服务器版本：”, 服务器版本号, #换行符, #换行符, “您目前的版本为”, 本地版本号, #换行符, #换行符, “强烈建议您关闭现行的程序，进行更新修复！”, #换行符, #换行符, “确认要立刻修复吗？”), 相加 (#错误图标, #确认取消钮), “版本号出错：”), #确认钮))
        赋值 (.可视, 真)
    .否则
        
    .如果结束
    
.默认
    
.判断结束


.子程序 连接服务器, 空白型, , 
.局部变量 www, 字节集, , , 

赋值 (www, 未知支持库函数_7 (相加 (“http://”, 服务器地址, 服务器版本地址)))
赋值 (服务器版本号, 取字节集数据 (www, #文本型, ))
.如果真 (等于 (连线测试 (服务器地址), 假)) ' 检查服务器是否正常，及网址拼写是否正确
    信息框 (相加 (“连接更新服务器失败！”, #换行符, #换行符, “请尝试更换更新服务器或到网站下载最新版本！”), 相加 (#错误图标, #确认钮), “版本号出错：”)
    赋值 (.禁止, 假)
    赋值 (.禁止, 假)
    赋值 (.标题, “请尝试更换更新服务器或到网站下载最新版本！”)
    返回 ()
.如果真结束
.判断开始 (等于 (服务器版本号, 本地版本号))
    信息框 (相加 (“服务器暂时没有更新的版本  ”, #换行符, #换行符, “请稍后再试！”), 相加 (#警告图标, #确认钮), “版本无需更新：”)
    结束 ()
.判断 (大于 (服务器版本号, 本地版本号))
    检查更新内容 ()
.判断 (小于 (服务器版本号, 本地版本号))
    .如果 (等于 (信息框 (相加 (“服务器版本：”, 服务器版本号, #换行符, #换行符, “您目前的版本为”, 本地版本号, #换行符, #换行符, “强烈建议您关闭现行的程序，进行更新修复！”, #换行符, #换行符, “确认要立刻修复吗？”), 相加 (#错误图标, #确认取消钮), “版本号出错：”), #确认钮))
        赋值 (., 真)
        检查更新内容 ()
    .否则
        
    .如果结束
    
.默认
    
.判断结束


.子程序 检查更新内容, 空白型, , 先将服务器版本更新的内容下载到本地进行核对
.局部变量 AA, 字节集, , , 
.局部变量 BB, 字节集, , , 
.局部变量 CC, 字节集, , , 

赋值 (AA, 进度下载 (服务器地址, configUP, 真, , , , , , , ))
赋值 (BB, 进度下载 (服务器地址, Txt, 真, , , , , , , ))
创建目录 (相加 (取运行目录 (), 下载到))
.如果真 (不等于 (AA, {  }))
    写到文件 (相加 (取运行目录 (), 下载到, “configUP.ini”), AA)
.如果真结束
.如果真 (不等于 (BB, {  }))
    写到文件 (相加 (取运行目录 (), 下载到, “更新说明TXT.txt”), BB)
    未知支持库函数_6 (4, “更新说明TXT.txt”, , 相加 (取运行目录 (), 下载到))
.如果真结束
 ' ================================================================下面的是将下载下来的文件作为本地和服务器版本的文件比较
 ' ==========================以后也可以用这个功能进行强制性的比对，发现没有的就自动从服务器下载并且更新上
赋值 (升级版本文件, 读配置项 (相加 (取运行目录 (), 下载到, “\configUP.ini”), 相加 (本地版本号, “-”, 服务器版本号), “Update”, “/update/soft.zip”))
赋值 (升级版本文件名称, 读配置项 (相加 (取运行目录 (), 下载到, “\configUP.ini”), 相加 (本地版本号, “-”, 服务器版本号), “Name”, “soft.zip”))
赋值 (., 相加 (“正在更新下载(”, 升级版本文件名称, “)”))
赋值 (CC, 进度下载 (服务器地址, 升级版本文件, 真, , , , , , , ))
.如果 (不等于 (CC, {  }))
    写到文件 (相加 (取运行目录 (), 下载到, 升级版本文件名称), CC)
    开始升级 ()
.否则
    信息框 (“下载更新文件失败，如果多次出现这样的情况！请联系开发人员”, 相加 (#错误图标, #确认钮), “出错了！”)
.如果结束


.子程序 开始升级, 空白型, , 
处理事件 ()
.如果 (等于 (文件是否存在 (相加 (取运行目录 (), 下载到, 升级版本文件名称)), 真))
    .如果真 (等于 (信息框 (相加 (“       准备升级版本文件”, #换行符, #换行符, “确认前！请先关闭正在运行的程序！”), #确认钮, “最后一步：”), #确认钮))
        未知支持库函数_11 (Gb1)
        未知支持库函数_11 (Gb2)
        未知支持库函数_11 (Gb3)
        未知支持库函数_11 (Gb4)
        未知支持库函数_11 (Gb5) ' 自动关闭5个正在运行的程序
    .如果真结束
    .如果 (等于 (相加 (取运行目录 (), 下载到, 升级版本文件名称).未知支持库函数_2 (取运行目录 ()), 1))
        
    .否则
        信息框 (相加 (“解压缩文件失败，请联系开发人员”, #换行符, #换行符, “升级前请先关闭主程序！”), 相加 (#错误图标, #确认钮), “出错了！”)
    .如果结束
    
.否则
    信息框 (“找不到升级所支持的文件！”, 相加 (#错误图标, #确认钮), “出错了！”)
.如果结束


.子程序 _开始更新_被单击, 空白型, , 
.如果 (等于 (.取项目数值 (.现行选中项), 0))
    赋值 (服务器地址, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Server1”, “www.15kx.com”))
.否则
    赋值 (服务器地址, 读配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Server2”, “www.15kx.com”))
.如果结束
 ' 上面是判断用哪个服务器进行更新 0 对应网通服务器
赋值 (.禁止, 真)
赋值 (.禁止, 真)
赋值 (.禁止, 假)
赋值 (.标题, “正在连接更新服务器...”)
连接服务器 ()


.子程序 _ZIP压缩_解压缩进度, 逻辑型, , 
.参数 已完成百分比, 整数型, , 

赋值 (.位置, 已完成百分比)
赋值 (.标题, 未知支持库函数_3 ())
.如果真 (大于或等于 (已完成百分比, 100))
    写配置项 (相加 (取运行目录 (), “\update.ini”), “update”, “Ver”, 服务器版本号)
    赋值 (.标题, “更新完成！”)
    赋值 (., “更新完成！”)
    .如果真 (等于 (信息框 (相加 (“       升级完成！”, #换行符, #换行符, “退出后要自动运行主程序吗？”), #是否钮, “恭喜：”), #是钮))
        未知支持库函数_6 (4, 升级后运行, , 取运行目录 ())
    .如果真结束
    结束 ()
.如果真结束


.子程序 _取消更新_被单击, 空白型, , 
赋值 (.禁止, 假)
赋值 (.禁止, 假)
取消下载 ()


.子程序 _关闭_被单击, 空白型, , 
.判断开始 (等于 (信息框 (“真的要退出更新程序吗？”, 相加 (#警告图标, #确认取消钮), “询问：”), #确认钮))
    结束 ()
.默认
    
.判断结束


.程序集 _模块_进度下载模块, , , ** 不要更改此处 求真进度下载模块.ec

.子程序 进度下载, 字节集, , 
.参数 网址, 文本型, , 如：www.qzsa.net
.参数 路径, 文本型, , 如：file/123.zip
.参数 下载方式, 逻辑型, 可空, 真：续传。假：重新下载。默认为假
.参数 超时设置, 整数型, 可空, 如果小于0就不进行超时处理，单位：秒。为0或不进行设置时，则默认为300秒(5分钟)。不要设得太小，也不要设得太大。
.参数 进度条, 进度条, 参考 可空, 这个不用说了吧？
.参数 文件尺寸, 标签, 参考 可空, 单位：字节（Bit）
.参数 下载状态, 标签, 参考 可空, 
.参数 已下载, 标签, 参考 可空, 单位：字节（Bit）
.参数 下载速度, 标签, 参考 可空, 单位：KB/S
.参数 剩余时间, 标签, 参考 可空, 单位：秒

 ' ** 本子程序功能由系统自动转交对应模块实现，可以删除但不能修改。

.子程序 取消下载, 空白型, , 
 ' ** 本子程序功能由系统自动转交对应模块实现，可以删除但不能修改。

.子程序 连线测试, 逻辑型, , 未连接Internet返回假，反之返回真
.参数 网址, 文本型, 可空, 如果指定网址，将检测该网址是否能连接。如不指定，将检查是否已连接Internet

 ' ** 本子程序功能由系统自动转交对应模块实现，可以删除但不能修改。


 ' 不属于任何一个程序集、类模块的函数：
