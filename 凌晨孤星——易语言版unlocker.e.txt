 ' 文件类型：Windows窗口程序

 ' 程序名称：易语言版unlocker
 ' 程序描述：
 ' 程序作者：凌晨孤星
 ' 邮政编码：528251
 ' 联系地址：广东省佛山市南海区
 ' 联系电话：
 ' 传真号码：
 ' 电子信箱：
 ' 主页地址：
 ' 版权声明：
 ' 版本号：1.0
 ' 创建号：0.0

窗口 _启动窗口 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 622
    高度 = 390
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “凌晨孤星――易语言版unlocker”
    帮助文件名 = “”



.常量 进程模块, "1", , 
.常量 文件句柄, "2", , 
.常量 TH32CS_SNAPMODULE, "8", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 5 系统核心支持库
 ' iext 27bb20fdd3e145e4bee3db39ddd6e64c 1 2 扩展界面支持库一
 ' NTSysInfo 7A2323101B595F4DA291C2BAEAECAF8A 1 0 NT系统信息




数据类型 MODULEENTRY32, , 
    .成员 dwSize, 整数型, , , 
    .成员 th32ModuleID, 整数型, , , 
    .成员 th32ProcessID, 整数型, , , 
    .成员 GlblcntUsage, 整数型, , , 
    .成员 ProccntUsage, 整数型, , , 
    .成员 modBaseAddr, 整数型, , , 
    .成员 modBaseSize, 整数型, , , 
    .成员 hModule, 整数型, , , 
    .成员 szModule, 字节型, , "256", 数组：MAX_MODULE_NAME32+1。
    .成员 szExePath, 字节型, , "260", 数组：MAX_PATH。


.DLL命令 QueryDosDeviceA, 整数型, "kernel32.dll", "QueryDosDeviceA", , 
    .参数 lpDeviceName, 文本型, , 
    .参数 lpTargetPath, 文本型, , 
    .参数 ucchMax, 整数型, , 

.DLL命令 GetLogicalDriveStringsA, 整数型, "kernel32.dll", "GetLogicalDriveStringsA", , 
    .参数 nBufferLength, 整数型, , 
    .参数 lpBuffer, 字节集, , 

.DLL命令 PathFindFileNameA, 文本型, "Shlwapi.dll", "PathFindFileNameA", , 
    .参数 pPath, 文本型, , 

.DLL命令 GetShortPathNameA, 整数型, "", "GetShortPathNameA", , 
    .参数 lpszLongPath, 文本型, , 
    .参数 lpszShortPath, 文本型, , 
    .参数 cchBuffer, 整数型, , 

.DLL命令 OpenProcess, 整数型, "", "OpenProcess", , 
    .参数 dwDesiredAccess, 整数型, , 
    .参数 bInheritHandle, 整数型, , 
    .参数 dwProcessId, 整数型, , 

.DLL命令 CloseHandle, 逻辑型, "", "", , 
    .参数 hObject, 整数型, , 

.DLL命令 CreateToolhelp32Snapshot, 整数型, "", "CreateToolhelp32Snapshot", , 
    .参数 dwFlags, 整数型, , 
    .参数 th32ProcessID, 整数型, , 

.DLL命令 Module32First, 逻辑型, "", "", , 
    .参数 hSnapshot, 整数型, , 
    .参数 lpme, MODULEENTRY32, , 

.DLL命令 GetLongPathNameA, 整数型, "", "", , 
    .参数 lpszShortPath, 文本型, , 
    .参数 lpszLongPath, 文本型, , 
    .参数 cchBuffer, 整数型, , 

.窗口程序集 窗口程序集1, , , 

.程序集变量 路径锁定, 文本型, , , 
.程序集变量 逻辑驱动器, 文本型, , "0", 
.程序集变量 DOS设备, 文本型, , "0", 
.子程序 __启动窗口_创建完毕, 空白型, , 


.子程序 EnumModuleCallback, 逻辑型, , 
.参数 进程ID, 整数型, , 
.参数 模块基址, 整数型, , 
.参数 文件路径, 文本型, , 
.参数 保留1, 整数型, , 
.参数 保留2, 整数型, , 

.局部变量 进程路径, 文本型, , , 
.局部变量 进程名称, 文本型, , , 
.局部变量 索引, 整数型, , , 

.如果真 (等于 (到小写 (路径锁定), 到小写 (取长路径名 (文件路径))))
    赋值 (进程路径, 取进程可执行文件路径 (进程ID, 进程名称))
    赋值 (索引, .插入表项 (进程名称, , , , ))
    索引.置标题 (1, 到文本 (进程ID))
    索引.置标题 (2, 路径锁定)
    索引.置标题 (3, 到文本 (#进程模块))
    索引.置标题 (4, 到文本 (模块基址))
    索引.置标题 (5, 进程路径)
    处理事件 ()
.如果真结束

返回 (真) ' 返回真则表示继续回调直到枚举结束，返回假则表示终止枚举。


.子程序 EnumHandleCallback, 逻辑型, , 
.参数 进程ID, 整数型, , 
.参数 句柄, 整数型, , 
.参数 类型, 文本型, , 
.参数 名称, 文本型, , 
.参数 保留, 整数型, , 

.局部变量 n, 整数型, , , 
.局部变量 win文件路径, 文本型, , , 
.局部变量 进程名称, 文本型, , , 
.局部变量 进程路径, 文本型, , , 
.局部变量 索引, 整数型, , , 

.计次循环首 (取数组成员数 (DOS设备), n)
    .如果真 (等于 (寻找文本 (名称, DOS设备 [n], , 假), 1))
         ' 把路径中类似于 \Device\HarddiskVolume1 的部分用 C:、D:等对应代替
        赋值 (win文件路径, 到小写 (取长路径名 (子文本替换 (名称, DOS设备 [n], 逻辑驱动器 [n], 1, 1, 假))))
        .如果真 (等于 (win文件路径, 到小写 (路径锁定))) ' 约定用小写比较进程路径
            赋值 (进程路径, 取进程可执行文件路径 (进程ID, 进程名称))
            赋值 (索引, .插入表项 (进程名称, , , , ))
            索引.置标题 (1, 到文本 (进程ID))
            索引.置标题 (2, 路径锁定)
            索引.置标题 (3, 到文本 (#文件句柄))
            索引.置标题 (4, 到文本 (句柄))
            索引.置标题 (5, 进程路径)
            处理事件 ()
        .如果真结束
        
    .如果真结束
    
.计次循环尾 ()

返回 (真) ' 返回真则表示继续回调直到枚举结束，返回假则表示终止枚举。


.子程序 _解锁_被选择, 空白型, , 
.局部变量 进程ID, 整数型, , , 
.局部变量 现行选中项, 整数型, , , 

赋值 (现行选中项, .)
.如果真 (不等于 (现行选中项, -1))
    赋值 (进程ID, 到整数 (现行选中项.取标题 (1)))
    .判断开始 (等于 (现行选中项.取标题 (3), “1”))
        .如果真 (等于 (信息框 (“该类型为进程模块，卸载模块可能导致目标进程不稳定，甚至崩溃！”, 位或 (0, #是否钮, #询问图标), “是否继续？”), #是钮))
            .如果真 (未知支持库函数_2 (进程ID, 现行选中项.取标题 (2)))
                现行选中项.删除表项 ()
            .如果真结束
            
        .如果真结束
        
    .默认
        
        .如果真 (未知支持库函数_1 (进程ID, 到整数 (现行选中项.取标题 (4))))
            现行选中项.删除表项 ()
        .如果真结束
        
    .判断结束
    
.如果真结束


.子程序 _超级列表框1_右键单击表项, 空白型, , 
.如果真 (不等于 (., -1))
    弹出菜单 ()
.如果真结束


.子程序 _按钮1_被单击, 空白型, , 
.如果真 (打开 ())
    赋值 (.内容, .文件名)
.如果真结束


.子程序 _按钮2_被单击, 空白型, , 
.局部变量 n, 整数型, , , 
.局部变量 文本, 文本型, , , 

.如果真 (等于 (.内容, “”))
    返回 ()
.如果真结束
赋值 (_启动窗口., “凌晨孤星――易语言版unlocker......正在处理，请稍候。。。”)
赋值 (.禁止, 真)
清除数组 (DOS设备)
清除数组 (逻辑驱动器)
赋值 (路径锁定, “”)
全部删除 ()

取逻辑驱动器字符串 (逻辑驱动器)
.计次循环首 (取数组成员数 (逻辑驱动器), n)
    加入成员 (DOS设备, 查询DOS设备 (逻辑驱动器 [n]))
.计次循环尾 ()
赋值 (路径锁定, 取长路径名 (.内容))
赋值 (文本, .内容)
未知支持库函数_0 (相加 (“/M”, PathFindFileNameA (文本)), 到整数 (&EnumModuleCallback))
未知支持库函数_0 (“/HFile”, 到整数 (&EnumHandleCallback))

赋值 (_启动窗口., “凌晨孤星――易语言版unlocker”)
赋值 (.禁止, 假)

.程序集 程序集1, , , 

.子程序 查询DOS设备, 文本型, , 
.参数 驱动器名称, 文本型, , 

.局部变量 缓冲区, 文本型, , , 

赋值 (缓冲区, 取空白文本 (260))
QueryDosDeviceA (驱动器名称, 缓冲区, 260)
返回 (缓冲区)

.子程序 取逻辑驱动器字符串, 逻辑型, , 
.参数 驱动器字符串数组, 文本型, 参考 数组, 

.局部变量 缓冲区, 字节集, , , 
.局部变量 缓冲区大小, 整数型, , , 
.局部变量 数组, 字节集, , "0", 
.局部变量 驱动器数目, 整数型, , , 
.局部变量 n, 整数型, , , 

赋值 (缓冲区大小, GetLogicalDriveStringsA (0, {  }))
赋值 (缓冲区, 取空白字节集 (缓冲区大小))
GetLogicalDriveStringsA (缓冲区大小, 缓冲区) ' 获取逻辑驱动器文本
赋值 (数组, 分割字节集 (缓冲区, { 0 }, ))
赋值 (驱动器数目, 相减 (取数组成员数 (数组), 1))
.如果真 (小于 (驱动器数目, 1))
    返回 (假)
.如果真结束
重定义数组 (驱动器字符串数组, 假, 驱动器数目)
.计次循环首 (驱动器数目, n)
    赋值 (缓冲区, 数组 [n])
    赋值 (缓冲区 [取字节集长度 (缓冲区)], 0)
    赋值 (驱动器字符串数组 [n], 到文本 (缓冲区))
.计次循环尾 ()
返回 (真)

.子程序 取短路径名, 文本型, , 
.参数 路径, 文本型, , 

.局部变量 缓冲区, 文本型, , , 

赋值 (缓冲区, 取空白文本 (相乘 (260, 2)))
GetShortPathNameA (路径, 缓冲区, 相乘 (260, 2))
返回 (缓冲区)

.子程序 取长路径名, 文本型, , 
.参数 路径, 文本型, , 

.局部变量 缓冲区, 文本型, , , 

赋值 (缓冲区, 取空白文本 (260))
GetLongPathNameA (路径, 缓冲区, 260)
返回 (缓冲区)


.子程序 取进程可执行文件路径, 文本型, , 
.参数 进程ID, 整数型, , 
.参数 可执行文件名, 文本型, 参考 可空, 

.局部变量 hSnapshot, 整数型, , , 
.局部变量 me, MODULEENTRY32, , , 
.局部变量 文件路径, 文本型, , , 

赋值 (hSnapshot, CreateToolhelp32Snapshot (#TH32CS_SNAPMODULE, 进程ID)) ' 快照
赋值 (me.dwSize, 相加 (相乘 (8, 4), 256, 260))
Module32First (hSnapshot, me) ' 取第一个进程模块
赋值 (文件路径, 到文本 (到字节集 (me.szExePath))) ' 获取模块的路径
.如果真 (等于 (是否为空 (可执行文件名), 假))
    赋值 (可执行文件名, 到文本 (到字节集 (me.szModule))) ' 获取模块名称
.如果真结束
CloseHandle (hSnapshot)
返回 (文件路径)


 ' 不属于任何一个程序集、类模块的函数：
