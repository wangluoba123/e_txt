 ' 文件类型：Windows模块源码

 ' 程序名称：在线更新模块
 ' 程序描述：    此模块不能加入到要更新的文件中，需要单独制作一个exe可执行程序，再调用它。

1.如果下载文件是ZIP文件,可以下载后自动展开到软件的目录下;
2.可指定某个EXE文件为自安装包,下载后自动运行展开在软件的目录下;
3.美化了升级普通窗口,使其小巧可爱.增加了大量的说明文字.一看即会用!
5.还是使用了EDB文件,但改进了安全性,一打开就关闭,不会破坏数据库文件.
6.支持版本识别,并且更新后自动更改本地版本.
7.增加导入功能,可将以前的EDB列表文件导入新库,这样可加快录入.
8.可以增加一层目录.自建文件夹.
9.可以不弹出主窗口,先检查再升级,弹出一个最小的窗口,也是需要单独编译运行.
10.2.0以上版本采用多线程操作方式，修正了1.0不能更新到文件夹的错误并且美化了界面。

    其中的生成列表是用来创建下载列表的.
    注:前提是你要把要更新的文件和文件列表传送到服务器上。

 ' 程序作者：
 ' 邮政编码：116001
 ' 联系地址：辽宁省大连市人民路55号1008室
 ' 联系电话：0411-88995831
 ' 传真号码：0411-88995834
 ' 电子信箱：
 ' 主页地址：http://www.dywt.com.cn
 ' 版权声明：
 ' 版本号：2.4
 ' 创建号：0.0

窗口 窗口升级 ' 在程序启动后自动调入本窗口
    左边 = 50
    顶边 = 50
    宽度 = 494
    高度 = 377
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “更新”
    帮助文件名 = “”

窗口 窗口列表
    左边 = 50
    顶边 = 50
    宽度 = 553
    高度 = 337
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “列表生成”
    帮助文件名 = “”

窗口 最小化升级
    左边 = 50
    顶边 = 50
    宽度 = 399
    高度 = 123
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 假
    禁止 = 假
    边框 = 4
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 假
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “检查新版本!”
    帮助文件名 = “”

窗口 调用演示窗口
    左边 = 50
    顶边 = 50
    宽度 = 380
    高度 = 250
    鼠标指针 = { 0,0,0,0 }
    标记 = “”
    可视 = 真
    禁止 = 假
    边框 = 2
    底图方式 = 1
    底色 = -16777216 '  0xFF000000
    最大化按钮 = 假
    最小化按钮 = 假
    控制按钮 = 真
    位置 = 1
    可否移动 = 真
    背景音乐播放次数 = 0
    回车下移焦点 = 假
    Esc键关闭 = 真
    F1键打开帮助 = 假
    帮助标志值 = 0
    在任务栏中显示 = 真
    随意移动 = 假
    外形 = 0
    总在最前 = 假
    保持标题栏激活 = 假
    底图 =  ' 空
    图标 =  ' 空
    背景音乐 =  ' 空
    标题 = “在线更新模块 V2.4 - 调用演示”
    帮助文件名 = “”



.图片 图片1, " ' 已保存到：D:\易语言学习\Data\模块_在线更新2.4.e\图片1", , 
.图片 图片2, " ' 已保存到：D:\易语言学习\Data\模块_在线更新2.4.e\图片2", , 


 ' 所需要的支持库：
 ' krnln d09f2340818511d396f6aaf844c7e325 4 2 系统核心支持库
 ' iext 27bb20fdd3e145e4bee3db39ddd6e64c 1 1 扩展界面支持库一
 ' INTERNET 707ca37322474f6ca841f0e224f4b620 1 0 互联网支持库
 ' SHELL 52F260023059454187AF826A3C07AF2A 1 0 操作系统界面功能支持库
 ' EThread 5F99C1642A2F4e03850721B4F5D7C3F8 1 1 多线程支持库
 ' eCompress 7B68736E818E41c5A28B0AE4D43C128C 1 0 压缩解压支持库
 ' xplib 7F54B9CE8887428dBA9CEEB94CEF4C72 1 1 XP风格界面库





.DLL命令 给出窗口标题, 整数型, "", "GetWindowTextA", , 窗体标题
    .参数 窗口句柄, 整数型, , 
    .参数 lpString, 文本型, , 
    .参数 cch, 整数型, , 

.DLL命令 投递消息, 整数型, "", "PostMessageA", , 
    .参数 窗口句柄, 整数型, , 
    .参数 wMsg, 整数型, , 
    .参数 wParam, 整数型, , 
    .参数 lParam, 整数型, , 

.DLL命令 IsWindow, 整数型, "", "IsWindow", , 
    .参数 hwnd, 空白型, , 

.DLL命令 SendMessage, 整数型, "", "SendMessageA", , 
    .参数 hwnd, 整数型, , 
    .参数 wmsg, 整数型, , 
    .参数 wparam, 整数型, , 
    .参数 lparam, 整数型, , 

.DLL命令 查找窗口, 整数型, "", "FindWindowExA", , 
    .参数 窗口句柄1, 整数型, , 
    .参数 窗口句柄2, 整数型, , 
    .参数 lpsz1, 整数型, , 
    .参数 lpsz2, 整数型, , 

.程序集 程序集1, , , 

.子程序 _启动子程序, 整数型, , 请在本子程序中放置易模块初始化代码
_临时子程序 () ' 在模块初始化代码执行完毕后调用模块测试代码
返回 (0) ' 可以根据您的需要返回任意数值

.子程序 _临时子程序, 空白型, , 
 ' 本名称子程序用作测试程序用，仅在开发及调试环境中有效，编译发布程序前将被系统自动清空，请将所有用作测试的临时代码放在本子程序中。 ***注意不要修改本子程序的参数及返回值类型。
载入 (调用演示窗口, , 真)

.窗口程序集 更新程序集, , , 

.程序集变量 文本字, 文本型, , , 
.程序集变量 软件标题, 文本型, , , 
.程序集变量 自定义欢迎文本, 文本型, , , 
.程序集变量 更新列表地址, 文本型, , , 
.程序集变量 是否搜寻正在运行的程序, 逻辑型, , , 
.程序集变量 要搜寻的程序标题, 文本型, , , 
.程序集变量 窗口句柄, 整数型, , , 
.程序集变量 文件2, 整数型, , , 
.程序集变量 文件1, 整数型, , , 
.程序集变量 文件, 整数型, , , 
.程序集变量 是否已更新, 逻辑型, , , 
.程序集变量 许可证1, 整数型, , , 
.程序集变量 许可证2, 整数型, , , 
.程序集变量 自动安装EXE文件名, 文本型, , , 
.程序集变量 展开ZIP文件数, 整数型, , , 
.程序集变量 自动EXE安装文件数, 整数型, , , 
.子程序 _窗口升级_创建完毕, 空白型, , 
赋值 (展开ZIP文件数, 0)
赋值 (自动EXE安装文件数, 0)
赋值 (窗口升级., 342)
赋值 (许可证1, 未知支持库函数_1 ())
赋值 (许可证2, 未知支持库函数_1 ())
赋值 (是否已更新, 假)
赋值 (.图片, #图片1)
.如果真 (等于 (打开 (相加 (未知支持库函数_7 (11), “\update.edb”), , , , , , ), 假)) ' 打开在“接口程序集”中创建的数据库
    信息框 (“创建数据失败！”, 16, )
    返回 ()
.如果真结束
赋值 (软件标题, 读 (1))
赋值 (更新列表地址, 读 (2))
赋值 (自定义欢迎文本, 读 (3))
赋值 (是否搜寻正在运行的程序, 读 (4))
赋值 (要搜寻的程序标题, 读 (5))
全部关闭 ()
.如果 (等于 (自定义欢迎文本, “”))
    赋值 (.标题, 相加 (“此更新程序将安装或更新 ”, 软件标题, “ 组件到您的计算机。”, #换行符, #换行符, “如果您想退出此更新程序，请点击”, #左引号, “退出”, #右引号, #换行符, “点击”, #左引号, “下一步”, #右引号, “开始更新！”, #换行符, #换行符, “注意：在更新之前一定要关闭所有相关”, 软件标题, “的程序！否则更新将会失败。”, #换行符, “请保证您的电脑已连接英特网.”))
.否则
    赋值 (.标题, 自定义欢迎文本)
.如果结束
赋值 (.标题, 相加 (“欢迎使用 ”, 软件标题, “ 更新”))
删除文件 (相加 (未知支持库函数_7 (11), “\update.edb”)) ' 删除这个数据库，没用了

.子程序 _按钮_完成_被单击, 空白型, , 
销毁 ()

.子程序 _时钟1_周期事件, 空白型, , 
赋值 (.时钟周期, 0)
未知支持库函数_0 (&下载)

.子程序 下载, 空白型, , 
.局部变量 列表, 字节集, , , 
.局部变量 数据库, 文本型, , , 
.局部变量 数据, 字节集, , , 
.局部变量 本地版本, 小数型, , , 
.局部变量 本地版本路径, 文本型, , , 
.局部变量 ftp版本, 小数型, , , 
.局部变量 检验, 文本型, , , 
.局部变量 列表文件名, 文本型, , , 

1.置文本 (“正在下载更新列表......”)
赋值 (列表, 未知支持库函数_7 (更新列表地址))
写到文件 (相加 (未知支持库函数_7 (11), “\update.edb”), 列表)
赋值 (数据库, 相加 (未知支持库函数_7 (11), “\update.edb”))
.如果真 (等于 (打开 (数据库, , , , , , ), 假)) ' 看看能不能打开这个数据库，如果打不开证明没有下载
    赋值 (.图片, #图片2) ' 让地球转起来，图片在资源表中
    信息框 (相加 (“无法打开更新列表！”, #换行符, #换行符, “产生此错误的原因：                    ”, #换行符, “1.可能是您没有连接到网络”, #换行符, “2.更新列表已损坏或不存在”), 16, “错误”)
    销毁 ()
    返回 ()
.如果真结束
到首记录 ()
赋值 (本地版本, 到数值 (删全部空 (取字节集数据 (读入文件 (相加 (取运行目录 (), “\”, 读 (5))), #文本型))))
 ' 读取列表中设置的本地版本文件中的版本信息，没有试过能不能直接转换为数值
赋值 (本地版本路径, 相加 (取运行目录 (), “\”, 读 (5)))
赋值 (ftp版本, 读 (4))
.如果真 (小于或等于 (ftp版本, 本地版本))
    赋值 (.图片, #图片1) ' 让地球转起来，图片在资源表中
    信息框 (“当前没有比您的程序更新的版本!”, 48, )
    全部关闭 ()
    未知支持库函数_2 (许可证1)
    未知支持库函数_2 (许可证2)
    结束 ()
    返回 ()
.如果真结束
1.置文本 (相加 (“共找到”, 到文本 (取记录数 ()), “个需要更新的组件”))
延时 (680) ' 延时是为了让用户看到一共有多少个组件需要更新
到首记录 ()
赋值 (.位置, 2)
.判断循环首 (等于 (尾记录后 (), 假))
    1.置文本 (相加 (“正在下载 ”, 读 (2), “ ......”))
    
    赋值 (列表文件名, 子文本替换 (读 (2), “/”, “\”, , , 真))
    .如果真 (不等于 (寻找文本 (列表文件名, “\”, , 真), -1))
        创建目录 (相加 (取运行目录 (), “\”, 取文本左边 (读 (2), 相减 (寻找文本 (列表文件名, “\”, , 真), 1))))
        信息框 (取运行目录 () ＋ “\” ＋ 取文本左边 (读 (2), 寻找文本 (列表文件名, “\”, , 真) － 1), 0, )
    .如果真结束
    
    赋值 (数据, 未知支持库函数_7 (读 (1)))
    写到文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”), 数据) ' 先保存到临时目录，避免下载一半后不能下载，程序就不能用了
    赋值 (.位置, 相加 (.位置, 相除 (100, 取记录数 ()))) ' 简单的设置进度条，虽然不好看。（因为我不会复杂的）
    跳过 ()
.判断循环尾 ()
到首记录 ()
赋值 (列表文件名, 读 (2))
.判断循环首 (等于 (尾记录后 (), 假))
    赋值 (检验, 取字节集数据 (读入文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”)), #文本型))
    .如果真 (等于 (寻找文本 (检验, “找不到文件<br>”, , 真), -1))
        
        赋值 (列表文件名, 子文本替换 (读 (2), “/”, “\”, , , 真))
        信息框 (取运行目录 () ＋ “\” ＋ 列表文件名 ＋ “.jsp” ＋ “!!!!!!” ＋ 取运行目录 () ＋ “\” ＋ 列表文件名, 0, )
        .如果真 (等于 (复制文件 (相加 (取运行目录 (), “\”, 列表文件名, “.jsp”), 相加 (取运行目录 (), “\”, 列表文件名)), 真)) ' 用下载的文件覆盖本地文件
            
            赋值 (.标题, 相加 (.标题, 选择 (等于 (寻找文本 (列表文件名, “\”, , 真), -1), 相加 (取运行目录 (), “\”), 相加 (取运行目录 (), “\”, 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真)))), #换行符))
            
            .如果真 (等于 (到小写 (取文本右边 (相加 (取运行目录 (), “\”, 列表文件名), 4)), “.zip”))
                信息框 (选择 (寻找文本 (列表文件名, “\”, , 真) ＝ -1, 取运行目录 () ＋ “\”, 取运行目录 () ＋ “\” ＋ 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真))), 0, )
                
                
                .如果真 (等于 (相加 (取运行目录 (), “\”, 列表文件名).未知支持库函数_2 (选择 (等于 (寻找文本 (列表文件名, “\”, , 真), -1), 相加 (取运行目录 (), “\”), 相加 (取运行目录 (), “\”, 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真))))), 1)) ' 这里是解压缩ZIP文件.
                    赋值 (展开ZIP文件数, 相加 (展开ZIP文件数, 1))
                    信息框 (取运行目录 () ＋ “\” ＋ 列表文件名, 0, )
                    删除文件 (相加 (取运行目录 (), “\”, 列表文件名))
                .如果真结束
                
            .如果真结束
            
            .如果真 (并且 (等于 (读 (3), 真), 等于 (到大写 (取文本右边 (相加 (取运行目录 (), “\”, 列表文件名), 4)), “.EXE”))) ' 数据库标记3为是否是自动运行的.EXE文件,如果是的就自动运行!
                信息框 (取运行目录 () ＋ “\” ＋ 列表文件名, 0, )
                运行 (取运行目录 () ＋ “\” ＋ 列表文件名, 假, )
                .如果真 (运行 (相加 (取运行目录 (), “\”, 列表文件名), 假, )) ' 这里是自动运行EXE安装升级包
                    赋值 (自动EXE安装文件数, 相加 (自动EXE安装文件数, 1))
                    删除文件 (取运行目录 () ＋ “\” ＋ 列表文件名)
                .如果真结束
                
            .如果真结束
            
            
            赋值 (文件, 相加 (文件, 1))
        .如果真结束
        
    .如果真结束
    1.置文本 (相加 (“正在更新文件 ”, 读 (2)))
    跳过 ()
.判断循环尾 ()
赋值 (文件2, 取记录数 ())
.如果真 (不等于 (文件, 取记录数 ()))
    赋值 (文件1, 相减 (取记录数 (), 文件))
    信息框 (相加 (“共有”, 到文本 (文件1), “个文件没有更新成功！”), 16, “错误”)
.如果真结束
到首记录 ()
.判断循环首 (等于 (尾记录后 (), 假))
    1.置文本 (相加 (“正在删除临时文件 ”, 读 (2)))
    删除文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”)) ' 删除临时目录中的文件
    跳过 ()
.判断循环尾 ()
全部关闭 ()
赋值 (.现行子夹, 2)
赋值 (.图片, #图片1)
删除文件 (数据库)
赋值 (.标题, 相加 (“    恭喜您！程序更新已经成功结束，感谢您对我们的支持！”, #换行符, #换行符, “点击”, #左引号, “完成”, #右引号, “退出本更新程序。”))
赋值 (.标题, 相加 (.标题, #换行符, #换行符, #换行符, “        统计结果：”, #换行符, #换行符, “        共下载组件数：”, 到文本 (文件2), #换行符, “        更新组件数：”, 到文本 (文件), #换行符, “        未更新组件数：”, 到文本 (文件1), #换行符, “        展开ZIP文件数：”, 到文本 (展开ZIP文件数), #换行符, “        自动EXE安装文件数：”, 到文本 (自动EXE安装文件数)))
赋值 (是否已更新, 真)

写到文件 (本地版本路径, 到字节集 (到文本 (ftp版本))) ' 更新本地的版本，方便下一次直接使用
处理事件 ()
.如果真 (等于 (.选中, 真))
    未知支持库函数_8 (1, )
.如果真结束
未知支持库函数_3 (许可证1)
未知支持库函数_4 (许可证1)
连续赋值 (0, 文件, 文件1, 文件2)

.子程序 _按钮_退出_被单击, 空白型, , 
.如果真 (等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    销毁 ()
.如果真结束


.子程序 _按钮_下一步_被单击, 空白型, , 
.局部变量 判断, 逻辑型, , , 

赋值 (.图片, #图片2)
.如果 (等于 (是否搜寻正在运行的程序, 假))
    
.否则
    赋值 (窗口句柄, 查找窗口 (0, 0, 0, 0))
    .判断循环首 (不等于 (窗口句柄, 0))
        赋值 (文本字, 取空白文本 (255))
        给出窗口标题 (窗口句柄, 文本字, 255)
        .如果真 (不等于 (寻找文本 (文本字, 要搜寻的程序标题, , 假), -1))
            跳出循环 ()
        .如果真结束
        赋值 (窗口句柄, 查找窗口 (0, 窗口句柄, 0, 0))
    .判断循环尾 ()
    赋值 (判断, 选择 (等于 (窗口句柄, 0), 真, 假)) ' 判断是不是找到了符合查找内容的窗口
    .如果真 (等于 (判断, 假))
        .如果真 (不等于 (信息框 (相加 (“系统检查到现在 ”, 要搜寻的程序标题, “ 正在运行,您现在想将该程序关闭吗？如果不关闭该程序，更新将无法进行！”), 36, ), 5))
            销毁 ()
            返回 ()
        .如果真结束
        投递消息 (窗口句柄, 16, 0, 0) ' 关闭这个窗口
    .如果真结束
    
.如果结束
赋值 (.标题, 相加 (“连接更新服务器”, #换行符, “    程序正在下载需要更新的组件到您的计算机上”))
赋值 (.现行子夹, 1)
赋值 (.时钟周期, 1000)

.子程序 _窗口升级_可否被关闭, 逻辑型, , 
.如果真 (不等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    返回 (假)
.如果真结束


.子程序 _窗口升级_将被销毁, 空白型, , 
未知支持库函数_2 (许可证1)
未知支持库函数_2 (许可证2)

.子程序 _按钮_又退出_被单击, 空白型, , 
未知支持库函数_0 (&中途退出)

.子程序 中途退出, 空白型, , 
未知支持库函数_3 (许可证2)
未知支持库函数_4 (许可证2)
.如果真 (等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    销毁 ()
.如果真结束


.窗口程序集 列表制作程序集, , , 

.子程序 _窗口列表_创建完毕, 空白型, , 
.局部变量 数据库, 字段信息, , "5", 

赋值 (.禁止, 真)
赋值 (.禁止, 真)

赋值 (数据库 [1].名称, “ftp”)
赋值 (数据库 [1].类型, #文本型)
赋值 (数据库 [1].最大文本长度, 512)
赋值 (数据库 [2].名称, “本地”)
赋值 (数据库 [2].类型, #文本型)
赋值 (数据库 [2].最大文本长度, 512)
赋值 (数据库 [3].类型, #逻辑型)
赋值 (数据库 [3].名称, “自动运行”)
赋值 (数据库 [4].类型, #小数型)
赋值 (数据库 [4].名称, “版本”)
赋值 (数据库 [5].类型, #文本型)
赋值 (数据库 [5].名称, “本地版本路径”)
赋值 (数据库 [5].最大文本长度, 512)

创建 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), 数据库) ' 创建一个新的空数据库

.子程序 _按钮添加_被单击, 空白型, , 
.如果真 (或者 (等于 (删首尾空 (.内容), “”), 等于 (删首尾空 (.内容), “”)))
    返回 ()
.如果真结束
全部关闭 ()
打开 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), , , , , , )
加记录 (.内容, .内容, 选择 (等于 (到大写 (取文本右边 (.内容, 4)), “.EXE”), .选中, 假))
.如果真 (等于 (.选中, 假))
    赋值 (.内容, “”)
    赋值 (.内容, “http://”)
.如果真结束
填充列表 () ' 调用填充列表框子程序
全部关闭 ()
返回 ()

.子程序 填充列表, 空白型, , 填充列表框
清空 ()
到首记录 ()
.判断循环首 (等于 (尾记录后 (), 假))
    读 (2).加入项目 ()
    跳过 ()
.判断循环尾 ()

.子程序 _按钮删除_被单击, 空白型, , 
.如果真 (等于 (.现行选中项, -1))
    返回 ()
.如果真结束
打开 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), , , , , , )
跳到 (相加 (.现行选中项, 1))
删除 ()
彻底删除 ()
填充列表 ()
全部关闭 ()

.子程序 _按钮保存列表_被单击, 空白型, , 
.局部变量 文件集, 字节集, , , 

打开 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), , , , , , )
到首记录 ()
.如果真 (等于 (取记录数 (), 0))
    信息框 (“未添加任何数据！”, 48, )
    返回 ()
.如果真结束
修改 (到数值 (.内容), .内容)
全部关闭 ()
赋值 (.初始目录, 取运行目录 ())
.如果真 (打开 ())
    赋值 (文件集, 读入文件 (相加 (未知支持库函数_7 (11), “\uptemp.edb”))) ' 把添加好数据的数据库读入程序
    .如果 (写到文件 (.文件名, 文件集)) ' 把读入的数据库写到指定目录中
        信息框 (“保存EDB文件成功,请将此文件连同列表中的升级包文件.上传到网站上.”, #信息图标, )
        打开 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), , , , , , )
        编辑 ()
        全部关闭 ()
        
    .否则
        信息框 (“写出文件失败,请与作者联系!”, #错误图标, )
    .如果结束
    销毁 ()
.如果真结束


.子程序 _窗口列表_将被销毁, 空白型, , 
全部关闭 ()
删除文件 (相加 (未知支持库函数_7 (11), “\uptemp.edb”))

.子程序 _按钮下一步_被单击, 空白型, , 
赋值 (.现行子夹, 1)
赋值 (.禁止, 假)
赋值 (.禁止, 真)
赋值 (.禁止, 假)

.子程序 _按钮上一步_被单击, 空白型, , 
赋值 (.现行子夹, 0)
赋值 (.禁止, 真)
赋值 (.禁止, 真)
赋值 (.禁止, 假)

.子程序 _按钮导入_被单击, 空白型, , 
赋值 (.初始目录, 取运行目录 ())
.如果真 (打开 ())
    全部关闭 ()
    打开 (.文件名, , , , , , )
    打开 (相加 (未知支持库函数_7 (11), “\uptemp.edb”), , , , , , )
    添加 (.文件名, , )
    填充列表 ()
    全部关闭 ()
.如果真结束


.子程序 _按钮下一步1_被单击, 空白型, , 
信息框 (相加 (“这是一个关于如何从网上自动下载升级您的程序的软件!”, #换行符, “本程序使用UPDATE.EDB文件,这是一个升级的列表,将网上的地址与下载后安放文件的地址一一列出,以方便升级”, #换行符, “首先您要将网上的更新文件URL地址与下载后的相对路径填写,增加到列表中,”, #换行符, “然后将版本号及旧版本号标记文件相对路径填写.”, #换行符, “最后形成UPDATE.EDB列表文件”, #换行符, “完成以上后,就可以将这个列表文件与要更新的文件放到网上了,使用升级程序就可以正常升级.”, #换行符, “最后要说的就是,还提供了自动解压缩ZIP文件及自动安装EXE的功能,大家可以试用一下.”), 0, )

.子程序 _编辑框本地路径_字符输入, 整数型, , 
.参数 字符代码, 整数型, , 

.如果真 (等于 (字符代码, 取代码 (“/”, )))
    返回 (取代码 (“\”, ))
.如果真结束


.子程序 _编辑框URL_字符输入, 整数型, , 
.参数 字符代码, 整数型, , 

.如果真 (等于 (字符代码, 取代码 (“\”, )))
    返回 (取代码 (“/”, ))
.如果真结束


.子程序 _按钮导入1_被单击, 空白型, , 
赋值 (.初始目录, 取运行目录 ())
.如果真 (打开 ())
    打开 (.文件名, , , , , , )
    编辑 ()
    全部关闭 ()
.如果真结束


.窗口程序集 最小化升级程序集, , , 

.程序集变量 窗口标题文本, 文本型, , , 
.程序集变量 软件标题, 文本型, , , 
.程序集变量 自定义欢迎文本, 文本型, , , 
.程序集变量 更新列表地址, 文本型, , , 
.程序集变量 是否搜寻正在运行的程序, 逻辑型, , , 
.程序集变量 要搜寻的程序标题, 文本型, , , 
.程序集变量 窗口句柄, 整数型, , , 
.程序集变量 文件2, 整数型, , , 
.程序集变量 文件1, 整数型, , , 
.程序集变量 文件, 整数型, , , 
.程序集变量 是否已更新, 逻辑型, , , 
.程序集变量 许可证1, 整数型, , , 
.程序集变量 许可证2, 整数型, , , 
.程序集变量 自动安装EXE文件名, 文本型, , , 
.程序集变量 展开ZIP文件数, 整数型, , , 
.程序集变量 自动EXE安装文件数, 整数型, , , 
.程序集变量 匿名程序集变量_623, 空白型, , , 
.程序集变量 列表, 字节集, , , 
.程序集变量 数据库, 文本型, , , 
.程序集变量 数据, 字节集, , , 
.程序集变量 本地版本, 小数型, , , 
.程序集变量 本地版本路径, 文本型, , , 
.程序集变量 ftp版本, 小数型, , , 
.程序集变量 检验, 文本型, , , 
.程序集变量 匿名程序集变量_624, 空白型, , , 
.子程序 _最小化升级_创建完毕, 空白型, , 
赋值 (最小化升级., 0)
最小化升级.移动 (1, 1)
赋值 (最小化升级., 假)
赋值 (展开ZIP文件数, 0)
赋值 (自动EXE安装文件数, 0)
赋值 (许可证1, 未知支持库函数_1 ())
赋值 (许可证2, 未知支持库函数_1 ())
赋值 (是否已更新, 假)
.如果真 (等于 (打开 (相加 (未知支持库函数_7 (11), “\update.edb”), , , , , , ), 假)) ' 打开在“接口程序集”中创建的数据库
    信息框 (“创建数据失败！”, 16, )
    返回 ()
.如果真结束
赋值 (软件标题, 读 (1))
赋值 (更新列表地址, 读 (2))
赋值 (自定义欢迎文本, 读 (3))
赋值 (是否搜寻正在运行的程序, 读 (4))
赋值 (要搜寻的程序标题, 读 (5))
全部关闭 ()
删除文件 (相加 (未知支持库函数_7 (11), “\update.edb”)) ' 删除这个数据库，没用了
_按钮1_被单击 ()

.子程序 _时钟1_周期事件, 空白型, , 
赋值 (.时钟周期, 0)
未知支持库函数_0 (&隐式下载)

.子程序 隐式下载, 空白型, , 
赋值 (列表, 未知支持库函数_7 (更新列表地址))
写到文件 (相加 (未知支持库函数_7 (11), “\update.edb”), 列表)
赋值 (数据库, 相加 (未知支持库函数_7 (11), “\update.edb”))
.如果真 (等于 (打开 (数据库, , , , , , ), 假)) ' 看看能不能打开这个数据库，如果打不开证明没有下载
    信息框 (相加 (“无法打开更新列表！”, #换行符, #换行符, “产生此错误的原因：                    ”, #换行符, “1.可能是您没有连接到网络”, #换行符, “2.更新列表已损坏或不存在”), 16, “错误”)
    销毁 ()
    返回 ()
.如果真结束
到首记录 ()
赋值 (本地版本, 到数值 (删全部空 (取字节集数据 (读入文件 (相加 (取运行目录 (), “\”, 读 (5))), #文本型))))
 ' 读取列表中设置的本地版本文件中的版本信息，没有试过能不能直接转换为数值
赋值 (本地版本路径, 相加 (取运行目录 (), “\”, 读 (5)))
赋值 (ftp版本, 读 (4))
.如果 (小于或等于 (ftp版本, 本地版本))
    未知支持库函数_2 (许可证1)
    未知支持库函数_2 (许可证2)
    全部关闭 ()
    结束 ()
    返回 ()
.否则
    赋值 (最小化升级., 真)
    赋值 (最小化升级., 4)
    最小化升级.移动 (400, 123)
    赋值 (最小化升级., 1)
    赋值 (.标题, “注意:发现网上有新的升级版本,您现在是否需要更新?”)
.如果结束



.子程序 _按钮_下次再说_被单击, 空白型, , 
.如果真 (等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    销毁 ()
.如果真结束


.子程序 _按钮1_被单击, 空白型, , 
.局部变量 判断, 逻辑型, , , 

.如果 (等于 (是否搜寻正在运行的程序, 假))
    
.否则
    赋值 (窗口句柄, 查找窗口 (0, 0, 0, 0))
    .判断循环首 (不等于 (窗口句柄, 0))
        赋值 (窗口标题文本, 取空白文本 (255))
        给出窗口标题 (窗口句柄, 窗口标题文本, 255)
        .如果真 (不等于 (寻找文本 (窗口标题文本, 要搜寻的程序标题, , 假), -1))
            跳出循环 ()
        .如果真结束
        赋值 (窗口句柄, 查找窗口 (0, 窗口句柄, 0, 0))
    .判断循环尾 ()
    赋值 (判断, 选择 (等于 (窗口句柄, 0), 真, 假)) ' 判断是不是找到了符合查找内容的窗口
    .如果真 (等于 (判断, 假))
        .如果真 (不等于 (信息框 (相加 (“系统检查到现在 ”, 要搜寻的程序标题, “ 正在运行,您现在想将该程序关闭吗？如果不关闭该程序，更新将无法进行！”), 36, ), 5))
            销毁 ()
            返回 ()
        .如果真结束
        投递消息 (窗口句柄, 16, 0, 0) ' 关闭这个窗口
    .如果真结束
    
.如果结束
赋值 (.标题, “连接更新服务器,程序正在检查网上是否有最新版本!”)
赋值 (.时钟周期, 1000)

.子程序 _窗口升级_可否被关闭, 逻辑型, , 
.如果真 (不等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    返回 (假)
.如果真结束


.子程序 _窗口升级_将被销毁, 空白型, , 
未知支持库函数_2 (许可证1)
未知支持库函数_2 (许可证2)

.子程序 _按钮_不再提醒_被单击, 空白型, , 
未知支持库函数_0 (&中途退出)

.子程序 中途退出, 空白型, , 
未知支持库函数_3 (许可证2)
未知支持库函数_4 (许可证2)
.如果真 (等于 (信息框 (“你确实要退出更新此更新程序吗？程序将无法进行更新！”, 292, “更新”), 5))
    销毁 ()
.如果真结束


.子程序 _按钮立即升级_被单击, 空白型, , 
.局部变量 列表文件名, 文本型, , , 

.如果真 (等于 (.标题, “完成”))
    销毁 ()
    返回 ()
.如果真结束

赋值 (.可视, 真)
赋值 (.标题, “正在更新中,请稍候......”)
延时 (680) ' 延时是为了让用户看到一共有多少个组件需要更新
赋值 (.标题, 相加 (“共找到”, 到文本 (取记录数 ()), “个需要更新的组件”))
延时 (680) ' 延时是为了让用户看到一共有多少个组件需要更新
到首记录 ()
赋值 (.位置, 2)
.判断循环首 (等于 (尾记录后 (), 假))
    赋值 (.标题, 相加 (“正在下载 ”, 读 (2), “ ......”))
    
    赋值 (列表文件名, 子文本替换 (读 (2), “/”, “\”, , , 真))
    .如果真 (不等于 (寻找文本 (列表文件名, “\”, , 真), -1))
        创建目录 (相加 (取运行目录 (), “\”, 取文本左边 (读 (2), 相减 (寻找文本 (列表文件名, “\”, , 真), 1))))
        信息框 (取运行目录 () ＋ “\” ＋ 取文本左边 (读 (2), 寻找文本 (列表文件名, “\”, , 真) － 1), 0, )
    .如果真结束
    
    赋值 (数据, 未知支持库函数_7 (读 (1)))
    写到文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”), 数据) ' 先保存到临时目录，避免下载一半后不能下载，程序就不能用了
    赋值 (.位置, 相加 (.位置, 相除 (100, 取记录数 ()))) ' !!!!!!!!!!!!!!!简单的设置进度条，虽然不好看。（因为我不会复杂的）!!!!!!!!!!!!!!!!!!!!
    赋值 (.标题, 相加 (“更新文件”, 到文本 (相加 (取运行目录 (), “\”, 读 (2)))))
    
    跳过 ()
.判断循环尾 ()
到首记录 ()
赋值 (列表文件名, 读 (2))
.判断循环首 (等于 (尾记录后 (), 假))
    赋值 (检验, 取字节集数据 (读入文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”)), #文本型))
    .如果真 (等于 (寻找文本 (检验, “找不到文件<br>”, , 真), -1))
        
        赋值 (列表文件名, 子文本替换 (读 (2), “/”, “\”, , , 真))
        信息框 (取运行目录 () ＋ “\” ＋ 列表文件名 ＋ “.jsp” ＋ “!!!!!!” ＋ 取运行目录 () ＋ “\” ＋ 列表文件名, 0, )
        .如果真 (等于 (复制文件 (相加 (取运行目录 (), “\”, 列表文件名, “.jsp”), 相加 (取运行目录 (), “\”, 列表文件名)), 真)) ' 用下载的文件覆盖本地文件
            
            标签9.标题 ＝ 标签9.标题 ＋ 选择 (寻找文本 (列表文件名, “\”, , 真) ＝ -1, 取运行目录 () ＋ “\”, 取运行目录 () ＋ “\” ＋ 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真))) ＋ #换行符
            
            .如果真 (等于 (到小写 (取文本右边 (相加 (取运行目录 (), “\”, 列表文件名), 4)), “.zip”))
                信息框 (选择 (寻找文本 (列表文件名, “\”, , 真) ＝ -1, 取运行目录 () ＋ “\”, 取运行目录 () ＋ “\” ＋ 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真))), 0, )
                
                
                .如果真 (等于 (相加 (取运行目录 (), “\”, 列表文件名).未知支持库函数_2 (选择 (等于 (寻找文本 (列表文件名, “\”, , 真), -1), 相加 (取运行目录 (), “\”), 相加 (取运行目录 (), “\”, 取文本左边 (列表文件名, 寻找文本 (列表文件名, “\”, , 真))))), 1)) ' 这里是解压缩ZIP文件.
                    赋值 (展开ZIP文件数, 相加 (展开ZIP文件数, 1))
                    信息框 (取运行目录 () ＋ “\” ＋ 列表文件名, 0, )
                    删除文件 (相加 (取运行目录 (), “\”, 列表文件名))
                .如果真结束
                
            .如果真结束
            
            .如果真 (并且 (等于 (读 (3), 真), 等于 (到大写 (取文本右边 (相加 (取运行目录 (), “\”, 列表文件名), 4)), “.EXE”))) ' 数据库标记3为是否是自动运行的.EXE文件,如果是的就自动运行!
                .如果真 (运行 (相加 (取运行目录 (), “\”, 列表文件名), 真, )) ' 这里是自动运行EXE安装升级包
                    赋值 (自动EXE安装文件数, 相加 (自动EXE安装文件数, 1))
                    删除文件 (相加 (取运行目录 (), “\”, 列表文件名))
                .如果真结束
                
            .如果真结束
            
            
            赋值 (文件, 相加 (文件, 1))
        .如果真结束
        
    .如果真结束
    赋值 (.标题, 相加 (“正在更新文件 ”, 读 (2)))
    跳过 ()
.判断循环尾 ()
赋值 (文件2, 取记录数 ())
.如果真 (不等于 (文件, 取记录数 ()))
    赋值 (文件1, 相减 (取记录数 (), 文件))
    信息框 (相加 (“共有”, 到文本 (文件1), “个文件没有更新成功！”), 16, “错误”)
.如果真结束
到首记录 ()
.判断循环首 (等于 (尾记录后 (), 假))
    赋值 (.标题, 相加 (“正在删除临时文件 ”, 读 (2)))
    删除文件 (相加 (取运行目录 (), “\”, 读 (2), “.jsp”)) ' 删除临时目录中的文件
    跳过 ()
.判断循环尾 ()
全部关闭 ()
删除文件 (数据库)

标签7.标题 ＝ 标签7.标题 ＋ #换行符 ＋ #换行符 ＋ #换行符 ＋ “        统计结果：” ＋ #换行符 ＋ #换行符 ＋ “        共下载组件数：” ＋ 到文本 (文件2) ＋ #换行符 ＋ “        更新组件数：” ＋ 到文本 (文件) ＋ #换行符 ＋ “        未更新组件数：” ＋ 到文本 (文件1) ＋ #换行符 ＋ “        展开ZIP文件数：” ＋ 到文本 (展开ZIP文件数) ＋ #换行符 ＋ “        自动EXE安装文件数：” ＋ 到文本 (自动EXE安装文件数)
赋值 (是否已更新, 真)

写到文件 (本地版本路径, 到字节集 (到文本 (ftp版本))) ' 更新本地的版本，方便下一次直接使用
处理事件 ()
未知支持库函数_3 (许可证1)
未知支持库函数_4 (许可证1)
连续赋值 (0, 文件, 文件1, 文件2)




赋值 (.标题, 相加 (“恭喜您！程序更新成功，感谢您对我们的支持！”, #换行符, #换行符, “点击”, #左引号, “完成”, #右引号, “退出。”))
160.移动 (62, 80, 24)
赋值 (.可视, 假)
赋值 (.可视, 假)
赋值 (.标题, “完成”)

.窗口程序集 调用演示窗口程序集, , , 

.子程序 _按钮_隐藏窗口升级_被单击, 空白型, , 
更新 (.内容, .内容, , , , 真, , 到数值 (.内容))


.子程序 更新, 空白型, 公开, 提供一个升级窗口，可自定义欢迎文本。
.参数 软件名称, 文本型, , 软件的名称，必须的
.参数 更新列表地址, 文本型, , 在服务器上的更新列表路径，例如：HTTP://www.66608.com/update.edb，请使用"生成列表"来创建列表数据库
.参数 自定义欢迎文本, 文本型, 可空, 在更新启动时显示的欢迎语句，如果不填写则使用默认。
.参数 是否搜寻正在运行的程序, 逻辑型, 可空, 如果要更新的文件正在运行的话，将不会更新成功，所以在运行时会搜寻指定标题的窗口，如果为假则不搜寻窗口。
.参数 要搜寻的程序标题, 文本型, 可空, 要搜寻的标题（如果“是否搜寻正在运行的程序”为假的话，此参数无效）
.参数 是否最小化升级窗口, 逻辑型, 可空, 如果为空,即为非最小化检查,而是弹出一个标准大窗口输入后检查.如果自动检查,检查到有新版本了,会弹出是否要升级的窗口.
.参数 要关闭的窗口句柄, 文本型, 可空, 如果空,即为没有可自动关闭的窗口.
.参数 是否需要XP化按钮, 整数型, 可空, 如果为0,即为非XP按钮,0.#无风格;  1.#蓝色风格;  2.#绿色风格;  3.#银色风格

.局部变量 数据库, 字段信息, , "5", 

未知支持库函数_0 (是否需要XP化按钮)
赋值 (数据库 [1].名称, “name”)
赋值 (数据库 [1].类型, #文本型)
赋值 (数据库 [1].最大文本长度, 100)
赋值 (数据库 [2].名称, “url”)
赋值 (数据库 [2].类型, #文本型)
赋值 (数据库 [2].最大文本长度, 200)
赋值 (数据库 [3].类型, #文本型)
赋值 (数据库 [3].名称, “weiltext”)
赋值 (数据库 [3].最大文本长度, 500)
赋值 (数据库 [4].名称, “get”)
赋值 (数据库 [4].类型, #逻辑型)
赋值 (数据库 [5].名称, “ti”)
赋值 (数据库 [5].类型, #文本型)
赋值 (数据库 [5].最大文本长度, 300)
创建 (相加 (未知支持库函数_7 (11), “\update.edb”), 数据库)
打开 (相加 (未知支持库函数_7 (11), “\update.edb”), , , , , , )
加记录 (软件名称, 更新列表地址, 自定义欢迎文本, 是否搜寻正在运行的程序, 要搜寻的程序标题)
全部关闭 ()

.如果真 (并且 (不等于 (删首尾空 (要关闭的窗口句柄), “”), 大于 (IsWindow (到数值 (要关闭的窗口句柄)), 0)))
    SendMessage (到数值 (要关闭的窗口句柄), 16, 0, 0) ' 如果要关闭某个窗口,可以现在关闭
.如果真结束


.如果 (等于 (是否最小化升级窗口, 真))
    载入 (最小化升级, , 真)
    返回 ()
.否则
    载入 (窗口升级, , 真)
    返回 ()
.如果结束


.子程序 _按钮_创建列表_被单击, 空白型, , 
生成列表 ()


.子程序 生成列表, 空白型, 公开, 用来生成更新所用的列表数据库
载入 (窗口列表, , 真)

.子程序 _按钮_显窗口升级_被单击, 空白型, , 
更新 (.内容, .内容, , , , , , 到数值 (.内容))

.子程序 _编辑框_按钮风格_内容被改变, 空白型, , 
未知支持库函数_0 (到数值 (.内容))

.子程序 _按钮_说明_被单击, 空白型, , 
 ' 信息框 (相加 (“这是一个关于如何从网上自动下载升级您的程序的软件!”, #换行符, “本程序使用UPDATE.EDB文件,这是一个升级的列表,将网上的地址与下载后安放文件的地址一一列出,以方便升级”, #换行符, “首先您要将网上的更新文件URL地址与下载后的相对路径填写,增加到列表中,”, #换行符, “然后将版本号及旧版本号标记文件相对路径填写.”, #换行符, “最后形成UPDATE.EDB列表文件”, #换行符, “完成以上后,就可以将这个列表文件与要更新的文件放到网上了,使用升级程序就可以正常升级.”, #换行符, “最后要说的就是,还提供了自动解压缩ZIP文件及自动安装EXE的功能,大家可以试用一下.”, #换行符, “使用技巧:将升级按钮以菜单形式制作在主程序中,可以在调用升级程序后将主程序关闭,以利于主程序的升级.可将XP风格直接加入到升级模块中,可以在每次程序运行时,自动用隐藏的升级窗口升级您的程序.更多的技巧与改进大家自己想吧.”), 0, )

.子程序 _按钮_退出_被单击, 空白型, , 
结束 ()


 ' 不属于任何一个程序集、类模块的函数：
